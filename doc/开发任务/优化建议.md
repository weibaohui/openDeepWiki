# openDeepWiki 优化建议清单

> 说明：本清单基于当前仓库（backend + frontend）现状，从安全性、稳定性、性能、可维护性与体验维度提出可落地的优化项。  
> 状态列用于后续跟踪：未开始 / 进行中 / 已完成。

| 编号 | 模块 | 优化建议 | 价值/风险 | 优先级 | 状态 | 备注/验收标准 |
|---:|---|---|---|:---:|:---:|---|
| 1 | 后端-安全 | 为所有写接口增加鉴权（至少 /api/config、/repositories、/tasks、/documents） | 避免任何人直接改配置、触发分析、导出数据 | P0 | 未开始 | 支持固定管理口令或 API Key；未授权返回 401/403 |
| 2 | 后端-安全 | 修正 CORS 策略：禁止 AllowOrigins=* 且 AllowCredentials=true 的组合 | 规避跨站凭证风险与浏览器兼容问题 | P0 | 未开始 | 仅允许配置白名单 Origin；必要时关闭 AllowCredentials |
| 3 | 后端-安全 | Git clone 不通过 URL 注入 Token，改为安全传递凭证 | 防止 Token 出现在进程列表/日志/错误信息中 | P0 | 未开始 | 使用 git -c http.extraHeader 或 GIT_ASKPASS；错误信息中不包含 Token |
| 4 | 后端-安全 | 配置保存避免落盘明文密钥（或加密/权限收紧） | 降低 API Key/GitHub Token 泄漏概率 | P0 | 未开始 | 若必须落盘：权限 0600；或将密钥移到环境变量/系统 Keychain |
| 5 | 后端-配置 | /api/config 的 Get 接口不返回密钥字段（即使脱敏） | 减少“配置面板”被滥用的信息面暴露 | P1 | 未开始 | 前端改为仅显示“已设置/未设置”；修改接口不回传旧值 |
| 6 | 后端-稳定 | 所有 DB Save/Create/Update 增加错误处理与日志 | 避免状态更新失败导致任务/仓库状态错乱 | P0 | 未开始 | 关键路径检查 Error；失败时可重试或回滚并记录原因 |
| 7 | 后端-稳定 | 任务执行加入并发控制/队列（而不是无限 goroutine） | 防止多任务并发打爆 CPU/内存/LLM 配额 | P0 | 未开始 | 每仓库或全局设置 worker 数；任务排队可观测 |
| 8 | 后端-稳定 | 任务幂等与互斥：同一 taskID 同时只能运行一次 | 防止重复点击导致重复写文档/状态竞争 | P1 | 未开始 | DB 层乐观锁或 “running” 状态原子更新（WHERE status!=running） |
| 9 | 后端-稳定 | 清理卡住任务时同步修正仓库状态 | 避免仓库长期卡在 analyzing 或 error 不可恢复 | P1 | 未开始 | cleanup 后若无 running 且无 failed，可回到 ready/completed |
|10 | 后端-性能 | 静态分析结果缓存（按 repoID + commit hash），避免每个任务重复扫描 | 显著降低重复 I/O 与分析耗时 | P1 | 未开始 | 任务链路共享 ProjectInfo；缓存失效基于仓库 HEAD |
|11 | 后端-性能 | 静态扫描增加文件大小/行长度保护（bufio.Scanner buffer） | 防止遇到超长行或大文件导致扫描失败/耗尽内存 | P1 | 未开始 | 设置 scanner.Buffer；跳过超过阈值的大文件并记录统计 |
|12 | 后端-性能 | LLM 调用增加重试/退避与可配置超时 | 提升对网络抖动与限流的鲁棒性 | P1 | 未开始 | 429/5xx 退避重试；超时配置化而非写死 5min |
|13 | 后端-可观测 | 统一日志体系（避免 log + klog 混用），增加 request_id | 排障效率提升，日志可聚合检索 | P2 | 未开始 | 统一结构化字段：repoID/taskID；中间件注入 request_id |
|14 | 后端-API | 统一错误响应格式与错误码（业务错误 vs 系统错误） | 前端体验更好、接口更可维护 | P2 | 未开始 | 例如 {code,message,details}；4xx/5xx 语义明确 |
|15 | 后端-数据 | 为 Task/Repository 状态值引入常量/枚举与状态机校验 | 避免字符串散落导致状态拼写与流转不一致 | P2 | 未开始 | 状态迁移表；非法迁移直接拒绝并返回错误码 |
|16 | 后端-数据 | 增加索引与约束（repository_id+type 唯一、task 排序） | 保障数据一致性与查询性能 | P2 | 未开始 | gorm tag 或迁移；重复任务不应产生多条记录 |
|17 | 后端-数据 | 分离自动迁移与生产迁移（AutoMigrate 策略） | 降低生产环境 schema 漂移风险 | P2 | 未开始 | dev 允许 AutoMigrate；prod 使用显式迁移工具 |
|18 | 后端-工程 | 提供健康检查与就绪检查接口（/healthz /readyz） | 便于部署与监控接入 | P2 | 未开始 | 检查 DB 连通性、磁盘目录可写等 |
|19 | 后端-工程 | 为导出 Zip 写入与关闭补全错误处理 | 避免导出半成品且客户端不知失败原因 | P3 | 未开始 | 校验每次 Write 返回值；失败返回明确错误 |
|20 | 前端-体验 | 用事件推送替代轮询（SSE/WebSocket），或降低轮询频率/按需轮询 | 降低后端压力与前端无效请求 | P1 | 未开始 | 任务运行期间加密轮询，完成后停止；或 SSE 实时推送状态 |
|21 | 前端-体验 | 统一 API 错误处理（axios interceptor），替代 alert/console | 更一致的提示与可观测性 | P2 | 未开始 | 展示可读错误消息；对 401 自动跳转登录/提示 |
|22 | 前端-安全 | 配置页不展示已保存密钥的任何形式（脱敏也不展示） | 降低社工与截屏泄露风险 | P1 | 未开始 | 只显示“已设置”；保存时仅发送用户新输入 |
|23 | 前端-可维护 | 引入请求状态管理与缓存（如 React Query） | 降低重复请求与手写 loading 状态的复杂度 | P3 | 未开始 | 列表/详情/任务状态缓存与自动刷新策略统一 |
|24 | 全局-测试 | 为核心模块补齐单测/集成测试（analyzer/git/api） | 保障迭代安全，减少回归 | P2 | 未开始 | 覆盖：URL 解析、目录忽略、状态机、接口返回码 |
|25 | 全局-发布 | 增加版本信息与构建元数据输出（/version） | 便于定位线上版本与回溯问题 | P3 | 未开始 | 打包注入 git commit、build time、go version |

