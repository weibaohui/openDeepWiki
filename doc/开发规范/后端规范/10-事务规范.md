# 事务规范

本文档定义事务控制的规范。

## 核心原则

**事务只允许在 Service 层控制**：

- Repository **不允许** Begin / Commit / Rollback
- Repository 接收 `*gorm.DB`（可能是事务）

## 事务管理器

### TxManager 定义

```go
package repository

import (
    "context"

    "gorm.io/gorm"
)

type TxManager interface {
    WithTx(ctx context.Context, fn func(tx *gorm.DB) error) error
}

type txManager struct {
    db *gorm.DB
}

func NewTxManager(db *gorm.DB) TxManager {
    return &txManager{db: db}
}

func (m *txManager) WithTx(ctx context.Context, fn func(tx *gorm.DB) error) error {
    return m.db.WithContext(ctx).Transaction(fn)
}
```

### 在 Service 中使用

```go
package service

type userService struct {
    txManager TxManager
    userRepo  UserRepository
    roleRepo  RoleRepository
}

func (s *userService) CreateWithRoles(ctx context.Context, req CreateUserRequest) (*UserDTO, error) {
    var result *domain.User

    err := s.txManager.WithTx(ctx, func(tx *gorm.DB) error {
        // 创建用户
        user := &domain.User{
            ID:    generateID(),
            Email: req.Email,
        }
        if err := s.userRepo.CreateWithTx(tx, user); err != nil {
            return err
        }

        // 分配角色
        for _, roleID := range req.RoleIDs {
            if err := s.roleRepo.AssignUserWithTx(tx, user.ID, roleID); err != nil {
                return err
            }
        }

        result = user
        return nil
    })

    if err != nil {
        return nil, err
    }

    return toUserDTO(result), nil
}
```

## Repository 事务支持

```go
package repository

type UserRepository interface {
    Create(ctx context.Context, user *domain.User) error
    CreateWithTx(tx *gorm.DB, user *domain.User) error  // 支持事务
}

type userRepository struct {
    db *gorm.DB
}

// 普通方法
func (r *userRepository) Create(ctx context.Context, user *domain.User) error {
    return r.db.WithContext(ctx).Create(toModel(user)).Error
}

// 事务方法
func (r *userRepository) CreateWithTx(tx *gorm.DB, user *domain.User) error {
    return tx.Create(toModel(user)).Error
}
```

## 简化模式（可选）

对于简单场景，可以让 Repository 自动使用传入的 db：

```go
type userRepository struct {
    getDB func(ctx context.Context) *gorm.DB
}

func NewUserRepository(db *gorm.DB) UserRepository {
    return &userRepository{
        getDB: func(ctx context.Context) *gorm.DB {
            // 尝试从 context 获取事务，否则使用默认 db
            if tx, ok := ctx.Value(txKey).(*gorm.DB); ok {
                return tx
            }
            return db.WithContext(ctx)
        },
    }
}

func (r *userRepository) Create(ctx context.Context, user *domain.User) error {
    return r.getDB(ctx).Create(toModel(user)).Error
}
```

## 事务边界

```go
// Service 方法是事务边界
func (s *orderService) CreateOrder(ctx context.Context, req CreateOrderRequest) (*OrderDTO, error) {
    return s.txManager.WithTx(ctx, func(tx *gorm.DB) error {
        // 1. 检查库存
        // 2. 扣减库存
        // 3. 创建订单
        // 4. 创建订单项
        // 全部成功才提交，任一失败自动回滚
    })
}
```

## 禁止事项

```go
// ❌ Repository 中开启事务
func (r *userRepository) Create(ctx context.Context, user *domain.User) error {
    tx := r.db.Begin()  // 禁止！
    defer tx.Rollback()
    
    if err := tx.Create(toModel(user)).Error; err != nil {
        return err
    }
    
    return tx.Commit().Error
}

// ❌ Handler 中控制事务
func (h *UserHandler) Create(c *gin.Context) {
    tx := h.db.Begin()  // 禁止！
}

// ❌ 嵌套事务
func (s *userService) Method(ctx context.Context) error {
    return s.txManager.WithTx(ctx, func(tx *gorm.DB) error {
        return s.txManager.WithTx(ctx, func(tx2 *gorm.DB) error {  // 禁止！
            // ...
        })
    })
}
```

## 最佳实践

1. **最小事务范围**：事务只包含必要的数据库操作
2. **避免长事务**：事务中不要有 HTTP 调用、文件操作
3. **错误立即返回**：事务中的错误应立即 return

```go
// 正确
func (s *orderService) CreateOrder(ctx context.Context, req CreateOrderRequest) error {
    // 事务外：参数校验、外部调用
    if err := s.validateOrder(req); err != nil {
        return err
    }
    
    stock, err := s.inventoryClient.CheckStock(ctx, req.ProductID)
    if err != nil {
        return err
    }

    // 事务内：只有数据库操作
    return s.txManager.WithTx(ctx, func(tx *gorm.DB) error {
        if err := s.stockRepo.DeductWithTx(tx, req.ProductID, req.Quantity); err != nil {
            return err
        }
        return s.orderRepo.CreateWithTx(tx, order)
    })
}
```

## 相关文档

- [Service 规范](./04-Service规范.md)
- [Repository 规范](./07-Repository规范.md)
- [GORM 使用规范](./09-GORM使用规范.md)
