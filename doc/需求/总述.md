# openDeepWiki - 代码仓库智能解读平台

## 一、项目概述

### 1.1 项目背景

openDeepWiki 是一个代码仓库智能解读平台，旨在帮助开发者快速理解和学习开源项目。通过输入 GitHub 仓库地址，平台会自动克隆仓库、分析代码结构，并借助大语言模型（LLM）生成结构化的项目文档。

### 1.2 核心价值

- **降低学习门槛**：自动生成项目文档，帮助开发者快速上手新项目
- **标准化输出**：统一的文档结构和格式，便于阅读和对比
- **智能分析**：结合静态分析和 LLM，提供深度的代码解读

### 1.3 技术栈

| 层级     | 技术选型                        |
| -------- | ------------------------------- |
| 后端     | Go 1.24 + Gin 框架              |
| 前端     | React + TypeScript + Vite       |
| 数据库   | SQLite（默认）/ MySQL（可配置） |
| AI       | OpenAI 兼容接口                 |
| 开发工具 | Air（热重载）、klog（日志）     |

---

## 二、功能需求

### 2.1 仓库管理

#### 2.1.1 仓库导入
- 输入 GitHub 仓库 URL（支持 https 和 git@ 格式）
- 支持公开仓库直接克隆
- 支持私有仓库（需配置 GitHub Token）
- 克隆仓库到本地指定目录
- 记录仓库基本信息（名称、URL、克隆时间、状态等）

#### 2.1.2 仓库状态
| 状态      | 说明             |
| --------- | ---------------- |
| pending   | 等待处理         |
| cloning   | 正在克隆         |
| ready     | 克隆完成，可分析 |
| analyzing | 正在分析         |
| completed | 分析完成         |
| error     | 发生错误         |

#### 2.1.3 仓库列表
- 显示所有已导入的仓库
- 显示仓库解读状态
- 支持删除仓库（同时删除本地文件和相关数据）

### 2.2 任务管理

#### 2.2.1 任务类型（固定模板）

每个仓库的解读按以下固定模板拆分为 5 个任务：

| 任务类型      | 标题     | 生成文档         | 说明                             |
| ------------- | -------- | ---------------- | -------------------------------- |
| overview      | 项目概览 | overview.md      | 项目基本信息、技术栈、目录结构   |
| architecture  | 架构分析 | architecture.md  | 整体架构、模块划分、依赖关系     |
| api           | 核心接口 | api.md           | API 接口、函数签名、模块间调用   |
| business-flow | 业务流程 | business-flow.md | 核心业务逻辑、数据流程           |
| deployment    | 部署配置 | deployment.md    | 配置文件说明、部署方式、环境要求 |

#### 2.2.2 任务状态
| 状态      | 说明     |
| --------- | -------- |
| pending   | 待执行   |
| running   | 执行中   |
| completed | 已完成   |
| failed    | 执行失败 |

#### 2.2.3 任务执行方式
- **自动执行**：创建仓库后可自动按顺序执行所有任务
- **手动控制**：用户可暂停、重新执行单个任务
- **重试机制**：失败任务支持重新执行
- **强制重置**：支持强制重置运行中或已完成的任务

#### 2.2.4 任务超时清理
- 服务启动时自动清理超过 10 分钟的运行中任务
- 提供 API 接口手动清理卡住的任务
- 支持自定义超时时间参数

### 2.3 解读引擎

#### 2.3.1 静态分析
- 识别项目类型（Go/Java/Python/Node.js 等）
- 解析项目结构（目录、文件列表）
- 提取关键文件（README、配置文件、入口文件）
- 分析代码统计（行数、文件数、语言分布）
- 提取函数/类/接口定义

#### 2.3.2 LLM 分析
- 调用 OpenAI 兼容接口
- 支持配置 API 地址、模型、Key
- 根据任务类型构造不同 Prompt
- 将静态分析结果作为上下文传给 LLM
- 生成结构化的 Markdown 文档

### 2.4 文档管理

#### 2.4.1 文档目录
每个仓库解读后生成一个文档目录：
```
repo-name/
├── index.md          # 目录索引
├── overview.md       # 项目概览
├── architecture.md   # 架构分析
├── api.md           # 核心接口
├── business-flow.md # 业务流程
└── deployment.md    # 部署配置
```

#### 2.4.2 文档展示
- 左侧目录树导航
- 右侧 Markdown 渲染展示
- 支持文档内链接跳转
- 支持在线编辑文档

#### 2.4.3 文档导出
- 支持单个文档导出 Markdown
- 支持整体打包导出（ZIP 格式）

---

## 三、数据模型

### 3.1 仓库表 (repositories)

| 字段        | 类型     | 说明         |
| ----------- | -------- | ------------ |
| id          | uint     | 主键         |
| name        | string   | 仓库名称     |
| url         | string   | GitHub URL   |
| local_path  | string   | 本地存储路径 |
| description | string   | 仓库描述     |
| status      | string   | 状态         |
| error_msg   | string   | 错误信息     |
| created_at  | datetime | 创建时间     |
| updated_at  | datetime | 更新时间     |

### 3.2 任务表 (tasks)

| 字段          | 类型     | 说明     |
| ------------- | -------- | -------- |
| id            | uint     | 主键     |
| repository_id | uint     | 关联仓库 |
| type          | string   | 任务类型 |
| title         | string   | 任务标题 |
| status        | string   | 状态     |
| error_msg     | string   | 错误信息 |
| sort_order    | int      | 排序序号 |
| started_at    | datetime | 开始时间 |
| completed_at  | datetime | 完成时间 |
| created_at    | datetime | 创建时间 |
| updated_at    | datetime | 更新时间 |

### 3.3 文档表 (documents)

| 字段          | 类型     | 说明          |
| ------------- | -------- | ------------- |
| id            | uint     | 主键          |
| repository_id | uint     | 关联仓库      |
| task_id       | uint     | 关联任务      |
| title         | string   | 文档标题      |
| filename      | string   | 文件名        |
| content       | text     | Markdown 内容 |
| sort_order    | int      | 排序序号      |
| created_at    | datetime | 创建时间      |
| updated_at    | datetime | 更新时间      |

---

## 四、API 设计

### 4.1 仓库相关

| 方法   | 路径                          | 说明                        |
| ------ | ----------------------------- | --------------------------- |
| POST   | /api/repositories             | 创建仓库（输入 GitHub URL） |
| GET    | /api/repositories             | 获取仓库列表                |
| GET    | /api/repositories/:id         | 获取仓库详情                |
| DELETE | /api/repositories/:id         | 删除仓库                    |
| POST   | /api/repositories/:id/run-all | 执行所有任务                |

### 4.2 任务相关

| 方法 | 路径                        | 说明               |
| ---- | --------------------------- | ------------------ |
| GET  | /api/repositories/:id/tasks | 获取仓库的任务列表 |
| GET  | /api/tasks/:id              | 获取任务详情       |
| POST | /api/tasks/:id/run          | 执行单个任务       |
| POST | /api/tasks/:id/reset        | 重置任务           |
| POST | /api/tasks/:id/force-reset  | 强制重置任务       |
| GET  | /api/tasks/stuck            | 获取卡住的任务     |
| POST | /api/tasks/cleanup          | 清理卡住的任务     |

### 4.3 文档相关

| 方法 | 路径                                   | 说明               |
| ---- | -------------------------------------- | ------------------ |
| GET  | /api/repositories/:id/documents        | 获取仓库的文档目录 |
| GET  | /api/repositories/:id/documents/index  | 获取文档索引       |
| GET  | /api/repositories/:id/documents/export | 导出所有文档       |
| GET  | /api/documents/:id                     | 获取文档内容       |
| PUT  | /api/documents/:id                     | 更新文档内容       |

### 4.4 配置相关

| 方法 | 路径        | 说明     |
| ---- | ----------- | -------- |
| GET  | /api/config | 获取配置 |
| PUT  | /api/config | 更新配置 |

---

## 五、前端页面

### 5.1 页面列表

1. **首页/仓库列表页** (`/`)
   - 显示所有仓库
   - 支持添加新仓库
   - 显示仓库状态
   - 支持删除仓库

2. **仓库详情页** (`/repo/:id`)
   - 显示任务列表和进度
   - 显示文档目录
   - 支持运行/重置任务
   - 支持导出文档

3. **文档阅读页** (`/repo/:id/doc/:docId`)
   - 左侧目录导航
   - 右侧 Markdown 渲染
   - 支持在线编辑
   - 支持下载单个文档

4. **配置页** (`/config`)
   - LLM API 配置
   - GitHub Token 配置

### 5.2 交互流程

```
首页 → 输入 GitHub URL → 创建仓库 → 自动克隆
                              ↓
                        仓库详情页（查看任务进度）
                              ↓
                        运行分析任务
                              ↓
                        文档阅读页（查看结果）
```

---

## 六、配置说明

### 6.1 环境变量

LLM 配置支持从环境变量自动获取（优先级高于配置文件）：

| 环境变量          | 说明     | 对应配置    |
| ----------------- | -------- | ----------- |
| OPENAI_API_KEY    | API 密钥 | llm.api_key |
| OPENAI_BASE_URL   | API 地址 | llm.api_url |
| OPENAI_MODEL_NAME | 模型名称 | llm.model   |

### 6.2 配置文件 (config.yaml)

```yaml
server:
  port: "8080"
  mode: "debug"  # debug or release

database:
  type: "sqlite"  # sqlite or mysql
  dsn: "./data/app.db"

llm:
  api_url: "https://api.openai.com/v1"
  api_key: ""  # 推荐使用环境变量
  model: "gpt-4o"
  max_tokens: 4096

github:
  token: ""  # 用于访问私有仓库

data:
  dir: "./data"
  repo_dir: "./data/repos"
```

---

## 七、开发规范

### 7.1 日志规范

使用 klog 日志框架，任务执行相关日志使用 `V(6)` 级别：

```go
klog.V(6).Infof("开始执行任务: taskID=%d", taskID)
klog.V(6).Infof("静态分析完成: projectType=%s", projectInfo.Type)
klog.V(6).Infof("LLM 分析失败: error=%v", err)
```

### 7.2 开发工具

使用 Air 进行热重载开发，配置文件 `.air.toml` 已设置 `-v 6` 参数启用详细日志：

```bash
# 启动开发模式
make air

# 或同时启动前后端
make dev
```

---

## 八、项目结构

```
openDeepWiki/
├── backend/                    # Go 后端
│   ├── main.go                # 入口文件
│   ├── config/                # 配置管理
│   ├── models/                # 数据模型
│   ├── handlers/              # HTTP 处理器
│   ├── services/              # 业务逻辑
│   │   └── analyzer/          # 分析引擎
│   │       ├── static.go      # 静态分析
│   │       └── llm.go         # LLM 分析
│   ├── router/                # 路由配置
│   ├── pkg/                   # 工具包
│   │   ├── git/               # Git 操作
│   │   └── llm/               # LLM 客户端
│   ├── .air.toml              # Air 配置
│   └── config.yaml.example    # 配置示例
├── frontend/                   # React 前端
│   ├── src/
│   │   ├── pages/             # 页面组件
│   │   ├── services/          # API 调用
│   │   └── types/             # TypeScript 类型
│   └── package.json
├── doc/                       # 文档目录
│   └── 需求/
│       └── 总述.md            # 本文档
├── data/                      # 数据目录（运行时）
├── Makefile                   # 构建脚本
└── .gitignore
```

---

## 九、快速开始

### 9.1 环境准备

```bash
# 克隆项目
git clone https://github.com/xxx/openDeepWiki.git
cd openDeepWiki

# 安装依赖
make setup

# 初始化配置
make init-config

# 编辑配置文件，设置 LLM API Key
vim backend/config.yaml
```

### 9.2 启动服务

```bash
# 方式1：开发模式（热重载）
make dev

# 方式2：分别启动
make air           # 后端（带热重载）
make run-frontend  # 前端

# 方式3：生产模式
make build
make run-backend
```

### 9.3 访问地址

- 后端 API：http://localhost:8080
- 前端页面：http://localhost:5173

---

## 十、后续规划

- [ ] 用户认证系统（可选）
- [ ] 多语言支持
- [ ] 更多项目类型支持
- [ ] 自定义解读模板
- [ ] Docker 部署支持
- [ ] 批量导入仓库
- [ ] 定时更新分析
