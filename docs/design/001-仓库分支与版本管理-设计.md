# 001-仓库分支与版本管理-设计

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-06 | 新增仓库克隆元数据记录设计 |

## 1. 设计目标

在仓库克隆完成后，记录仓库大小（MB）、克隆分支与 commit ID，写入 repository 表，供后续展示与版本追踪使用。

## 2. 数据模型设计

### 2.1 repositories 表扩展

新增字段：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| clone_branch | string | 克隆后的当前分支 | 克隆完成后写入 |
| clone_commit_id | string | 克隆后的 commit ID | 使用短 SHA |
| size_mb | float | 仓库大小（MB） | 以 1024*1024 计算 |

## 3. 业务流程设计

1. 克隆完成后，计算仓库目录大小，转换为 MB。
2. 获取当前分支与 commit ID。
3. 更新 repository 表中的 size_mb、clone_branch、clone_commit_id 字段。
4. 若计算失败，记录日志并保持字段为默认值，不影响仓库状态流转。

## 4. 影响范围

* model.Repository 新增字段
* RepositoryService.cloneRepository 在克隆成功后补充元数据更新
* internal/pkg/git 增加仓库大小与分支信息获取能力

## 5. 兼容性与数据迁移

* 使用 GORM AutoMigrate 自动新增字段
* 现有数据字段默认值为 0 或空字符串

