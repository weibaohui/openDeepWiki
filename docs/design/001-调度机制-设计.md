# 001-调度机制-设计

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-07 | 新增调度机制优化设计说明 |

## 1. 目标

仅实现调度机制优化指引中的 1-5 点，确保任务重试可控、超时可配置、分发更及时、重试队列稳定。

## 2. 范围

### 2.1 包含

- 扩展 Job 字段：重试次数、最大重试次数、超时配置
- retry 与 dispatch 逻辑改造（重试次数上限、错误日志）
- 执行失败后的指数退避重试
- dispatchLoop 去除无意义 sleep
- retry 队列协程与单任务 panic 防护

### 2.2 不包含

- Prometheus 指标（第 6 点）
- 幂等性保障（第 7 点）

## 3. 设计

### 3.1 Job 结构扩展

- RetryCount：当前重试次数
- MaxRetries：最大重试次数，默认 5
- Timeout：任务超时配置，默认 10 分钟

### 3.2 分发与重试策略

- 获取仓库锁失败或提交协程池失败时，先判断 RetryCount 是否达到 MaxRetries
- 未超过上限时，RetryCount+1 入重试队列并记录告警日志
- 超过上限时直接丢弃并记录告警日志

### 3.3 执行失败重试

- 以 Job.Timeout 作为任务执行超时
- 执行失败后进行指数退避重试
- 所有重试失败后记录错误日志

### 3.4 分发循环优化

- Dequeue 阻塞等待任务，不再额外 sleep
- 当队列关闭时退出 dispatchLoop

### 3.5 重试队列稳定性

- 重试协程增加 panic 防护与自恢复
- 单任务 dispatch 加入局部 panic 防护，避免影响循环

## 4. 影响范围

- backend/internal/service/orchestrator/orchestrator.go
- backend/internal/service/orchestrator 相关测试文件

## 5. 验收标准

- 任务重试次数达到 MaxRetries 后停止重试并输出告警日志
- dispatchLoop 无多余 sleep，队列关闭时正常退出
- retryQueue 入队失败不再忽略错误，日志可观测
- 支持通过 Job.Timeout 自定义任务超时
- retryQueue 协程 panic 不影响持续运行
