# 002-文档模板管理-设计.md

> 对应需求：[002-文档模板管理-需求.md](../requirements/002-文档模板管理-需求.md)
>  
> **状态：已废除**  
> **废除原因**：已采用基于 AI 的分析生成流程，不再需要模板化文档与模板管理功能。  
> **备注**：本设计仅保留历史记录，后续不再实施。

## 1. 设计目标

将硬编码的文档模板迁移至数据库存储，支持三层结构：
- **Template（模板套件）**：一套完整的文档生成方案
- **Chapter（章节）**：模板下的一级目录
- **Document（文档）**：章节下的二级具体文档

## 2. 数据模型设计

### 2.1 模型关系

```
Template (1) --* Chapter (N) --* Document (N)
```

### 2.2 DocumentTemplate（模板套件）

```go
type DocumentTemplate struct {
    ID          uint      `gorm:"primaryKey"`
    Key         string    `gorm:"size:50;uniqueIndex;not null"` // 模板标识，如 general, springboot
    Name        string    `gorm:"size:100;not null"`            // 模板名称，如"通用模板"
    Description string    `gorm:"size:500"`                     // 描述
    IsSystem    bool      `gorm:"default:false"`                // 是否系统预置
    SortOrder   int       `gorm:"default:0"`                    // 排序序号
    CreatedAt   time.Time `gorm:"autoCreateTime"`
    UpdatedAt   time.Time `gorm:"autoUpdateTime"`
    Chapters    []TemplateChapter `gorm:"foreignKey:TemplateID;constraint:OnDelete:CASCADE;"`
}
```

### 2.3 TemplateChapter（一级章节）

```go
type TemplateChapter struct {
    ID          uint               `gorm:"primaryKey"`
    TemplateID  uint               `gorm:"index;not null"`               // 关联模板ID
    Title       string             `gorm:"size:100;not null"`            // 章节标题，如"架构分析"
    SortOrder   int                `gorm:"default:0"`                    // 排序序号
    CreatedAt   time.Time          `gorm:"autoCreateTime"`
    UpdatedAt   time.Time          `gorm:"autoUpdateTime"`
    Documents   []TemplateDocument `gorm:"foreignKey:ChapterID;constraint:OnDelete:CASCADE;"`
}
```

### 2.4 TemplateDocument（二级文档）

```go
type TemplateDocument struct {
    ID            uint      `gorm:"primaryKey"`
    ChapterID     uint      `gorm:"index;not null"`               // 关联章节ID
    Title         string    `gorm:"size:100;not null"`            // 文档标题，如"数据架构"
    Filename      string    `gorm:"size:100;not null"`            // 建议文件名，如 data_arch.md
    ContentPrompt string    `gorm:"type:text"`                    // 内容生成提示
    SortOrder     int       `gorm:"default:0"`                    // 排序序号
    CreatedAt     time.Time `gorm:"autoCreateTime"`
    UpdatedAt     time.Time `gorm:"autoUpdateTime"`
}
```

## 3. API 设计

### 3.1 文档模板管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/document-templates | 获取模板列表 |
| POST | /api/document-templates | 创建模板 |
| GET | /api/document-templates/:id | 获取模板详情（含章节和文档树） |
| PUT | /api/document-templates/:id | 更新模板 |
| DELETE | /api/document-templates/:id | 删除模板（系统模板不可删除） |
| POST | /api/document-templates/:id/clone | 克隆模板 |

### 3.2 章节管理

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/document-templates/:id/chapters | 创建章节 |
| PUT | /api/chapters/:id | 更新章节 |
| DELETE | /api/chapters/:id | 删除章节 |

### 3.3 文档管理

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/chapters/:id/documents | 创建文档 |
| PUT | /api/documents/:id | 更新文档 |
| DELETE | /api/documents/:id | 删除文档 |

### 3.4 响应结构

**获取模板详情响应：**

```json
{
  "data": {
    "id": 1,
    "key": "general",
    "name": "通用模板",
    "description": "适用于大多数项目的通用文档模板",
    "is_system": true,
    "sort_order": 1,
    "created_at": "2024-01-15T10:00:00Z",
    "updated_at": "2024-01-15T10:00:00Z",
    "chapters": [
      {
        "id": 101,
        "title": "架构分析",
        "sort_order": 2,
        "documents": [
          {
            "id": 1001,
            "title": "数据架构",
            "filename": "data_architecture.md",
            "content_prompt": "分析项目的数据模型、数据库设计和数据流转...",
            "sort_order": 1
          },
          {
            "id": 1002,
            "title": "业务架构",
            "filename": "business_architecture.md",
            "content_prompt": "分析项目的业务模块划分和业务逻辑...",
            "sort_order": 2
          }
        ]
      }
    ]
  }
}
```

## 4. 预置模板数据

### 4.1 通用模板 (general)

| 章节 | 文档 | 文件名 |
|------|------|--------|
| 项目概览 | 项目概览 | overview.md |
| 架构分析 | 数据架构 | data_architecture.md |
| 架构分析 | 业务架构 | business_architecture.md |
| 核心接口 | 核心接口 | api.md |
| 业务流程 | 业务流程 | business_flow.md |
| 部署配置 | 部署配置 | deployment.md |

### 4.2 SpringBoot 模板 (springboot)

| 章节 | 文档 | 文件名 |
|------|------|--------|
| 项目概览 | 项目概览 | overview.md |
| 架构分析 | 数据架构 | data_architecture.md |
| 架构分析 | 业务架构 | business_architecture.md |
| 核心接口 | Controller 层分析 | controller.md |
| 核心接口 | Service 层分析 | service.md |
| 核心接口 | Repository 层分析 | repository.md |
| 业务流程 | 业务流程 | business_flow.md |
| 部署配置 | 部署配置 | deployment.md |

### 4.3 前端模板 (frontend)

| 章节 | 文档 | 文件名 |
|------|------|--------|
| 项目概览 | 项目概览 | overview.md |
| 架构分析 | 组件分析 | components.md |
| 架构分析 | 路由配置 | routing.md |
| 核心接口 | API 接口 | api.md |
| 状态管理 | 状态管理 | state_management.md |
| 部署配置 | 部署配置 | deployment.md |

## 5. 分层架构设计

### 5.1 文件结构

```
backend/internal/
  model/
    document_template.go    # 新增：模板模型
    template_chapter.go     # 新增：章节模型
    template_document.go    # 新增：文档模型
  repository/
    template_repo.go        # 新增：模板 Repository
    chapter_repo.go         # 新增：章节 Repository
    doc_template_repo.go    # 新增：文档 Repository
  service/
    template.go             # 新增：模板 Service
    chapter.go              # 新增：章节 Service
    doc_template.go         # 新增：文档 Service
  handler/
    document_template.go    # 新增：模板 Handler
```

### 5.2 依赖关系

```
DocumentTemplateHandler
  ↓
DocumentTemplateService
  ↓
TemplateRepository / ChapterRepository / DocTemplateRepository
  ↓
DocumentTemplateModel / TemplateChapterModel / TemplateDocumentModel
```

## 6. 与现有系统集成

### 6.1 数据库迁移

在应用启动时，使用 `AutoMigrate` 创建新表：

```go
db.AutoMigrate(
    &model.DocumentTemplate{},
    &model.TemplateChapter{},
    &model.TemplateDocument{},
)
```

### 6.2 数据初始化

在 main.go 中调用初始化函数：

```go
// 初始化预置模板
if err := service.InitDefaultTemplates(db); err != nil {
    log.Printf("Failed to init templates: %v", err)
}
```

## 7. 关键业务规则

1. **系统模板保护**：`is_system=true` 的模板不可删除，但可克隆
2. **层级限制**：严格的两级结构，Document 下不能创建子文档
3. **级联删除**：删除 Template 时级联删除其 Chapters 和 Documents；删除 Chapter 时级联删除其 Documents
4. **排序**：使用 `sort_order` 字段控制显示顺序

## 8. 前端页面设计

### 8.1 模板列表页

- 表格展示：名称、标识、是否系统模板、操作
- 操作按钮：查看、编辑、克隆、删除（系统模板禁用删除）

### 8.2 模板详情/编辑页

- 左侧：模板基本信息（名称、标识、描述）
- 右侧：章节和文档的树形结构
- 支持：添加/编辑/删除章节和文档
- 支持：拖拽排序（后续版本）

## 9. 安全考虑

1. 系统模板不可删除，防止误删预置配置
2. 克隆功能允许基于系统模板创建自定义模板
3. 输入验证防止 SQL 注入和 XSS

## 10. 实现步骤

1. 创建 Model 层
2. 创建 Repository 层
3. 创建 Service 层（含初始化逻辑）
4. 创建 Handler 层和路由
5. 前端 API 服务和类型定义
6. 前端页面开发
7. 测试验证
