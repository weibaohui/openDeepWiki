# 014-目录分析任务生成服务-设计

## 1. 设计目标

实现一个基于 Eino ADK 的目录分析任务生成服务，能够：
1. 智能分析本地仓库代码目录结构
2. 根据项目特征动态决定需要哪些分析任务
3. 将生成的任务保存到数据库
4. 复用现有的 ADK Agents 管理能力

---

## 2. 模块结构

```
backend/internal/service/directoryanalyzer/
├── service.go       # Service 接口和实现
├── workflow.go      # ADK Workflow 实现
└── types.go         # 类型定义

backend/agents/
├── task_generator.yaml      # 任务生成 Agent
└── task_validator.yaml      # 任务校验 Agent
```

---

## 3. 核心组件设计

### 3.1 DirectoryAnalyzerService

```go
// DirectoryAnalyzerService 目录分析任务生成服务
type DirectoryAnalyzerService struct {
    cfg      *config.Config
    workflow *TaskGeneratorWorkflow
    taskRepo repository.TaskRepository
}

// NewDirectoryAnalyzerService 创建服务实例
func NewDirectoryAnalyzerService(
    cfg *config.Config,
    taskRepo repository.TaskRepository,
) (*DirectoryAnalyzerService, error)

// AnalyzeAndCreateTasks 分析目录并创建任务
func (s *DirectoryAnalyzerService) AnalyzeAndCreateTasks(
    ctx context.Context,
    localPath string,
    repo *model.Repository,
) ([]*model.Task, error)
```

**职责**：
- 初始化 Workflow
- 接收外部调用请求
- 遍历分析结果创建任务

### 3.2 TaskGeneratorWorkflow

```go
// TaskGeneratorWorkflow 任务生成工作流
type TaskGeneratorWorkflow struct {
    cfg             *config.Config
    sequentialAgent adk.ResumableAgent
    factory         *adkagents.AgentFactory
}

// Agent 名称常量
const (
    AgentTaskGenerator = "TaskGenerator"  // 任务生成 Agent
    AgentTaskValidator = "TaskValidator"  // 任务校验 Agent
)

// NewTaskGeneratorWorkflow 创建工作流实例
func NewTaskGeneratorWorkflow(cfg *config.Config) (*TaskGeneratorWorkflow, error)

// Build 构建 SequentialAgent
func (w *TaskGeneratorWorkflow) Build(ctx context.Context) error

// Run 执行分析流程
func (w *TaskGeneratorWorkflow) Run(ctx context.Context, localPath string) (*TaskGenerationResult, error)
```

**Workflow 流程**：
```
[输入: localPath]
    ↓
[Step 1: TaskGeneratorAgent] 
    - 使用 list_dir 分析目录结构
    - 使用 read_file 读取关键文件
    - 分析项目类型和技术栈
    - 初步决定需要哪些任务
    - 输出 JSON 任务列表（草稿）
    ↓
[Step 2: TaskValidatorAgent]
    - 接收 Generator 的输出
    - 检查任务列表的完整性
    - 验证任务类型的合理性
    - 修正错误或补充遗漏
    - 输出最终 JSON 任务列表
    ↓
[Service 层: 遍历创建 Task]
```

### 3.3 类型定义

```go
// TaskGenerationResult 任务生成结果
type TaskGenerationResult struct {
    Tasks           []GeneratedTask `json:"tasks"`
    AnalysisSummary string          `json:"analysis_summary"`
}

// GeneratedTask 生成的任务定义
// Type 字段不再局限于预定义值，Agent 可根据项目特征自由定义
type GeneratedTask struct {
    Type      string `json:"type"`       // 任务类型标识，如 "security", "performance", "data-model"
    Title     string `json:"title"`      // 任务标题，如 "安全分析"
    SortOrder int    `json:"sort_order"` // 排序顺序
}

// 预定义任务类型参考（Agent 可参考，但不局限于这些）
const (
    TaskTypeOverview     = "overview"      // 项目概览
    TaskTypeArchitecture = "architecture"  // 架构分析
    TaskTypeAPI          = "api"           // 核心接口
    TaskTypeBusinessFlow = "business-flow" // 业务流程
    TaskTypeDeployment   = "deployment"    // 部署配置
    TaskTypeSecurity     = "security"      // 安全分析
    TaskTypePerformance  = "performance"   // 性能分析
    TaskTypeDataModel    = "data-model"    // 数据模型
    TaskTypeTesting      = "testing"       // 测试分析
    TaskTypeDevOps       = "devops"        // DevOps 流程
    TaskTypeFrontend     = "frontend"      // 前端分析
    TaskTypeDatabase     = "database"      // 数据库设计
    TaskTypeCache        = "cache"         // 缓存策略
    TaskTypeMessageQueue = "mq"            // 消息队列
    TaskTypeAuth         = "auth"          // 认证授权
    TaskTypeLogMonitor   = "log-monitor"   // 日志监控
)
```

---

## 4. 关键流程

### 4.1 服务初始化流程

```
NewDirectoryAnalyzerService(cfg, taskRepo)
    ↓
创建 TaskGeneratorWorkflow
    ↓
Workflow 内部创建 AgentFactory
    ↓
AgentFactory 从 YAML 加载 TaskGenerator Agent
    ↓
返回 Service 实例
```

### 4.2 分析并创建任务流程

```
AnalyzeAndCreateTasks(ctx, localPath, repo)
    ↓
调用 workflow.Run(ctx, localPath)
    ↓
    [Workflow 内部]
    Build() - 创建 SequentialAgent（包含 TaskGenerator + TaskValidator）
        ↓
    创建 Runner
        ↓
    构建初始 Prompt（包含 localPath）
        ↓
    runner.Run() 顺序执行两个 Agent
        ↓
    [Step 1: TaskGeneratorAgent 执行]
        - 分析目录结构
        - 生成初步任务列表
        - 输出 JSON（草稿）
        ↓
    [Step 2: TaskValidatorAgent 执行]
        - 接收 Generator 的输出作为上下文
        - 校验任务列表的合理性
        - 修正错误或补充遗漏
        - 输出最终 JSON
        ↓
    解析最终输出 JSON
        ↓
返回 TaskGenerationResult
    ↓
遍历 result.Tasks
    ↓
为每个 task 创建 model.Task
    ↓
调用 taskRepo.Create() 保存
    ↓
返回创建的任务列表
```

### 4.3 Agent 执行流程

**Step 1: TaskGenerator Agent**
```
TaskGenerator Agent 接收到 Prompt
    ↓
分析目录结构（调用 list_dir）
    ↓
读取关键配置文件（read_file）
    - README.md / package.json / go.mod / pom.xml 等
    - 安全相关: security/, auth/, oauth, jwt 配置
    - 性能相关: cache/, redis/, performance/ 配置
    - 数据相关: model/, entity/, schema/, migration/
    - 测试相关: test/, tests/, __tests__/, *.test.js
    - 部署相关: Dockerfile, k8s/, helm/, .github/workflows/
    ↓
识别项目特征：
    - 类型：Go / Java / Python / Frontend / Mixed / Microservices
    - 技术栈：Gin / Spring / Django / React / Vue / K8s 等
    - 规模：文件数、目录深度、服务数量
    - 架构模式：单体 / 微服务 / Serverless / 分布式
    - 数据存储：MySQL / PostgreSQL / MongoDB / Redis / ES
    - 通信方式：HTTP / gRPC / 消息队列 / WebSocket
    ↓
基于软件开发经验决策需要哪些分析任务：
    【基础任务】
    - overview: 所有项目必需
    - architecture: 分析整体架构设计
    
    【根据特征动态添加】
    - api: 存在接口定义文件
    - business-flow: 存在业务逻辑代码
    - deployment: 存在部署配置
    - security: 发现 auth/, security/ 或安全相关配置
    - performance: 发现缓存、连接池、性能测试相关代码
    - data-model: 发现 ORM 实体、数据库迁移文件
    - testing: 发现测试目录或测试配置文件
    - devops: 发现 CI/CD 配置、运维脚本
    - frontend: 前端项目或前后端分离的前端部分
    - database: 复杂的数据库设计、分库分表
    - cache: Redis/Memcached 等缓存策略
    - mq: Kafka/RabbitMQ/RocketMQ 等消息队列使用
    - auth: OAuth/JWT/SSO 等认证授权实现
    - log-monitor: 日志收集、监控告警相关配置
    - microservices: 微服务治理、服务发现配置
    - event-driven: 事件驱动架构、CQRS 模式
    - scalability: 分布式锁、限流熔断相关实现
    ↓
输出 JSON 格式的任务列表（草稿，type 字段可自定义）
```

**Step 2: TaskValidator Agent**
```
TaskValidator Agent 接收到 Generator 的输出
    ↓
读取原始 Prompt（包含 localPath）
    ↓
执行校验逻辑：
    - 检查是否包含 overview（必需）
    - 检查 sort_order 是否连续无重复
    - 检查 type 是否为小写、无空格、使用连字符
    - 检查 title 是否简洁明确
    - 检查任务与项目特征是否匹配（避免过度设计）
    - 检查是否有重复或相似任务
    ↓
基于软件工程最佳实践修正：
    - 补充遗漏的必需任务（如 overview）
    - 合并相似任务
    - 优化任务顺序（基础 -> 架构 -> 专项）
    - 调整不合理的自定义 type（规范化命名）
    - 完善 analysis_summary
    ↓
输出最终 JSON 格式的任务列表
```

---

## 5. Agent 配置设计

### 5.1 TaskGenerator Agent 配置

文件路径：`backend/agents/task_generator.yaml`

```yaml
name: TaskGenerator
description: 任务生成器 - 分析代码目录并初步决定需要哪些分析任务

model: ""

instruction: |
  你是一个智能的任务生成助手。你的任务是分析给定的代码仓库目录，
  根据项目特征初步决定需要哪些分析任务。
  
  **分析步骤**：
  1. 使用 list_dir 工具查看目录结构
  2. 根据项目类型读取关键配置文件：
     - Go 项目: go.mod, go.sum
     - Java 项目: pom.xml, build.gradle
     - Python 项目: requirements.txt, pyproject.toml
     - Node 项目: package.json
     - 所有项目: README.md, Dockerfile, docker-compose.yml
  3. 分析项目类型、技术栈和规模
  4. 初步决定需要哪些分析任务
  
  **任务类型（可根据项目特征自由扩展）**：
  
  【基础任务】
  - overview: 项目概览（所有项目必需）
  - architecture: 架构分析（分析整体架构设计）
  
  【接口与业务】
  - api: 核心接口分析（HTTP/gRPC/GraphQL 等）
  - business-flow: 业务流程分析（核心业务逻辑）
  
  【部署与运维】
  - deployment: 部署配置分析（Docker/K8s/云原生）
  - devops: DevOps 流程分析（CI/CD/自动化）
  
  【安全与认证】
  - security: 安全分析（漏洞扫描、安全策略）
  - auth: 认证授权分析（OAuth/JWT/SSO/RBAC）
  
  【数据与存储】
  - data-model: 数据模型分析（ER图、领域模型）
  - database: 数据库设计分析（分库分表、索引优化）
  - cache: 缓存策略分析（Redis/本地缓存/缓存一致性）
  
  【性能与扩展】
  - performance: 性能分析（瓶颈、优化建议）
  - mq: 消息队列分析（异步处理、削峰填谷）
  - scalability: 可扩展性分析（分布式、微服务治理）
  
  【前端与测试】
  - frontend: 前端架构分析（组件设计、状态管理）
  - testing: 测试策略分析（单元测试、集成测试、覆盖率）
  
  【监控与日志】
  - log-monitor: 日志监控分析（日志收集、链路追踪、告警）
  - event-driven: 事件驱动分析（事件溯源、CQRS）
  
  **输出格式**（必须是有效的 JSON）：
  {
    "tasks": [
      {"type": "overview", "title": "项目概览", "sort_order": 1},
      {"type": "architecture", "title": "架构分析", "sort_order": 2},
      {"type": "security", "title": "安全分析", "sort_order": 3},
      {"type": "performance", "title": "性能优化建议", "sort_order": 4}
    ],
    "analysis_summary": "这是一个电商微服务系统，使用 Go + Gin 开发，包含订单、支付、库存等服务，使用 MySQL + Redis，部署在 Kubernetes 上..."
  }
  
  **决策规则（基于软件开发经验）**：
  
  1. 【所有项目】overview: 项目基本信息、技术栈、目录结构
  2. 【所有项目】architecture: 整体架构、模块划分、依赖关系
  
  3. 【Web/API 服务】api: 接口设计、路由、中间件、版本管理
  4. 【业务系统】business-flow: 核心业务场景、状态机、业务规则
  5. 【有部署配置】deployment: 容器化、编排、环境配置、扩缩容
  
  6. 【发现安全相关】security: 
     - 存在 auth/, oauth/, jwt, casbin 等目录或依赖
     - 处理敏感数据（支付、用户信息）
     
  7. 【发现性能优化】performance:
     - 存在缓存配置（redis, cache, pool）
     - 连接池、异步处理、并发控制
     - 性能测试文件
     
  8. 【发现数据模型】data-model:
     - 存在 ORM 实体（gorm, xorm, jpa, sqlalchemy）
     - 数据库迁移文件（migration, flyway, liquibase）
     - 复杂的数据结构
     
  9. 【发现消息队列】mq:
     - 存在 kafka, rabbitmq, rocketmq, nats 等依赖或配置
     - 异步处理、事件总线相关代码
     
  10. 【发现微服务特征】microservices:
      - 多服务目录结构
      - 服务发现（etcd, consul, nacos）
      - 网关、配置中心
      
  11. 【发现前端代码】frontend:
      - React/Vue/Angular 项目
      - 组件库、状态管理（redux, pinia, vuex）
      
  12. 【发现测试代码】testing:
      - 测试覆盖率较高的项目
      - 测试框架配置（jest, pytest, ginkgo）
      
  13. 【发现 DevOps 配置】devops:
      - CI/CD 配置（.github/workflows, .gitlab-ci.yml, Jenkins）
      - 自动化脚本、Git Hooks
      
  14. 【其他专项】根据项目特点自由发挥：
      - ai-ml: 机器学习项目（模型、训练、推理）
      - blockchain: 区块链相关
      - iot: 物联网项目
      - game: 游戏开发
      - embedded: 嵌入式系统
  
  注意：你的输出将被校验 Agent 审查和修正，请确保格式正确。

tools:
  - list_dir
  - read_file
  - search_files

maxIterations: 10
```

### 5.2 TaskValidator Agent 配置

文件路径：`backend/agents/task_validator.yaml`

```yaml
name: TaskValidator
description: 任务校验器 - 审查并修正任务生成结果

model: ""

instruction: |
  你是一个严格的任务校验助手。你的任务是审查 TaskGenerator 生成的
  任务列表，修正其中的错误并确保输出质量。
  
  **输入内容**：
  - 原始仓库路径和上下文信息
  - TaskGenerator 生成的任务列表（JSON 格式）
  
  **校验 checklist**：
  1. **完整性检查**
     - 是否包含 overview 任务？（所有项目必需）
     - 任务列表是否为空？
  
  2. **格式检查**
     - type 是否为小写、使用连字符连接（如 "data-model"）？
     - type 是否唯一（无重复）？
     - title 是否简洁明确？
  
  3. **合理性检查**
     - 任务数量是否与项目规模匹配？（小型项目 2-4 个，中型 4-6 个，大型 6-10 个）
     - 任务类型是否与项目特征匹配？（避免过度设计）
     - 是否存在重复或相似任务？（如 architecture 和 microservices 可合并）
     - 任务顺序是否合理？（基础 -> 架构 -> 专项）
  
  4. **命名规范化**
     - 自定义 type 应简洁、语义明确
     - 推荐使用标准命名：security, performance, data-model, testing 等
     - 避免使用：random-task, other, misc 等模糊命名
  
  5. **修正规则**
     - 缺少 overview：补充 {"type": "overview", "title": "项目概览", "sort_order": 1}
     - 命名不规范的 type：修正为标准命名（如 "db_design" -> "database"）
     - 任务过多（>10）：合并相似任务或移除次要任务
     - 任务过少（<2）：分析是否遗漏重要方面（如安全性、性能）
     - 重复任务：合并或移除
  
  **输出格式**（必须是有效的 JSON）：
  {
    "tasks": [
      {"type": "overview", "title": "项目概览", "sort_order": 1},
      {"type": "architecture", "title": "架构分析", "sort_order": 2},
      {"type": "security", "title": "安全分析", "sort_order": 3}
    ],
    "analysis_summary": "项目是一个 Go Web 服务，使用 Gin 框架..."
  }
  
  **重要**：
  - 只输出最终的 JSON，不要有其他解释性文字
  - 确保 JSON 可以被标准 JSON 解析器解析
  - 如果原任务列表已经正确，可以直接返回原样
  - 支持自定义 type，但需确保命名规范、语义清晰

tools:
  - list_dir
  - read_file

maxIterations: 5
```

### 5.3 配置字段说明

| Agent | 字段 | 值 | 说明 |
|-------|------|-----|------|
| TaskGenerator | name | TaskGenerator | 生成 Agent 标识 |
| TaskGenerator | maxIterations | 10 | 需要探索目录，迭代次数稍多 |
| TaskGenerator | tools | list_dir, read_file, search_files | 目录分析所需工具 |
| TaskValidator | name | TaskValidator | 校验 Agent 标识 |
| TaskValidator | maxIterations | 5 | 校验逻辑相对简单 |
| TaskValidator | tools | list_dir, read_file | 需要时可再次查看目录 |

---

## 6. 错误处理

### 6.1 错误类型

```go
var (
    ErrInvalidLocalPath      = errors.New("无效的本地路径")
    ErrAgentExecutionFailed  = errors.New("Agent 执行失败")
    ErrJSONParseFailed       = errors.New("JSON 解析失败")
    ErrTaskCreationFailed    = errors.New("任务创建失败")
    ErrWorkflowNotBuilt      = errors.New("Workflow 未构建")
)
```

### 6.2 处理策略

| 场景 | 处理方式 |
|------|----------|
| 目录不存在 | 提前校验，返回 ErrInvalidLocalPath |
| Agent 执行失败 | 记录详细日志，返回 ErrAgentExecutionFailed |
| JSON 解析失败 | 尝试提取 JSON 子串，失败则返回错误 |
| 部分任务创建失败 | 记录错误，继续创建其他任务，最后返回汇总错误 |

---

## 7. 与现有系统集成

### 7.1 复用组件

| 组件 | 来源 | 用途 |
|------|------|------|
| AgentFactory | adkagents | 创建和管理 Agent |
| TaskRepository | repository | 保存生成的任务 |
| Config | config | 配置信息 |
| statemachine | service/statemachine | 任务状态枚举 |

### 7.2 初始化位置

建议在 Service 层初始化（如 TaskService 或新的 Orchestrator）：

```go
// 在应用初始化时
directoryAnalyzerSvc, err := directoryanalyzer.NewDirectoryAnalyzerService(
    cfg,
    taskRepo,
)
```

---

## 8. 测试策略

### 8.1 单元测试

- `types_test.go`: 验证 JSON 解析逻辑
- `workflow_test.go`: Mock Agent 响应，测试 Workflow 流程

### 8.2 集成测试

- 使用真实仓库路径测试完整流程
- 验证不同项目类型的任务生成结果

---

## 9. 实施计划

1. **创建 Agent 配置文件**
   - `backend/agents/task_generator.yaml`
   - `backend/agents/task_validator.yaml`
2. **创建 types.go** - 定义结果类型
3. **创建 workflow.go** - 实现双 Agent Workflow 逻辑
4. **创建 service.go** - 实现 Service 接口
5. **编写测试用例**
6. **验证与现有系统集成**
