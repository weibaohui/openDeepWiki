# 018-文档多版本保存-设计.md

## 1. 概述

本设计文档描述文档多版本保存能力的实现方案。目标是在同一任务多次生成文档时保留历史版本，并将最新版本作为默认展示。

---

## 2. 架构设计

### 2.1 模块划分

| 模块名称 | 职责 | 文件位置 |
|---------|------|---------|
| model | 文档模型新增版本字段 | `internal/model/models.go` |
| repository | 版本查询与最新版本标记 | `internal/repository/doc_repo.go` |
| service | 版本号计算与保存流程 | `internal/service/document.go` |
| task | 生成文档时触发版本保存 | `internal/service/task.go` |

---

## 3. 数据库设计

### 3.1 表结构

```sql
ALTER TABLE documents ADD COLUMN version INTEGER DEFAULT 1;
ALTER TABLE documents ADD COLUMN is_latest BOOLEAN DEFAULT 1;
CREATE INDEX idx_documents_task_id_version ON documents(task_id, version);
CREATE INDEX idx_documents_repo_latest ON documents(repository_id, is_latest);
```

### 3.2 数据模型

```go
// internal/model/models.go
type Document struct {
    ID           uint      `json:"id" gorm:"primaryKey"`
    RepositoryID uint      `json:"repository_id" gorm:"index`
    TaskID       uint      `json:"task_id" gorm:"index"`
    Title        string    `json:"title" gorm:"size:255`
    Filename     string    `json:"filename" gorm:"size:255`
    Content      string    `json:"content" gorm:"type:text"`
    SortOrder    int       `json:"sort_order" gorm:"default:0"`
    Version      int       `json:"version" gorm:"default:1;index"`
    IsLatest     bool      `json:"is_latest" gorm:"default:true;index"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}
```

---

## 4. Repository 层设计

### 4.1 新增方法

```go
// internal/repository/repository.go
type DocumentRepository interface {
    Create(doc *model.Document) error
    GetByRepository(repoID uint) ([]model.Document, error)
    Get(id uint) (*model.Document, error)
    Save(doc *model.Document) error
    Delete(id uint) error
    DeleteByTaskID(taskID uint) error
    DeleteByRepositoryID(repoID uint) error

    GetLatestVersion(taskID uint) (int, error)
    ClearLatestByTaskID(taskID uint) error
}
```

### 4.2 查询与更新逻辑

- `GetLatestVersion`：返回任务下最大版本号，任务无历史时返回 0
- `ClearLatestByTaskID`：将任务下所有文档 `is_latest` 设置为 false

---

## 5. Service 层设计

### 5.1 创建文档版本流程

1. 获取任务当前最大版本号
2. 将旧版本 `is_latest` 设置为 false
3. 新版本号为 `maxVersion + 1`
4. 保存新版本并标记 `is_latest = true`

### 5.2 事务处理

使用数据库事务保证“清理旧版本 + 保存新版本”原子性，避免并发写入导致多条 `is_latest = true`。

---

## 6. Task 层行为调整

- 任务执行生成文档时调用版本化保存逻辑
- 任务重置不删除历史版本
- 任务删除仍删除所有版本

---

## 7. 查询策略

- `GetByRepository` 默认仅返回 `is_latest = true` 的记录
- `Get` 按 ID 获取，保持可访问历史版本

---

## 8. 风险与兼容性

- 老数据未设置版本字段时，默认版本为 1、`is_latest = true`
- AutoMigrate 负责新增字段，不影响既有记录读取
