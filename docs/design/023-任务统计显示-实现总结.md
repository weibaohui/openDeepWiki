# 任务统计显示功能总结

## 1. 功能概述
本功能在仓库详情页的任务列表上方增加了一个统计展示区域，实时显示当前仓库的任务排队数量（Queued）和正在执行的任务数量（Running）。这有助于用户快速了解系统的负载情况和任务处理进度。

此外，优化了任务列表中的操作按钮交互体验，将原本“不可用时隐藏”的逻辑修改为“不可用时禁用（置灰）”，使得界面布局更加稳定，且让用户能直观看到所有潜在的操作选项。

## 2. 需求对应
| 需求点 | 实现情况 | 备注 |
| :--- | :--- | :--- |
| 显示排队中任务数量 | 已实现 | 对应状态 `queued` |
| 显示正在执行任务数量 | 已实现 | 对应状态 `running` |
| 数据自动刷新 | 已实现 | 跟随现有轮询机制自动更新 |
| 任务操作按钮常驻显示 | 已实现 | Run, Cancel, Retry, Delete, Docs 按钮始终显示 |
| 任务操作按钮状态联动 | 已实现 | 根据任务状态自动切换 Disabled 状态 |
| 无文档任务批量重试 | 已实现 | 统计区域新增批量重试按钮 |
| 批量重试入口调整 | 已实现 | 移动到更多操作抽屉的任务管理区域 |
| 更多操作新增仓库按钮 | 已实现 | 新增重新下载仓库、删除仓库 |

## 3. 关键实现点

### 3.1 后端实现
*   **Repository 层**：在 `TaskRepository` 中增加了 `GetTaskStats(repoID uint)` 方法，使用 SQL `GROUP BY status` 聚合查询任务数量。
*   **Service 层**：在 `TaskService` 中透传调用 Repository 的统计方法。
*   **Handler 层**：新增 `GET /api/repositories/:id/tasks/stats` 接口，返回任务统计数据的 JSON 对象。
*   **路由**：注册了新的 API 路由。
*   **仓库重下接口**：新增 `POST /api/repositories/:id/clone`，触发仓库重新克隆流程。

### 3.2 前端实现
*   **API Client**：在 `taskApi` 中增加了 `getStats` 方法。
*   **UI 组件**：在 `RepoDetail` 页面中，使用 `Promise.all` 并行请求任务列表和统计数据。
*   **统计展示**：使用 Ant Design 图标和排版组件展示统计数字。
*   **批量重试**：将“重试无文档任务”按钮移动到更多操作抽屉，自动筛选无文档且可重试任务并批量触发重试。
*   **仓库操作**：更多操作抽屉新增“重新下载仓库”和“删除仓库”按钮。
*   **按钮交互**：
    *   移除了 `actions` 数组中的条件渲染逻辑（`&&`）。
    *   为每个按钮添加 `disabled` 属性，绑定对应的状态判断逻辑。
    *   统一使用 `Tooltip` 组件包裹按钮，提供操作提示。

## 4. 已知限制与待改进
*   当前统计接口是实时的，但前端采用轮询方式刷新，可能存在轻微的延迟。
*   未来可以考虑使用 WebSocket 推送状态变更。
*   目前仅展示了 Queued 和 Running 状态，未来可以扩展展示 Failed 或 Completed 状态的统计。
*   批量重试当前为前端逐个触发调用，若任务数量过多可能带来请求压力。

## 5. 变更文件清单
*   `backend/internal/repository/repository.go`
*   `backend/internal/repository/task_repo.go`
*   `backend/internal/service/task.go`
*   `backend/internal/handler/task.go`
*   `backend/internal/router/router.go`
*   `backend/internal/service/repository.go`
*   `backend/internal/service/statemachine/repository_state_machine.go`
*   `backend/internal/handler/repository.go`
*   `frontend/src/services/api.ts`
*   `frontend/src/pages/RepoDetail.tsx`
*   `frontend/src/i18n/locales/zh-CN.json`
*   `frontend/src/i18n/locales/en-US.json`
