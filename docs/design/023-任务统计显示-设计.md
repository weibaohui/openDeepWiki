# 任务统计显示设计文档

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-11 | 增加任务执行耗时展示设计 |

## 1. 总体方案
为了在仓库详情页显示任务统计信息（排队中、执行中），我们将新增一个后端 API 接口用于获取指定仓库的任务统计数据，并在前端调用该接口进行展示。
虽然当前前端已获取全量任务列表，可以进行客户端计算，但为了适应未来可能的分页需求以及降低前端处理逻辑复杂度，采用服务端聚合查询的方案。

## 2. 后端设计

### 2.1 API 接口设计
新增接口：`GET /api/v1/repositories/:id/tasks/stats`

**请求参数**：
*   `id`: 仓库 ID (path parameter)

**响应结构**：
```json
{
  "queued": 5,
  "running": 2,
  "succeeded": 100,
  "failed": 3,
  "canceled": 1,
  "total": 111
}
```

新增接口：`POST /api/v1/repositories/:id/clone`

**请求参数**：
*   `id`: 仓库 ID (path parameter)

**响应结构**：
```json
{
  "message": "clone started"
}
```

### 2.2 模块设计

#### 2.2.1 Repository 层 (`internal/repository`)
在 `TaskRepository` 接口中增加方法：
```go
GetTaskStats(repoID uint) (map[string]int64, error)
```
实现逻辑：使用 GORM 的 `Group` 和 `Count` 聚合查询。

#### 2.2.2 Service 层 (`internal/service`)
在 `TaskService` 中增加方法：
```go
GetTaskStats(repoID uint) (map[string]int64, error)
```

#### 2.2.3 Handler 层 (`internal/handler`)
在 `TaskHandler` 中增加方法：
```go
GetStats(c *gin.Context)
```

在 `RepositoryHandler` 中增加方法：
```go
Clone(c *gin.Context)
```

### 2.3 路由配置
在路由文件中注册新的 GET/POST 路由。

## 3. 前端设计

### 3.1 API Service (`frontend/src/services/api.ts`)
在 `taskApi` 对象中增加 `getStats(repoId: number)` 方法。

### 3.2 组件设计 (`frontend/src/pages/RepoDetail.tsx`)
1.  **状态管理**：新增 `taskStats` state。
2.  **数据获取**：在 `fetchData` 函数中并行请求 `taskApi.getStats`。
3.  **UI 展示**：在任务列表上方（`Col` 内，`Title` 下方）增加一个统计区域。
    *   使用 `Row`/`Col` 或 `Space` 布局。
    *   使用 Ant Design 的 `Statistic` 或 `Card` 组件展示 "Queued" 和 "Running" 数量。
    *   样式：
        *   Queued: 蓝色/灰色，图标 `ClockCircleOutlined`
        *   Running: 绿色/动态色，图标 `LoadingOutlined`
4.  **批量重试按钮**：在统计区域右侧增加“重试无文档任务”按钮。
    *   **可重试集合**：`documents` 中不存在对应文档，且任务状态不在 `pending`、`running`、`queued` 中。
    *   **交互行为**：点击后依次调用 `taskApi.retry(task.id)`，等同于用户逐个点击重试。
    *   **按钮状态**：当可重试集合为空时禁用，并展示提示文案。
5.  **更多操作抽屉**：
    *   将“重试无文档任务”按钮移动到“任务管理”区域。
    *   新增“重新下载仓库”和“删除仓库”按钮。
    *   新增“仅删除仓库目录”按钮，用于清理本地仓库目录但保留数据记录。

6.  **任务执行耗时**：
    *   列表项描述区域增加耗时显示，基于 `started_at` 与 `completed_at` 计算。
    *   运行中任务以当前时间计算实时耗时，随轮询刷新。

### 3.3 任务监控页面 (`frontend/src/components/settings/TaskMonitor.tsx`)
1.  **表格列新增**：在活跃任务与最近任务表格中增加“耗时”列。
2.  **展示规则**：与任务列表一致，运行中任务显示当前耗时，已结束任务显示总耗时。

## 4. 安全与权限
*   沿用现有的鉴权机制（假设 API 路由受保护）。

## 5. 兼容性
*   不修改原有 `GetByRepository` 接口，无兼容性风险。
