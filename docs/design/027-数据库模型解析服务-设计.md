# 027-数据库模型解析服务-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-08 | 初始版本 |

# 1. 总体方案
新增数据库模型解析 Service，从 TaskEvidence 中筛选数据库相关证据，构建 YAML 线索输入，使用“探索 Agent + markdown_checker”顺序执行生成 Markdown 文档，并通过 DocumentService 保存为版本化文档。

# 2. 数据与输入结构

## 2.1 证据筛选规则
- 命中关键词：model/sql/数据库/表/字段/ddl/迁移
- 关键词匹配范围：Aspect、Source、Detail、Title
- 未命中关键词时不纳入 YAML

## 2.2 YAML 输入结构
```yaml
evidences:
  - title: "表结构证据"
    detail: "models/user.go 中定义了 User 结构体"
    source: "backend/internal/model/models.go"
```

# 3. 服务端流程
1. 校验 localPath 与 title
2. 读取 TaskEvidence 并进行关键词筛选
3. 构建 YAML 线索字符串
4. 设置 ADK Session 值（local_path、document_title、task_id）
5. 通过 BuildSequentialAgent 构建“探索 Agent + markdown_checker”
6. RunAgentToLastContent 获取 Markdown 输出
7. 输出为空或非 Markdown 则返回错误
8. DocumentService.Create 保存文档

# 4. Agent 与提示词设计

## 4.1 Agent 组合
- 探索 Agent：db_model_explorer
- 校验 Agent：markdown_checker

## 4.2 提示词关键点
- 明确给出 YAML 线索作为背景信息
- 强调需输出所有表结构与字段解释
- 避免臆测，未找到的内容需说明

# 5. 代码改动范围
- 新增 Service：`backend/internal/service/dbmodelparser/service.go`
- 新增测试：`backend/internal/service/dbmodelparser/service_test.go`
- 新增 Agent 配置：`backend/agents/db_model_explorer.yaml`
- 接入任务执行：`backend/internal/service/task.go`
- 复用：DocumentService、EvidenceRepository

# 6. 错误处理与日志
- 参数校验失败：返回明确错误
- Agent 执行失败：包装错误并记录 klog.V(6) 日志
- 输出为空：返回 ErrNoAgentOutput

# 7. 兼容性与安全
- 不修改现有任务状态机
- 不输出本地绝对路径到最终文档
- 文档生成仅基于源码事实与证据线索
