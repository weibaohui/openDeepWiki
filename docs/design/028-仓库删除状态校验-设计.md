# 028-仓库删除状态校验-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-08 | 初始版本 |

## 1. 概述
在删除仓库时增加状态校验，已完成状态的仓库、正在分析中的仓库不能删除，防止误删除有价值的数据和中断正在执行的分析任务。

---

## 2. 业务规则

### 2.1 不允许删除的状态
- `completed` - 仓库分析已完成，包含有价值的分析文档
- `analyzing` - 仓库正在分析中，有任务正在执行

### 2.2 允许删除的状态
- `pending` - 刚创建但还未克隆
- `cloning` - 正在拉取代码（克隆中）
- `ready` - 可执行任务（至少 clone 成功）
- `error` - 分析失败

---

## 3. 校验逻辑

### 3.1 校验时机
在 `RepositoryService.Delete` 方法中，获取仓库基本信息后，执行删除操作前。

### 3.2 校验步骤
1. 获取仓库基本信息
2. 检查仓库状态
3. 如果状态为 `completed` 或 `analyzing`，返回明确的错误信息
4. 否则继续执行删除流程

---

## 4. 错误处理

### 4.1 错误定义
新增错误变量：
```go
ErrCannotDeleteRepoInvalidStatus = errors.New("无法删除仓库：已完成或正在分析中的仓库不能删除")
```

### 4.2 错误响应
Handler 层返回 HTTP 400 状态码和错误信息：
```json
{
  "error": "无法删除仓库：已完成或正在分析中的仓库不能删除"
}
```

---

## 5. 代码改动范围

| 模块 | 文件 | 改动内容 |
| --- | --- | --- |
| service | `backend/internal/service/repository.go` | Delete 方法增加状态校验逻辑，新增错误变量 |
| handler | `backend/internal/handler/repository.go` | Delete 方法增加错误处理，返回 400 状态码 |
| test | `backend/internal/service/repository_test.go` | 新增单元测试 |

---

## 6. 测试计划

### 6.1 单元测试
- 测试 completed 状态的仓库不能删除
- 测试 analyzing 状态的仓库不能删除
- 测试 pending 状态的仓库可以删除
- 测试 cloning 状态的仓库可以删除
- 测试 ready 状态的仓库可以删除
- 测试 error 状态的仓库可以删除

### 6.2 集成测试
- 通过 API 调用删除接口，验证各种状态下的响应

---

## 7. 风险与兼容性

### 7.1 风险点
- 用户可能对不能删除已完成仓库的行为感到困惑
- 正在分析中的仓库如果任务卡住，可能导致无法删除

### 7.2 缓解措施
- 提供清晰的错误信息，说明不能删除的原因
- 前端界面可以根据仓库状态隐藏删除按钮或给出提示
- 对于 analyzing 状态，如果任务长时间卡住，可以通过任务取消机制来处理

---

## 8. 后续优化建议

### 8.1 前端优化
- 在仓库列表页，根据状态禁用或隐藏删除按钮
- 在删除确认对话框中显示当前状态和提示信息

### 8.2 功能扩展
- 考虑增加"强制删除"功能，需要二次确认
- 考虑增加"归档"功能，对于 completed 状态的仓库可以先归档再删除
