# 029-文档评分-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-09 | 初始版本 |

# 1. 总体方案
在文档阅读页新增评分组件与统计展示，通过后端评分接口提交评分并返回实时统计。后端新增评分数据模型与统计查询，评分数据持久化到 document_ratings 表。

# 2. 数据模型设计

## 2.1 表结构
表名：document_ratings

| 字段名 | 类型 | 说明 | 备注 |
| ------ | ---- | ---- | ---- |
| id | uint | 主键 | |
| document_id | uint | 文档 ID | 索引 |
| score | int | 评分 1-5 | |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |

## 2.2 统计计算
- 平均分：score 的平均值，保留一位小数
- 评分次数：document_id 对应记录条数

# 3. 接口设计

## 3.1 提交评分
POST /api/documents/:id/ratings

请求：
```json
{ "score": 5 }
```

响应：
```json
{ "average_score": 4.6, "rating_count": 12 }
```

## 3.2 获取评分统计
GET /api/documents/:id/ratings/stats

响应：
```json
{ "average_score": 4.6, "rating_count": 12 }
```

# 4. 服务端流程
1. Handler 校验文档 ID 与评分范围（1-5）
2. Service 调用 Repository 保存评分
3. Repository 写入 document_ratings
4. Service 汇总评分统计并返回

# 5. 前端交互设计
- 文档阅读页顶部展示评分统计（平均分、评分次数）
- 使用 Ant Design Rate 组件提交评分
- 提交成功后刷新统计；失败提示错误信息
- 移动端使用垂直布局，避免拥挤

# 6. 代码改动范围
- 后端 Model：新增 document_rating 结构体
- 后端 Repository：新增评分写入与统计查询
- 后端 Service：新增评分与统计服务
- 后端 Handler：新增评分与统计接口
- 路由：新增文档评分相关路由
- 前端 DocViewer：新增评分 UI 与调用
- 前端 API Client：新增评分接口方法
- 前端 i18n：新增评分文案

# 7. 错误处理与日志
- 参数错误返回 400，消息明确
- 数据库失败返回 500
- 使用 klog.V(6) 输出评分保存与统计查询日志

# 8. 兼容性与安全
- 不修改现有文档版本策略与表结构
- 不记录客户端敏感标识或原始 IP
- 评分统计不阻塞文档内容加载
