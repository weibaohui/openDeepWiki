# 文档代码跳转设计

## 1. 背景
用户在阅读 Markdown 文档时，点击文档中的代码文件引用（相对路径），期望能够跳转到原始代码仓库（如 GitHub）对应的文件页面。

## 2. 需求
- 前端：识别 Markdown 中的相对路径链接，构造跳转 URL `/api/doc/{docId}/redirect?path={href}`。
- 后端：实现跳转接口，根据 `docId` 找到所属仓库，拼接仓库 URL 和文件路径，返回 HTTP 302 重定向。

## 3. 接口设计

### GET /api/doc/:id/redirect

**参数**
- `id` (path, required): 文档 ID
- `path` (query, required): 文件相对路径

**响应**
- `302 Found`: 重定向到外部代码仓库 URL
- `404 Not Found`: 文档不存在或仓库信息缺失
- `400 Bad Request`: 参数错误

## 4. 实现方案

### 4.1 路由
在 `router.go` 中添加：
```go
api.GET("/doc/:id/redirect", docHandler.Redirect)
```

### 4.2 Handler
`DocumentHandler.Redirect`:
1. 解析 `id` 和 `path`。
2. 调用 `DocumentService.GetRedirectURL(id, path)`。
3. 执行 `c.Redirect(http.StatusFound, url)`。

### 4.3 Service
`DocumentService.GetRedirectURL`:
1. 通过 `docId` 获取 `Document`。
2. 通过 `document.RepositoryID` 获取 `Repository`。
3. 解析 `repository.URL`，移除 `.git` 后缀。
4. 获取 `repository.CloneBranch` (默认为 `main` 或 `master`)。
5. 拼接 URL: `{repoUrl}/blob/{branch}/{path}`。
   - 注意处理路径中的 `/`。

## 5. 变更记录
| 日期 | 作者 | 变更内容 |
|---|---|---|
| 2026-02-09 | AI Assistant | 初稿 |
