# 033-数据表导入导出-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-10 | 初始版本，补充 Repository 同步前置步骤 |
| AI | 2026-02-10 | 增加文档选择下拉表格与同步参数设计 |
| AI | 2026-02-10 | 增加清空对端数据同步选项与流程设计 |
| AI | 2026-02-13 | 增加 pull 模式接口与流程设计 |

# 1. 总体方案
Push 模式由实例 A 发起同步，先保证实例 B 存在对应 Repository，再按 Task → Document → Task 更新 DocumentID 的顺序逐条同步，并提供同步状态查询与进度展示。
Pull 模式由实例 A 从实例 B 拉取数据，先从实例 B 获取仓库与文档列表，导出数据后在实例 A 执行 Repository、Task、Document 落库与映射更新。

# 2. 接口设计

## 2.1 接收端接口（实例 B）
- `POST /api/sync/repository-upsert`：创建或更新 Repository，作为 Task 与 Document 的前置依赖
- `POST /api/sync/repository-clear`：按 repository_id 清空 Task 与 Document
- `POST /api/sync/task-create`：创建 Task
- `POST /api/sync/document-create`：创建 Document
- `POST /api/sync/task-update-docid`：更新 Task 的 DocumentID

## 2.2 发起端接口（实例 A）
- `POST /api/sync`：发起同步请求
- `GET /api/sync/status/:sync_id`：查询同步状态

## 2.3 Pull 模式接口
数据源端（实例 B）：
- `GET /api/sync/repository-list`：获取可同步仓库列表
- `GET /api/sync/document-list`：获取指定仓库文档列表
- `POST /api/sync/pull-export`：导出 Repository、Task、Document 数据

拉取端（实例 A）：
- `POST /api/sync/pull`：发起 Pull 同步请求

# 3. 同步流程设计

## 3.1 单个 Document 同步流程
1. 同步 Repository 基本信息到实例 B
2. 创建 Task（不包含 DocumentID）
3. 创建 Document（TaskID 替换为实例 B 的 TaskID）
4. 更新实例 B 的 Task.DocumentID

## 3.2 完整同步流程
1. 用户在实例 A 发起同步请求
2. 验证目标服务器连通性
3. 同步 Repository 基本信息到实例 B
4. 若指定了 DocumentID 列表，仅同步选中的 Document
5. 若 clear_target=true，则按 repository_id 清空对端 Task、Document 数据
6. 查询指定 RepositoryID 的所有 Task
7. 按顺序对每个 Task 执行 Task 创建、Document 创建、Task 更新 DocID
8. 更新同步进度并返回最终结果

## 3.3 Pull 同步流程
1. 用户在实例 A 选择 Pull 模式并配置目标服务器
2. 从实例 B 获取仓库列表与文档列表
3. 若 clear_local=true，则先清空实例 A 目标仓库的 Task、Document 数据
4. 调用实例 B 的 pull-export 导出数据
5. 实例 A 创建或更新 Repository
6. 按顺序对每个 Task 执行 Task 创建、Document 创建、Task 更新 DocID
7. 更新同步进度并返回最终结果

# 4. 数据结构与映射

## 4.1 Repository 字段同步范围
- RepositoryID
- Name
- URL
- Branch
- Status
- CreatedAt / UpdatedAt
- Metadata

## 4.2 Task 与 Document 映射
- TaskIDMapping：实例 A 的 TaskID → 实例 B 的 TaskID
- DocumentIDMapping：实例 A 的 DocumentID → 实例 B 的 DocumentID

# 5. 错误处理与重试
- Repository 不存在：先执行 repository-upsert，再重试 Task 创建
- 目标服务器不可达或超时：中止并返回错误
- 单条 Task/Document 失败：记录错误并继续下一条，同步结果统计成功与失败

# 6. 前端交互设计
- 同步表单增加目标服务器与仓库选择
- 同步表单增加文档下拉表格选择
  - 标题可点击跳转 `/repo/{repoId}/doc/{docId}`
  - 状态展示为关联任务状态
  - 创建时间展示为文档创建时间
- 同步表单增加清空对端数据选项（按 repository_id 清空 Task、Document）
- Pull 模式下仓库列表从远端实例 B 加载并支持刷新
- 发起同步后轮询状态接口展示进度与当前任务
- 同步记录列表展示每条 Task/Document 的状态

# 7. 安全与权限
- 同步接口必须鉴权
- 校验用户对指定仓库的同步权限
- 生产环境使用 HTTPS
