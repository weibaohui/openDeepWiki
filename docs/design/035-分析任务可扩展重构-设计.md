# 035-分析任务可扩展重构-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-11 | 初始版本 |

## 1. 设计目标
在不改变现有对外接口的前提下，对 `repository_analyze.go` 进行单文件内重构，抽取专项分析任务的公共流程，降低重复逻辑与未来新增分析能力的接入成本。

## 2. 设计范围
- 仅修改 `backend/internal/service/repository_analyze.go`
- 不涉及其它 Service、Repo、API、模型或路由

## 3. 核心设计思路
以“分析任务规格”描述专项分析任务的可变部分（标题、排序、生成器、后置动作），统一封装公共执行流程（校验、建任务、异步执行、状态更新、文档保存）。

### 3.1 分析任务规格
```go
type analyzeTaskSpec struct {
    title         string
    sortOrder     int
    analyzeType   string
    generator     func(ctx context.Context, repo *model.Repository, task *model.Task) (string, error)
    afterSuccess  func(ctx context.Context, repo *model.Repository, task *model.Task) error
}
```
说明：
- `title` 与 `sortOrder` 用于创建任务
- `analyzeType` 用于日志与错误提示
- `generator` 统一生成内容并返回 Markdown
- `afterSuccess` 支持扩展后置动作（如标题重写）

### 3.2 通用执行流程
```
AnalyzeXxx(ctx, repoID, ...) ->
  校验服务依赖 ->
  获取仓库 + 校验状态 ->
  创建任务 ->
  异步执行:
    更新任务状态 running
    调用 generator 生成内容
    保存文档
    更新任务状态 succeeded/failed
    更新仓库状态
    执行 afterSuccess
```

## 4. 目录分析的保留策略
目录分析任务与专项分析任务流程差异较大（涉及批量创建任务与提示信息存储），因此保持现有逻辑，仅抽取公共的“仓库获取 + 状态校验”能力。

## 5. 可扩展接入方式
新增分析任务时只需：
1. 增加 `analyzeTaskSpec` 配置
2. 提供对应 `generator` 逻辑
3. 按需配置 `afterSuccess`
即可复用统一的执行流程。

## 6. 关键约束
- 不改变对外接口签名
- 日志保持中文描述且使用 klog.V(6)
- 仅在本文件内引入新类型与私有方法
