# 036-任务RunAfter依赖-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-11 | 初始版本 |

## 1. 设计目标
在不改变现有接口与状态机语义的前提下，为任务编排引入 RunAfter 依赖校验，使任务仅在前置任务成功后才允许入队。

## 2. 设计范围
- 任务编排入队逻辑（orchestrator）
- 任务状态读取逻辑（TaskRepo/TaskService 已有能力）
- 不扩展 API 与路由

## 3. 核心设计思路
在任务入队前增加 RunAfter 判定：
1. 若 RunAfter 为空，保持现有入队逻辑
2. 若 RunAfter 有值，读取依赖任务状态
3. 仅当依赖任务状态为成功时允许入队
4. 其他状态均不入队，并记录中文调试日志

## 4. 关键流程
```
获取可入队任务 -> 对每个任务检查 RunAfter:
  - 为空: 直接入队
  - 不为空: 查询依赖任务状态
      - 成功: 入队
      - 非成功: 记录日志，不入队
```

## 5. 关键约束
- 日志使用 klog.V(6) 且中文描述
- 不修改现有任务状态机与外部接口
