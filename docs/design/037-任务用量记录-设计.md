# 037-任务用量记录-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |

## 1. 设计目标
在不改变现有模型调用流程的前提下，新增任务用量记录能力，按任务维度持久化模型 token 使用量与 APIKeyName。

## 2. 设计范围
- 数据模型：新增 TaskUsage 表结构
- Repository：新增 TaskUsageRepository
- Service：新增 TaskUsageService
- 模型调用流程：在 ProxyChatModel.Generate 中记录用量

## 3. 核心设计思路
1. 模型生成成功后，如果返回 ResponseMeta.Usage，则构造 TaskUsage 记录
2. 从上下文获取 taskID，并使用当前模型的 APIKeyName
3. 通过 TaskUsageService 调用 Repository 持久化
4. 记录失败时仅输出日志，不影响主流程

## 4. 数据模型
TaskUsage 字段：
- task_id（索引，必填）
- api_key_name（索引，必填）
- prompt_tokens
- completion_tokens
- total_tokens
- cached_tokens
- reasoning_tokens
- created_at

## 5. 关键流程
```
模型生成成功 -> 提取 ResponseMeta.Usage -> 获取 taskID -> 记录 TaskUsage -> 返回结果
```

## 6. 关键约束
- 日志使用 klog.V(6) 且中文描述
- 仅在 Usage 不为空时写入
- taskID 缺失时不中断主流程
