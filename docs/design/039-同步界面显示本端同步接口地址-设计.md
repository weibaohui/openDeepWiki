# 039-同步界面显示本端同步接口地址-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |

## 一、需求概述

### 1.1 背景
当前 openDeepWiki 的数据同步功能需要用户手动输入对端服务器地址,当用户想要将当前实例作为目标服务器时,需要手动复制并输入完整的同步接口地址。这个过程繁琐且容易出错。

### 1.2 目标
在同步配置页面显示当前服务器的同步接口地址,并提供一键复制功能,方便用户快速复制本端同步地址。

### 1.3 验收标准
1. 打开同步配置页面,能看到"本端同步接口地址"区域
2. 地址格式正确:`协议://域名:端口/api/sync`
3. 点击"复制"按钮后,地址被正确复制到剪贴板
4. 复制后显示"复制成功"提示
5. 地址在移动端正确显示(支持滚动或截断)
6. 在不同环境(dev/prod)下,协议和端口正确反映

## 二、技术设计

### 2.1 地址获取方式

**采用前端自行拼接方式**

原因:
- 无需后端新增 API 接口
- 实现简单直接
- 自动适应当前访问环境

**实现代码:**
```typescript
const buildSyncUrl = () => {
  const protocol = window.location.protocol; // http: 或 https:
  const host = window.location.hostname;
  const port = window.location.port;
  const syncUrl = `${protocol}//${host}${port ? ':' + port : ''}/api/sync`;
  return syncUrl;
}
```

### 2.2 端口省略规则

根据需求文档,端口省略规则:
- 端口为 `80`(http)或 `443`(https)时,省略端口号
- 端口为 `8080`、`3000` 等非标准端口时,显示端口号

**实现代码:**
```typescript
const buildSyncUrl = () => {
  const protocol = window.location.protocol; // http: 或 https:
  const host = window.location.hostname;
  const port = window.location.port;
  
  // 端口省略逻辑
  const shouldShowPort = 
    (protocol === 'http:' && port !== '80') ||
    (protocol === 'https:' && port !== '443') ||
    port;
  
  const portDisplay = shouldShowPort ? (port ? `:${port}` : '') : '';
  
  return `${protocol}//${host}${portDisplay}/api/sync`;
}
```

### 2.3 UI 组件设计

**组件位置:** 在 `Sync.tsx` 的目标服务器配置区域之前添加

**组件结构:**
```tsx
<div className="sync-url-display">
  <div className="sync-url-header">
    <span className="label">本端同步接口地址</span>
    <span className="description">
      可将此地址粘贴到其他实例的"目标服务器"输入框中,将本端数据同步到该实例。
    </span>
  </div>
  <div className="sync-url-content">
    <div className="sync-url-value">
      <code>{syncUrl}</code>
    </div>
    <div className="sync-url-actions">
      <Button
        onClick={handleCopy}
        icon={<CopyOutlined />}
      >
        复制
      </Button>
    </div>
  </div>
  {copySuccess && (
    <div className="copy-success">复制成功</div>
  )}
</div>
```

### 2.4 状态管理

```typescript
const [copySuccess, setCopySuccess] = useState(false);

const handleCopy = async () => {
  try {
    await navigator.clipboard.writeText(syncUrl);
    setCopySuccess(true);
    setTimeout(() => setCopySuccess(false), 1500);
    messageApi.success('复制成功');
  } catch (err) {
    messageApi.error('复制失败,请手动复制');
  }
};
```

### 2.5 响应式设计

**移动端:**
- 地址过长时自动截断并显示省略号
- 支持横向滚动查看完整地址
- 复制按钮始终可见

**桌面端:**
- 地址完整展示
- 复制按钮提供 hover 提示:"点击复制同步地址"

**CSS 样式:**
```css
.sync-url-display {
  margin-bottom: 16px;
  padding: 12px;
  background: var(--ant-color-bg-container);
  border: 1px solid var(--ant-color-border);
  border-radius: 8px;
}

.sync-url-header {
  margin-bottom: 8px;
}

.sync-url-header .label {
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
}

.sync-url-header .description {
  font-size: 12px;
  color: var(--ant-color-text-secondary);
  display: block;
}

.sync-url-content {
  display: flex;
  gap: 8px;
  align-items: center;
}

.sync-url-value {
  flex: 1;
  overflow: hidden;
}

.sync-url-value code {
  display: block;
  padding: 8px 12px;
  background: var(--ant-color-bg-spotlight);
  border: 1px solid var(--ant-color-border);
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  word-break: break-all;
  white-space: nowrap;
  overflow-x: auto;
}

.copy-success {
  margin-top: 8px;
  color: var(--ant-color-success);
  font-size: 12px;
}

/* 响应式适配 */
@media (max-width: 768px) {
  .sync-url-content {
    flex-direction: column;
    align-items: stretch;
  }

  .sync-url-actions {
    width: 100%;
  }

  .sync-url-actions button {
    width: 100%;
  }
}
```

## 三、实现步骤

### 3.1 修改文件
- 文件路径: `frontend/src/pages/Sync.tsx`
- 修改类型: 功能新增

### 3.2 具体步骤

1. **导入所需组件**
   - 添加 `CopyOutlined` 图标导入

2. **构建同步地址函数**
   - 在组件内添加 `buildSyncUrl` 函数
   - 实现端口省略逻辑

3. **添加状态管理**
   - 添加 `copySuccess` 状态
   - 添加 `syncUrl` 计算值

4. **实现复制功能**
   - 添加 `handleCopy` 函数
   - 实现复制成功/失败提示

5. **添加 UI 组件**
   - 在目标服务器输入框之前添加地址展示组件
   - 添加相应的 CSS 样式

6. **添加国际化文本**
   - 在 i18n 文件中添加相关翻译

## 四、国际化支持

需要添加的翻译文本:

```json
{
  "sync": {
    "local_sync_url": "本端同步接口地址",
    "local_sync_url_desc": "可将此地址粘贴到其他实例的"目标服务器"输入框中,将本端数据同步到该实例。",
    "copy": "复制",
    "copy_success": "复制成功",
    "copy_failed": "复制失败,请手动复制"
  }
}
```

## 五、测试要点

### 5.1 功能测试
1. 验证地址格式正确性
2. 验证复制功能正常工作
3. 验证复制成功提示显示正确
4. 验证端口省略规则

### 5.2 兼容性测试
1. HTTP 环境测试
2. HTTPS 环境测试
3. 标准端口(80/443)测试
4. 非标准端口(8080/3000)测试
5. localhost 环境测试

### 5.3 响应式测试
1. 移动端显示测试
2. 桌面端显示测试
3. 地址过长时的滚动测试

## 六、安全考虑

### 6.1 潜在风险
- 无安全风险,仅展示当前服务器地址

### 6.2 防护措施
- 无需特殊防护措施

## 七、性能考虑

### 7.1 性能影响
- 无性能影响,仅在页面渲染时计算一次地址

### 7.2 优化建议
- 使用 `useMemo` 缓存地址计算结果
