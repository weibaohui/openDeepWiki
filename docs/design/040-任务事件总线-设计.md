# 040-任务事件总线-设计.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |
| AI | 2026-02-13 | 增加文档推送/拉取事件设计 |
| AI | 2026-02-15 | 增加文档同步事件汇总信息字段 |
| AI | 2026-02-15 | 增加文档同步事件落库设计 |

## 一、需求概述

### 1.1 背景
任务创建逻辑集中在 TaskService 内部，随着任务类型扩展，外部模块需要统一发布任务事件并复用同一处理流程。

### 1.2 目标
提供进程内任务事件总线，支持广播与订阅，固定订阅服务接收事件并驱动任务创建。

### 1.3 验收标准
1. 任务事件总线支持订阅、取消订阅、事件发布
2. 四类事件均可被订阅服务处理并触发任务创建
3. 支持其他模块调用事件发布入口
4. 关键流程均输出中文日志

## 二、技术设计

### 2.1 总体方案

采用进程内事件总线，提供：

- 事件类型枚举与事件载荷结构
- 订阅者注册与注销机制
- 发布事件的广播分发与错误聚合
- 固定订阅服务统一处理任务事件

### 2.2 事件类型与载荷

```text
TaskEventType:
  DocWrite
  TocWrite
  TitleRewrite
  UserRequest
```

```text
DocEventType:
  DocPulled
  DocPushed
```

事件结构：

```text
TaskEvent:
  Type
  RepositoryID
  Title
  SortOrder
  RunAfter
  DocID
  WriterName
```

```text
DocEvent:
  Type
  RepositoryID
  DocID
  TargetServer
  Success
```

```text
SyncEvent:
  ID
  EventType
  RepositoryID
  DocID
  TargetServer
  Success
  CreatedAt
```

### 2.3 事件总线接口

提供接口：

- Subscribe(type, handler) 返回取消订阅函数
- Publish(ctx, event) 广播给所有订阅者

设计要点：

- 使用读写锁保护订阅表
- 发布时复制订阅列表，避免长时间持锁
- 订阅者错误不影响其他订阅者执行，最终返回聚合错误

### 2.4 固定订阅服务

固定订阅服务负责：

- 在服务初始化时注册各类型事件处理器
- 根据事件类型调用对应任务创建逻辑
- 输出中文日志，记录事件处理结果

### 2.5 处理流程

```text
发布事件
  ↓
事件总线广播
  ↓
固定订阅服务接收
  ↓
调用 TaskService 创建任务
  ↓
输出日志并返回结果
```

```text
同步推送/拉取完成
  ↓
发布 DocPushed / DocPulled 事件
  ↓
文档事件订阅服务记录日志并持久化同步事件
```

### 2.6 代码结构建议

```text
backend/internal/service/eventbus/
  bus.go          # 事件总线实现
  task_event.go   # 事件类型与结构
  subscriber.go   # 固定订阅服务
```
