
```mermaid
flowchart TB
    subgraph 外部系统["外部系统集成"]
        GitRepo[("Git 代码仓库<br/>GitHub/GitLab/Gitee")]
        WebHook[Webhook 通知]
    end

    subgraph 接入层["接入层 (Access Layer)"]
        API[RESTful API Gateway]
        Auth[认证与授权]
        HookReceiver[Webhook 接收器]
    end

    subgraph 核心引擎层["核心引擎层 (Core Engine)"]
        direction TB
        
        subgraph 仓库管理["代码仓库管理 (Repo Manager)"]
            RepoImport[仓库导入服务]
            BranchMgr[分支管理器<br/>主分支/多分支]
            CommitTracker[Commit 追踪器<br/>Commit ID + Tag 版本]
            DiffAnalyzer[代码差异分析器]
        end
        
        subgraph 智能解析["智能解析引擎 (Parser)"]
            ASTParser[AST 语法解析器<br/>代码结构分析]
            DBAnalyzer[数据库解析器<br/>表结构/关系]
            APIAnalyzer[API 解析器<br/>接口/中间件/认证]
            FEAnalyzer[前端解析器<br/>React/Vue组件树]
            CodeContext[代码上下文存储<br/>行号/引用关系]
        end
        
        subgraph AI编排["AI 编排中心 (AI Orchestrator)"]
            PreProcessor[预处理引擎<br/>生成基础预览]
            DynamicPlanner[动态目录规划器<br/>AI生成目录结构]
            TaskGenerator[任务生成器<br/>拆解文档任务]
            UserCustom[用户自定义章节<br/>命题式调查]
            TemplateLib[模板库<br/>编写格式约束]
        end
        
        subgraph 文档工厂["文档工厂 (Doc Factory)"]
            DocWriter[文档撰写引擎<br/>AI生成内容]
            MermaidGen[Mermaid 图表生成器]
            CitationMgr[引用管理器<br/>代码行号关联]
            Translator[多语言翻译器<br/>中/英/日/韩/俄]
            Editor[编辑校对器]
        end
        
        subgraph 增量处理["增量处理器 (Delta Processor)"]
            ChangeDetector[变更检测器]
            IncrementalUpdater[增量更新器<br/>基于Commit对比]
            VersionDiff[版本差异记录]
        end
    end

    subgraph 数据存储层["数据存储层 (Storage)"]
        RepoMeta[("仓库元数据<br/>分支/Commit/Tag")]
        DocContent[("文档内容库<br/>多语言版本")]
        VectorDB[("向量数据库<br/>文档向量化")]
        CodeIndex[("代码索引<br/>AST结构/上下文")]
        TaskQueue[("任务队列<br/>文档生成任务")]
    end

    subgraph 服务层["服务层 (Service Layer)"]
        DocService[文档服务]
        QAService[智能问答服务]
        BadgeService[徽标服务<br/>README嵌入]
        NotifyService[通知服务]
    end

    subgraph 展示层["展示层 (Presentation)"]
        WebUI[Web 管理界面]
        DocViewer[文档阅读器<br/>多语言切换/代码跳转]
        ChatUI[智能问答界面]
        MermaidEditor[Mermaid 编辑器]
        ExportModule[导出模块<br/>闪卡/PPT大纲]
    end

    %% 流程连接
    GitRepo -->|导入| RepoImport
    WebHook -->|触发| HookReceiver
    
    RepoImport --> BranchMgr
    BranchMgr --> CommitTracker
    CommitTracker --> ASTParser
    
    ASTParser --> CodeContext
    DBAnalyzer --> CodeContext
    APIAnalyzer --> CodeContext
    FEAnalyzer --> CodeContext
    
    CodeContext --> PreProcessor
    PreProcessor --> DynamicPlanner
    DynamicPlanner --> UserCustom
    UserCustom --> TaskGenerator
    TemplateLib --> TaskGenerator
    
    TaskGenerator --> DocWriter
    DocWriter --> MermaidGen
    DocWriter --> CitationMgr
    DocWriter --> Translator
    DocWriter --> Editor
    
    CommitTracker --> ChangeDetector
    ChangeDetector --> IncrementalUpdater
    IncrementalUpdater --> DocWriter
    
    DocWriter --> DocContent
    DocContent --> VectorDB
    CodeContext --> CodeIndex
    TaskGenerator --> TaskQueue
    
    DocContent --> DocService
    VectorDB --> QAService
    CommitTracker --> BadgeService
    
    DocService --> DocViewer
    QAService --> ChatUI
    MermaidGen --> MermaidEditor
    BadgeService --> GitRepo
    
    %% 样式定义
    classDef external fill:#e1f5ff,stroke:#01579b
    classDef core fill:#fff3e0,stroke:#e65100
    classDef ai fill:#f3e5f5,stroke:#4a148c
    classDef storage fill:#e8f5e9,stroke:#1b5e20
    classDef service fill:#fff8e1,stroke:#f57f17
    classDef ui fill:#fce4ec,stroke:#880e4f
    
    class GitRepo,WebHook external
    class RepoImport,BranchMgr,CommitTracker,DiffAnalyzer,ASTParser,DBAnalyzer,APIAnalyzer,FEAnalyzer,CodeContext core
    class PreProcessor,DynamicPlanner,TaskGenerator,UserCustom,TemplateLib,DocWriter,MermaidGen,CitationMgr,Translator,Editor,ChangeDetector,IncrementalUpdater,VersionDiff ai
    class RepoMeta,DocContent,VectorDB,CodeIndex,TaskQueue storage
    class DocService,QAService,BadgeService,NotifyService service
    class WebUI,DocViewer,ChatUI,MermaidEditor,ExportModule ui
```

## 功能模块详细拆解

### 1. 代码仓库管理模块 (Repository Management)
| 子模块           | 核心功能                                            |
| ---------------- | --------------------------------------------------- |
| **多分支管理**   | 支持主分支/特性分支选择，明确文档生成基准分支       |
| **版本追踪**     | 记录 Commit ID、关联 Tag 版本号，确保文档版本可追溯 |
| **Webhook 触发** | 接收代码推送事件，自动触发文档更新流程              |
| **增量对比**     | 对比上次解析的 Commit，识别变更文件范围             |

### 2. 智能解析引擎 (Intelligent Parser)
| 解析器类型       | 功能描述                                         |
| ---------------- | ------------------------------------------------ |
| **AST 解析器**   | 代码语法树分析，提取函数、类、接口定义及调用关系 |
| **数据库解析器** | 识别表结构、主外键、字段类型、索引、注释         |
| **API 解析器**   | 提取接口路由、请求/响应格式、中间件链、认证要求  |
| **前端解析器**   | 分析 React/Vue 组件树、Props 传递、状态管理      |
| **上下文存储**   | 记录代码行号范围、文件路径，为后续引用提供坐标   |

### 3. AI 编排中心 (AI Orchestration)
**动态生成流程（替代固定模板）：**
```
预处理阶段 → AI 分析代码结构 → 生成建议目录 → 用户自定义补充 → 生成任务列表 → 执行撰写
```

| 组件           | 职责                                               |
| -------------- | -------------------------------------------------- |
| **预处理引擎** | 快速扫描生成基础预览（代码规模、技术栈、目录结构） |
| **动态规划器** | 基于预览信息，AI 决策文档应包含的章节体系          |
| **用户自定义** | 允许用户像"命题调查"一样添加关注维度               |
| **任务生成器** | 将目录拆解为可执行的文档编制任务                   |
| **模板库**     | 提供编写格式约束，防止 AI 过度发散                 |

### 4. 文档工厂 (Document Factory)
| 功能             | 说明                                                    |
| ---------------- | ------------------------------------------------------- |
| **Mermaid 图表** | 自动生成并支持编辑流程图、架构图、时序图                |
| **引用溯源**     | 大模型生成结论时标注来源代码行号，支持点击跳转          |
| **多语言翻译**   | 中文为基准，自动翻译为英/日/韩/俄等，按用户语言偏好展示 |
| **编辑校对**     | 对 AI 生成内容进行事实性校验和格式规范检查              |

### 5. 增量处理器 (Delta Processor)
- **变更检测**：对比新旧 Commit 差异
- **精准更新**：仅对变更涉及的文档章节进行增量重写
- **版本历史**：保留文档变更历史，支持版本对比

### 6. 智能问答器 (Q&A Bot)
| 功能模块         | 实现细节                            |
| ---------------- | ----------------------------------- |
| **向量化存储**   | 文档内容 Embedding 存入向量数据库   |
| **对话交互**     | 基于 RAG 的聊天框，支持上下文理解   |
| **高频问题挖掘** | 分析用户提问热点，自动生成 FAQ 章节 |
| **文档压缩**     | 提取仓库极简摘要作为大模型上下文    |

### 7. 徽标服务 (Badge Service)
三种嵌入形式供 README 使用：
1. **基础版**：纯图标超链接
2. **状态版**：显示文档解析状态（已完成/进行中）
3. **进度版**：显示落后主分支的 Commit 数量

### 8. 导出与扩展 (Export & Extension)
- 闪卡生成（便于记忆核心概念）
- PPT 大纲导出
- 自定义格式扩展接口

## 数据流转架构

```mermaid
sequenceDiagram
    participant User as 用户
    participant Git as 代码仓库
    participant System as OpenDeepWiki
    participant AI as AI引擎
    participant DB as 存储层

    User->>System: 导入仓库（选择分支）
    System->>Git: 克隆代码（记录Commit ID）
    System->>System: AST解析+专项解析（DB/API/FE）
    System->>AI: 预处理请求（基础结构）
    AI-->>System: 返回预览分析
    System->>User: 展示建议目录结构
    User->>System: 确认/调整目录+自定义章节
    System->>AI: 生成文档任务列表
    loop 并行执行任务
        AI->>System: 撰写章节（带代码引用）
        System->>DB: 存储文档+向量索引
    end
    System->>DB: 生成多语言版本
    User->>System: 查看文档（点击代码引用）
    System->>Git: 跳转指定Commit的代码行
    Git->>Webhook: 代码推送事件
    Webhook->>System: 触发增量更新
    System->>System: 对比Commit差异
    System->>AI: 仅更新变更相关章节
```
  