# 001-仓库分支与版本管理-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-06 | 补充仓库克隆元数据记录需求 |

## 一、需求背景

当前 openDeepWiki 系统仅支持对仓库的单一分支（默认为克隆时的默认分支）进行解读和文档生成。但在实际应用中，存在以下问题：

1. **无法区分分支**：不清楚文档是基于哪个分支生成的
2. **无法追溯版本**：没有 commit ID 和 tag 信息，无法确定文档对应的代码版本
3. **无法管理多分支**：不同分支可能对应不同的功能和架构，需要分别解读
4. **无法增量更新**：代码变更后需要重新生成所有文档，效率低下

## 二、需求目标

实现对导入仓库的分支管理和版本追踪，确保：

1. 支持管理仓库的多个分支
2. 明确标注文档生成的目标分支
3. 记录对应的 commit ID 和 tag 版本信息
4. 支持基于 commit 的增量文档生成

## 三、核心功能点

### 3.1 分支管理

#### 3.1.1 分支列表获取
- 自动获取仓库的所有分支列表
- 显示分支名称、commit ID、最后更新时间
- 标注默认分支（main/master）

#### 3.1.2 分支选择与切换
- 在创建/编辑仓库时选择目标分支
- 支持为同一个仓库添加多个分支配置
- 每个分支对应独立的任务和文档集

#### 3.1.3 分支状态显示
- 显示每个分支的克隆状态
- 显示每个分支的文档生成状态
- 显示每个分支的最后更新时间和 commit ID

### 3.2 版本追踪

#### 3.2.1 Commit ID 记录
- 记录文档生成时的 commit ID
- 支持查看文档对应的 commit 信息
- 支持通过 commit ID 查看文档历史版本

#### 3.2.2 Tag 版本关联
- 自动识别和关联 tag 版本号
- 支持手动关联 tag 到文档
- 在文档中显示 tag 版本信息

#### 3.2.3 版本对比
- 支持对比不同版本间的文档差异
- 支持查看 commit 变更历史
- 支持回退到历史版本

#### 3.2.4 仓库克隆元数据记录
- 记录克隆后的当前分支与 commit ID
- 记录仓库大小（MB），用于展示与容量评估

### 3.3 增量文档生成

#### 3.3.1 Commit 变更检测
- 定期检测分支的 commit 变更
- 记录新的 commit ID
- 对比新旧 commit 的文件变更

#### 3.3.2 增量分析
- 仅分析变更的文件
- 基于变更类型触发对应的任务
- 生成增量文档或更新文档

#### 3.3.3 文档版本管理
- 为每个文档记录版本历史
- 支持查看文档的变更历史
- 支持恢复文档到历史版本

## 四、数据模型设计

### 4.1 修改现有表

#### 4.1.1 repositories 表扩展

新增字段：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| current_branch | string | 当前选中的分支 | 默认为仓库默认分支 |
| default_branch | string | 仓库默认分支 | 克隆时自动获取 |
| clone_branch | string | 克隆后的当前分支 | 克隆完成后写入 |
| clone_commit_id | string | 克隆后的 commit ID | 使用短 SHA |
| size_mb | float | 仓库大小（MB） | 以 1024*1024 计算 |

### 4.2 新增表

#### 4.2.1 repository_branches 表

仓库分支信息表，用于记录仓库的所有分支及其状态。

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| repository_id | uint | 关联仓库ID | 外键 |
| branch_name | string | 分支名称 | 如 main, develop, feature/xxx |
| is_default | bool | 是否默认分支 | |
| commit_id | string | 当前commit ID | 40位SHA |
| commit_message | string | commit 信息 | |
| commit_author | string | 作者 | |
| commit_time | datetime | commit 时间 | |
| status | string | 状态 | pending, cloning, ready, analyzing, completed, error |
| error_msg | string | 错误信息 | |
| last_analyzed_at | datetime | 最后分析时间 | |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |

#### 4.2.2 document_versions 表

文档版本历史表，用于记录每个文档的版本变更。

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| document_id | uint | 关联文档ID | 外键 |
| commit_id | string | commit ID | 40位SHA |
| tag_name | string | tag 名称 | 可选 |
| version | int | 版本号 | 递增 |
| content | text | 文档内容 | Markdown |
| change_summary | string | 变更摘要 | |
| created_at | datetime | 创建时间 | |

#### 4.2.3 branch_commits 表

分支提交记录表，用于跟踪分支的提交历史。

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| repository_branch_id | uint | 关联分支ID | 外键 |
| commit_id | string | commit ID | 40位SHA |
| commit_message | string | commit 信息 | |
| commit_author | string | 作者 | |
| commit_time | datetime | commit 时间 | |
| analyzed | bool | 是否已分析 | |
| created_at | datetime | 创建时间 | |

#### 4.2.4 task_commits 表

任务与提交的关联表，记录任务是基于哪个 commit 生成的。

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| task_id | uint | 关联任务ID | 外键 |
| commit_id | string | commit ID | 40位SHA |
| tag_name | string | tag 名称 | 可选 |
| created_at | datetime | 创建时间 | |

### 4.3 修改现有表

#### 4.3.1 tasks 表扩展

新增字段：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| repository_branch_id | uint | 关联分支ID | 外键，替换 repository_id |
| commit_id | string | commit ID | 40位SHA |
| tag_name | string | tag 名称 | 可选 |

#### 4.3.2 documents 表扩展

新增字段：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| repository_branch_id | uint | 关联分支ID | 外键，替换 repository_id |
| commit_id | string | commit ID | 40位SHA |
| tag_name | string | tag 名称 | 可选 |

## 五、API 设计

### 5.1 分支管理 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/repositories/:id/branches | 获取仓库的所有分支 |
| POST | /api/repositories/:id/branches | 添加新分支到仓库 |
| PUT | /api/repositories/:id/branches/:branchId | 更新分支信息（如切换） |
| DELETE | /api/repositories/:id/branches/:branchId | 删除分支及其相关数据 |
| POST | /api/repositories/:id/branches/:branchId/sync | 同步分支（拉取最新 commit） |

### 5.2 任务管理 API（扩展）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/repositories/:id/branches/:branchId/tasks | 获取指定分支的任务列表 |
| POST | /api/repositories/:id/branches/:branchId/tasks/run-all | 执行指定分支的所有任务 |
| GET | /api/branches/:branchId/tasks/:id | 获取任务详情 |
| POST | /api/branches/:branchId/tasks/:id/run | 执行指定分支的单个任务 |
| POST | /api/branches/:branchId/tasks/:id/reset | 重置任务 |
| POST | /api/branches/:branchId/tasks/:id/force-reset | 强制重置任务 |

### 5.3 文档管理 API（扩展）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/repositories/:id/branches/:branchId/documents | 获取指定分支的文档列表 |
| GET | /api/branches/:branchId/documents/:id | 获取文档内容 |
| PUT | /api/branches/:branchId/documents/:id | 更新文档内容 |
| GET | /api/branches/:branchId/documents/:id/versions | 获取文档版本历史 |
| GET | /api/branches/:branchId/documents/:id/versions/:versionId | 获取指定版本文档 |
| POST | /api/branches/:branchId/documents/:id/versions/:versionId/restore | 恢复到指定版本 |
| GET | /api/branches/:branchId/documents/:id/diff | 对比文档版本差异 |

### 5.4 Commit 管理 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/repositories/:id/branches/:branchId/commits | 获取分支的提交历史 |
| GET | /api/branches/:branchId/commits/:commitId | 获取指定 commit 详情 |
| POST | /api/branches/:branchId/commits/sync | 同步分支的最新 commit |

### 5.5 增量分析 API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/branches/:branchId/analyze-incremental | 基于最新 commit 增量分析 |
| POST | /api/branches/:branchId/analyze-commit/:commitId | 分析指定 commit |

## 六、前端界面设计

### 6.1 仓库详情页改造

#### 6.1.1 分支选择器
- 在页面顶部添加分支选择下拉框
- 显示当前分支名称和 commit 信息
- 支持快速切换分支
- 显示分支状态标识

#### 6.1.2 分支列表
- 添加"分支管理"标签页
- 显示所有分支列表
- 每个分支显示：名称、commit ID、状态、最后分析时间
- 支持添加、删除、同步分支操作

### 6.2 任务列表页改造

#### 6.2.1 任务信息展示
- 在任务卡片中显示对应的 commit ID
- 显示 commit 的简短信息（前8位 SHA）
- 支持 hover 显示完整 commit 信息

#### 6.2.2 任务执行
- 明确显示任务是基于哪个 commit 执行的
- 执行时显示 commit ID 和 tag 信息

### 6.3 文档阅读页改造

#### 6.3.1 文档头部信息
- 显示文档对应的分支名称
- 显示 commit ID 和 commit 时间
- 显示关联的 tag（如果有）
- 提供"查看历史版本"按钮

#### 6.3.2 版本历史
- 点击"查看历史版本"显示版本历史列表
- 显示每个版本的：commit ID、tag、变更时间、变更摘要
- 支持查看指定版本的内容
- 支持恢复到历史版本

#### 6.3.3 版本对比
- 提供"对比版本"功能
- 显示两个版本之间的差异
- 使用 diff 视图展示变更

### 6.4 新增页面

#### 6.4.1 分支详情页 (`/repo/:id/branch/:branchId`)
- 显示分支的基本信息
- 显示分支的 commit 历史
- 显示分支的任务列表
- 显示分支的文档列表

## 七、交互流程

### 7.1 添加新分支流程

```
仓库详情页 → 点击"添加分支" → 选择已有分支或输入分支名
              ↓
         系统克隆分支 → 记录分支信息 → 创建对应任务
              ↓
         返回分支列表 → 显示新分支状态
```

### 7.2 切换分支流程

```
仓库详情页 → 点击分支选择器 → 选择其他分支
              ↓
         加载分支数据 → 显示分支的任务和文档
              ↓
         用户可执行任务或查看文档
```

### 7.3 增量分析流程

```
分支详情页 → 检测到新 commit → 点击"增量分析"
              ↓
         对比新旧 commit → 识别变更文件 → 触发相关任务
              ↓
         生成/更新文档 → 记录版本历史
              ↓
         显示增量分析结果
```

### 7.4 查看文档历史流程

```
文档阅读页 → 点击"查看历史版本" → 显示版本列表
              ↓
         选择某个版本 → 显示该版本内容
              ↓
         可选择"恢复到此版本"
```

## 八、技术实现要点

### 8.1 Git 操作扩展

需要扩展现有的 Git 操作包，支持以下功能：

- 获取仓库所有分支列表
- 获取分支详细信息（commit ID、message、author、time）
- 切换到指定分支
- 拉取指定分支最新代码
- 获取 commit 历史记录
- 获取 tag 列表和关联的 commit
- 对比两个 commit 的文件变更

### 8.2 分支克隆策略

- **首次克隆**：克隆整个仓库到 `repos/{repo-name}/` 目录
- **后续分支**：使用 `git fetch origin {branch}:refs/remotes/origin/{branch}` 获取分支
- **分支切换**：使用 `git checkout {branch}` 切换分支
- **分支更新**：使用 `git pull origin {branch}` 更新分支

### 8.3 增量分析策略

1. **commit 变更检测**：
   - 定时任务（每5分钟）检查分支是否有新 commit
   - 对比当前 commit_id 与远程最新 commit_id

2. **变更文件识别**：
   - 使用 `git diff --name-only old_commit new_commit` 获取变更文件
   - 根据文件类型判断需要触发的任务类型

3. **任务触发规则**：
   - README/配置文件变更 → 触发 overview 任务
   - 项目结构变更 → 触发 architecture 任务
   - API/接口文件变更 → 触发 api 任务
   - 业务逻辑文件变更 → 触发 business-flow 任务
   - 部署配置文件变更 → 触发 deployment 任务

4. **文档版本管理**：
   - 每次生成文档时，保存到 `document_versions` 表
   - 使用 commit_id 关联版本
   - 支持 git-like 的版本对比

### 8.4 数据一致性

- **事务处理**：涉及多表操作时使用事务保证数据一致性
- **级联删除**：删除分支时级联删除相关的任务、文档、commit 记录
- **外键约束**：设置适当的外键约束防止数据不一致

### 8.5 性能优化

- **commit 历史**：仅存储最近 N 条 commit（如最近100条）
- **文档版本**：仅存储最近 M 个版本（如最近10个版本）
- **索引优化**：在常用查询字段上建立索引（repository_id, branch_id, commit_id）
- **缓存机制**：缓存分支列表、commit 历史等不常变化的数据

## 九、非功能性需求

### 9.1 性能要求

- 分支列表查询响应时间 < 200ms
- commit 历史查询响应时间 < 500ms
- 文档版本查询响应时间 < 300ms

### 9.2 可靠性要求

- 分支克隆失败时有明确的错误提示
- commit 记录不丢失
- 文档版本可追溯

### 9.3 可用性要求

- 分支切换操作简单直观
- 版本历史查看清晰易懂
- 错误信息友好明确

### 9.4 兼容性要求

- 保持向后兼容现有 API
- 现有仓库数据平滑迁移
- 不影响现有功能使用

## 十、迁移方案

### 10.1 数据迁移

对于已存在的仓库数据：

1. **迁移 repositories 表**：
   - 设置 `default_branch` 为 "main"（通过 git 命令获取）
   - 设置 `current_branch` 为默认分支

2. **创建 repository_branches 记录**：
   - 为每个仓库创建默认分支记录
   - 获取当前 commit ID 并记录
   - 将现有 tasks 和 documents 关联到该分支

3. **关联 tasks 表**：
   - 添加 `repository_branch_id` 字段
   - 将现有任务的 `repository_branch_id` 设置为创建的默认分支 ID
   - 添加 `commit_id` 字段（可为空）

4. **关联 documents 表**：
   - 添加 `repository_branch_id` 字段
   - 将现有文档的 `repository_branch_id` 设置为创建的默认分支 ID
   - 添加 `commit_id` 和 `tag_name` 字段（可为空）

5. **初始化 document_versions**：
   - 为现有文档创建初始版本记录
   - 设置 version = 1

### 10.2 兼容性处理

- **API 兼容**：
  - 保留旧的 API 路径（如 `/api/repositories/:id/tasks`）
  - 旧 API 默认使用当前分支的数据
  - 新 API 使用明确的 branch_id 参数

- **前端兼容**：
  - 旧页面默认使用当前分支
  - 逐步引导用户使用新的分支管理功能

## 十一、开发计划

### 11.1 开发阶段

**阶段一：数据模型和基础设施**
- 设计并创建新表
- 扩展现有表结构
- 实现数据迁移脚本

**阶段二：Git 操作扩展**
- 实现分支相关 Git 操作
- 实现 commit 和 tag 获取
- 实现 commit 对比功能

**阶段三：后端 API 开发**
- 实现分支管理 API
- 扩展任务和文档 API
- 实现 commit 管理 API
- 实现增量分析 API

**阶段四：前端界面开发**
- 改造仓库详情页
- 添加分支选择器
- 改造任务列表页
- 改造文档阅读页
- 新增分支详情页

**阶段五：增量分析功能**
- 实现 commit 变更检测
- 实现变更文件识别
- 实现任务触发规则
- 实现文档版本管理

**阶段六：测试和优化**
- 功能测试
- 性能测试
- 数据一致性测试
- 迁移脚本测试
- 性能优化

### 11.2 估时

| 阶段 | 预估工时 |
|------|---------|
| 阶段一：数据模型和基础设施 | 4-6 小时 |
| 阶段二：Git 操作扩展 | 4-6 小时 |
| 阶段三：后端 API 开发 | 8-12 小时 |
| 阶段四：前端界面开发 | 12-16 小时 |
| 阶段五：增量分析功能 | 8-10 小时 |
| 阶段六：测试和优化 | 6-8 小时 |
| **合计** | **42-58 小时** |

## 十二、验收标准

### 12.1 功能验收

- [ ] 能够成功添加和管理多个分支
- [ ] 能够正确显示每个分支的 commit 信息
- [ ] 能够记录文档对应的 commit ID 和 tag
- [ ] 能够查看文档的版本历史
- [ ] 能够恢复文档到历史版本
- [ ] 能够对比文档版本差异
- [ ] 增量分析能够正确识别变更文件
- [ ] 增量分析能够触发对应的任务

### 12.2 性能验收

- [ ] 分支列表查询响应时间 < 200ms
- [ ] commit 历史查询响应时间 < 500ms
- [ ] 文档版本查询响应时间 < 300ms

### 12.3 兼容性验收

- [ ] 现有仓库数据成功迁移
- [ ] 旧 API 正常工作
- [ ] 现有功能不受影响

### 12.4 代码质量验收

- [ ] 代码符合项目开发规范
- [ ] 关键逻辑有详细注释
- [ ] 通过代码审查
- [ ] 单元测试覆盖率 > 80%

## 十三、风险评估

### 13.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| Git 操作性能问题 | 高 | 中 | 优化 Git 命令，使用缓存机制 |
| 增量分析识别不准确 | 中 | 中 | 完善文件类型判断规则，支持手动指定 |
| 数据迁移失败 | 高 | 低 | 做好数据备份，分步骤迁移验证 |

### 13.2 业务风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 用户理解成本增加 | 中 | 高 | 提供清晰的使用文档和引导 |
| 操作复杂度增加 | 中 | 中 | 简化交互流程，提供智能默认值 |

## 十四、后续优化方向

- [ ] 支持手动指定 commit 进行分析
- [ ] 支持批量分支管理
- [ ] 支持分支间文档对比
- [ ] 支持 PR/MR 的文档生成
- [ ] 支持自动定时分析
- [ ] 支持文档变更通知
- [ ] 支持 Webhook 集成
