# 002-文档模板管理-需求.md

## 1. 背景（Why）

当前系统的任务类型和文档模板被硬编码在代码中，无法灵活调整。用户无法自定义文档目录结构和文档类型，限制了系统的扩展性和可配置性。为了支持不同场景的文档生成需求，需要将这些固定的模板数据化，并提供管理界面。

## 2. 目标（What，必须可验证）

- [ ] 将硬编码的任务类型和文档模板数据化，存储到数据库
- [ ] 提供文档模板管理的界面，支持增删改查操作
- [ ] 支持两级目录结构：一级目录对应章节，二级目录对应文档标题
- [ ] 提供默认模板，包含现有的 5 种文档类型
- [ ] 文档模板用于指导后续的文档分析生成工作
- [ ] 支持自定义文档类型和目录结构

## 3. 非目标（Explicitly Out of Scope）

- [ ] 修改现有已生成的文档内容
- [ ] 文档内容的自动调整（仅调整模板）
- [ ] 文档模板的版本管理
- [ ] 文档模板的导入导出

## 4. 使用场景 / 用户路径

### 场景 1：查看默认文档模板

```
用户登录系统 → 点击设置 → 点击"文档模板管理"
                ↓
            查看默认的 5 种文档类型及其目录结构
```

### 场景 2：新增自定义文档类型

```
用户进入文档模板管理 → 点击"新增类型"
                ↓
            输入类型标识、标题、文件名、排序序号
                ↓
            配置该类型的章节和文档目录
                ↓
            保存配置
```

### 场景 3：调整文档目录结构

```
用户进入文档模板管理 → 选择某个文档类型
                ↓
            编辑其章节和文档目录
                ↓
            添加/修改/删除章节和文档
                ↓
            保存配置
```

### 场景 4：基于模板生成文档

```
系统创建新仓库 → 读取文档模板配置
                ↓
            根据模板生成对应任务
                ↓
            任务执行时根据模板生成文档目录和文件
```

## 5. 功能需求清单（Checklist）

### 5.1 数据模型

- [ ] 创建文档模板表（document_templates）
- [ ] 创建模板章节表（template_chapters）
- [ ] 创建模板文档表（template_documents）
- [ ] 建立表之间的关联关系

### 5.2 数据迁移

- [ ] 将现有的 5 种硬编码任务类型迁移到数据库
- [ ] 初始化默认模板数据

### 5.3 后端 API

- [ ] 获取文档模板列表
- [ ] 获取文档模板详情（包含章节和文档）
- [ ] 创建文档模板
- [ ] 更新文档模板
- [ ] 删除文档模板
- [ ] 批量创建章节和文档
- [ ] 更新章节和文档
- [ ] 删除章节和文档

### 5.4 前端界面

- [ ] 文档模板管理页面
- [ ] 文档模板列表展示
- [ ] 文档模板编辑表单
- [ ] 章节和文档的树形展示
- [ ] 拖拽排序功能（章节和文档）
- [ ] 新增/编辑/删除章节和文档的对话框

### 5.5 业务逻辑

- [ ] 仓库创建时根据模板生成任务
- [ ] 任务执行时根据模板生成文档目录
- [ ] 文档生成时遵循模板的目录结构
- [ ] 模板变更不影响已有仓库

## 6. 约束条件

### 6.1 技术约束

- 必须使用现有的数据库（SQLite / MySQL）
- 必须兼容现有的任务系统
- 必须保持向后兼容性

### 6.2 架构约束

- 文档模板与任务类型解耦
- 支持灵活的目录层级（至少两级）
- 不影响现有 API 的兼容性

### 6.3 安全约束

- 模板管理接口需要鉴权
- 防止恶意删除默认模板
- 模板变更需要记录审计日志

### 6.4 性能约束

- 模板列表查询响应时间 < 200ms
- 模板详情查询响应时间 < 500ms
- 任务创建时模板加载不影响性能

## 7. 可修改 / 不可修改项

- ❌ 不可修改：
  - 现有数据库表结构（新增表除外）
  - 现有 API 的行为（新增 API 除外）
  - 现有任务的状态流转逻辑

- ✅ 可调整：
  - UI 交互方式（需保持友好性）
  - 模板的具体字段（需保持最小必要）
  - 前端组件实现方式

## 8. 接口与数据约定

### 8.1 数据模型

#### document_templates 表

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| type | string | 类型标识 | 如 overview, architecture |
| title | string | 类型标题 | 如"项目概览" |
| filename | string | 文件名 | 如 overview.md |
| sort_order | int | 排序序号 | |
| is_default | bool | 是否默认模板 | |
| is_system | bool | 是否系统模板 | 系统模板不可删除 |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |

#### template_chapters 表

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| template_id | uint | 关联模板ID | 外键 |
| parent_id | uint | 父章节ID | NULL 表示根章节 |
| title | string | 章节标题 | 如"项目简介" |
| level | int | 层级 | 1 表示一级目录，2 表示二级目录 |
| sort_order | int | 排序序号 | |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |

#### template_documents 表

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | uint | 主键 | |
| template_id | uint | 关联模板ID | 外键 |
| chapter_id | uint | 关联章节ID | 外键 |
| title | string | 文档标题 | |
| content_prompt | text | 内容生成提示 | 用于指导 LLM 生成内容 |
| sort_order | int | 排序序号 | |
| created_at | datetime | 创建时间 | |
| updated_at | datetime | 更新时间 | |

### 8.2 API 定义

#### 获取文档模板列表

```
GET /api/document-templates
```

响应：
```json
{
  "data": [
    {
      "id": 1,
      "type": "overview",
      "title": "项目概览",
      "filename": "overview.md",
      "sort_order": 1,
      "is_default": true,
      "is_system": true
    }
  ]
}
```

#### 获取文档模板详情

```
GET /api/document-templates/:id
```

响应：
```json
{
  "data": {
    "id": 1,
    "type": "overview",
    "title": "项目概览",
    "filename": "overview.md",
    "sort_order": 1,
    "chapters": [
      {
        "id": 1,
        "parent_id": null,
        "title": "项目简介",
        "level": 1,
        "sort_order": 1,
        "documents": [
          {
            "id": 1,
            "title": "项目背景",
            "content_prompt": "描述项目的背景和目标",
            "sort_order": 1
          }
        ]
      }
    ]
  }
}
```

#### 创建文档模板

```
POST /api/document-templates
```

请求：
```json
{
  "type": "custom-type",
  "title": "自定义类型",
  "filename": "custom.md",
  "sort_order": 6,
  "is_default": false
}
```

#### 更新文档模板

```
PUT /api/document-templates/:id
```

请求：
```json
{
  "title": "更新后的标题",
  "sort_order": 6
}
```

#### 删除文档模板

```
DELETE /api/document-templates/:id
```

#### 批量保存章节和文档

```
POST /api/document-templates/:id/chapters
```

请求：
```json
{
  "chapters": [
    {
      "id": null,
      "parent_id": null,
      "title": "新章节",
      "level": 1,
      "sort_order": 1,
      "documents": [
        {
          "id": null,
          "title": "新文档",
          "content_prompt": "提示内容",
          "sort_order": 1
        }
      ]
    }
  ]
}
```

### 8.3 错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 无权限（如删除系统模板） |
| 404 | 模板不存在 |
| 409 | 类型标识已存在 |
| 500 | 服务器错误 |

## 9. 验收标准（Acceptance Criteria）

- 如果用户访问文档模板管理页面，则应看到默认的 5 种文档类型
- 如果用户新增自定义文档类型，则应能成功创建并保存到数据库
- 如果用户编辑文档模板的章节和文档，则应能实时预览并保存
- 如果用户删除自定义文档类型，则应成功删除且不影响系统模板
- 如果系统创建新仓库，则应根据文档模板生成对应的任务
- 如果任务执行完成，则应根据文档模板生成相应的文档目录结构
- 如果用户尝试删除系统模板，则应返回错误提示

## 10. 风险与已知不确定点

### 10.1 已知风险

- 模板变更后，已创建的仓库任务如何处理
  - 处理方式：已创建的仓库保持原有任务，新创建的仓库使用新模板
- 如何保证模板变更不影响现有文档
  - 处理方式：模板仅用于新任务，不修改已生成的文档
- 模板的复杂性如何控制
  - 处理方式：限制层级为两级，提供树形界面简化操作

### 10.2 需要人工确认的点

- 默认模板的具体章节和文档内容
- 自定义模板的数量限制
- 模板的删除权限规则

### 10.3 遇到不确定性时的处理方式

- 如果用户提出复杂的模板需求，则应先评估可行性再实现
- 如果模板数据迁移出现问题，则应保留硬编码作为降级方案
- 如果性能不达标，则应考虑缓存优化
