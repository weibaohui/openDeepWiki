# 003-智能模板分配器-需求.md

## 1. 背景（Why）

当前系统使用硬编码的 TaskTypes 定义分析任务，缺乏灵活性。002-文档模板管理已实现模板数据化，但仓库创建时仍需要手动指定或默认使用固定模板。为了提升用户体验，系统应能根据仓库的代码特征自动识别项目类型（如 SpringBoot、前端、Python 等），并分配合适的文档模板。

## 2. 目标（What，必须可验证）

- [ ] **仓库模型扩展**：在 Repository 表中增加 template_id 字段，记录分配的文档模板ID
- [ ] **模板分配器模块**：实现独立的模板分配器（Template Assigner），负责分析仓库特征并分配合适模板
- [ ] **自动识别能力**：根据仓库目录结构和关键文件，识别项目类型（SpringBoot、前端、Go、Python、通用等）
- [ ] **默认回退机制**：当无法识别或识别置信度低时，自动分配通用模板（general）
- [ ] **分析时机**：在仓库克隆完成后、生成任务列表前，执行模板分配
- [ ] **前端展示**：在仓库详情页显示已分配的模板信息

## 3. 非目标（Explicitly Out of Scope）

- [ ] 不支持用户手动修改已分配的模板（后续版本支持）
- [ ] 不支持模板分配结果的持久化历史记录
- [ ] 不支持基于代码内容的深度分析（如 AST 解析），仅基于目录结构和文件名
- [ ] 不支持多模板混合分配

## 4. 使用场景 / 用户路径

### 场景 1：创建 SpringBoot 仓库自动分配

```
用户输入 GitHub 地址：https://github.com/example/spring-boot-demo
                ↓
系统克隆仓库到本地
                ↓
模板分配器扫描仓库：
  - 发现 pom.xml / build.gradle
  - 发现 src/main/java 目录结构
  - 发现 @SpringBootApplication 注解文件
                ↓
判定为 SpringBoot 项目，分配 springboot 模板
                ↓
将 template_id = 2 记录到 repository 表
                ↓
基于 springboot 模板的章节结构生成任务列表
```

### 场景 2：创建前端仓库自动分配

```
用户输入 GitHub 地址：https://github.com/example/react-app
                ↓
系统克隆仓库到本地
                ↓
模板分配器扫描仓库：
  - 发现 package.json
  - 发现 src/components 目录
  - 发现 .tsx/.jsx 文件
                ↓
判定为前端项目，分配 frontend 模板
                ↓
将 template_id = 3 记录到 repository 表
```

### 场景 3：无法识别的项目

```
用户输入 GitHub 地址：https://github.com/example/unknown-project
                ↓
系统克隆仓库到本地
                ↓
模板分配器扫描仓库：
  - 未发现明确的技术栈特征
                ↓
判定置信度低，分配通用模板（general）
                ↓
将 template_id = 1 记录到 repository 表
```

## 5. 功能需求清单（Checklist）

### 5.1 数据模型

- [ ] 修改 Repository 表，新增字段：
  - `template_id` uint, 外键关联 document_templates.id, 默认 1（通用模板）
- [ ] 建立 Repository 与 DocumentTemplate 的关联关系

### 5.2 模板分配器核心（Template Assigner）

- [ ] 设计分配器接口：`Assigner interface { Assign(repoPath string) (uint, error) }`
- [ ] 实现基于规则的分配器（RuleBasedAssigner）
- [ ] 定义项目类型识别规则：

| 项目类型 | 识别规则（满足其一即可） |
|----------|------------------------|
| SpringBoot | 存在 pom.xml 且包含 spring-boot；或存在 build.gradle 且包含 spring-boot；或存在 @SpringBootApplication 注解的文件 |
| 前端 | 存在 package.json 且包含 react/vue/angular；或存在 src/components 目录；或存在大量 .tsx/.jsx/.vue 文件 |
| Go | 存在 go.mod 文件 |
| Python | 存在 requirements.txt 或 pyproject.toml 或 setup.py |
| 通用 | 不满足以上任何规则 |

- [ ] 实现文件扫描器，安全地读取仓库目录结构和关键文件
- [ ] 实现规则引擎，按优先级匹配规则
- [ ] 确保分配器执行时间 < 1 秒（中小规模仓库）

### 5.3 集成到仓库创建流程

- [ ] 在 RepositoryService.Create 流程中，克隆完成后调用模板分配器
- [ ] 将分配结果写入 repository.template_id
- [ ] 修改任务生成逻辑，基于分配的模板生成任务列表，替代原有的 TaskTypes

### 5.4 后端 API 调整

- [ ] Repository 列表/详情 API 返回 template_id 和关联的模板基本信息
- [ ] 保持向后兼容，template_id 默认为 1（通用模板）

### 5.5 前端展示

- [ ] 在仓库详情页显示已分配的模板名称
- [ ] 在仓库列表项上显示模板类型标签（可选）

## 6. 约束条件

### 6.1 技术约束

- 必须使用 Go 语言实现
- 文件扫描必须限制目录深度（建议最大 3 层），避免性能问题
- 单个文件读取大小限制（建议最大 100KB），防止大文件导致内存问题
- 不得执行任何外部命令或脚本，纯静态文件分析

### 6.2 架构约束

- 模板分配器必须是独立的包/模块，与 RepositoryService 解耦
- 分配器不得直接操作数据库，只返回模板 ID
- 规则定义必须与代码分离，便于后续扩展

### 6.3 安全约束

- 文件扫描必须限制在仓库目录内，禁止越界访问
- 禁止解析执行任何可执行文件或脚本
- 敏感信息（如 .env 文件）不得读取或记录日志

### 6.4 性能约束

- 分配器执行时间 < 1 秒（对于标准规模的仓库）
- 内存占用 < 50MB

## 7. 可修改 / 不可修改项

- ❌ 不可修改：
  - 现有数据库表结构（除新增 template_id 字段外）
  - 现有 API 的 URL 路径和基本响应结构
  - 模板分配器的接口定义（一旦确定）
  
- ✅ 可调整：
  - 项目类型识别规则的具体实现
  - 规则匹配的优先级顺序
  - 文件扫描的深度和大小限制参数

## 8. 接口与数据约定

### 8.1 Repository 模型更新

```go
type Repository struct {
    ID           uint       `json:"id" gorm:"primaryKey"`
    Name         string     `json:"name" gorm:"size:255;not null"`
    URL          string     `json:"url" gorm:"size:500;not null"`
    LocalPath    string     `json:"local_path" gorm:"size:500"`
    Description  string     `json:"description" gorm:"size:1000"`
    Status       string     `json:"status" gorm:"size:50;default:pending"`
    ErrorMsg     string     `json:"error_msg" gorm:"size:1000"`
    TemplateID   uint       `json:"template_id" gorm:"default:1;index"` // 新增：关联的文档模板ID
    CreatedAt    time.Time  `json:"created_at"`
    UpdatedAt    time.Time  `json:"updated_at"`
    Tasks        []Task     `json:"tasks,omitempty" gorm:"foreignKey:RepositoryID"`
    Documents    []Document `json:"documents,omitempty" gorm:"foreignKey:RepositoryID"`
    Template     DocumentTemplate `json:"template,omitempty" gorm:"foreignKey:TemplateID"` // 可选的预加载关联
}
```

### 8.2 模板分配器接口

```go
package assigner

// Result 分配结果
type Result struct {
    TemplateID uint    // 分配的模板ID
    Confidence float64 // 置信度 (0-1)
    Reason     string  // 分配原因说明
}

// Assigner 模板分配器接口
type Assigner interface {
    // Assign 分析仓库路径，返回分配的模板ID
    // repoPath: 仓库本地路径
    Assign(repoPath string) (*Result, error)
}

// RuleBasedAssigner 基于规则的分配器实现
type RuleBasedAssigner struct {
    rules []Rule
}

// Rule 识别规则定义
type Rule struct {
    TemplateKey string   // 模板标识，如 "springboot", "frontend"
    TemplateID  uint     // 模板ID
    Priority    int      // 优先级，数字越小优先级越高
    Conditions  []Condition // 匹配条件（OR 关系，满足其一即可）
}

// Condition 匹配条件
type Condition struct {
    Type     string // 条件类型：file_exists, file_contains, dir_exists, file_pattern
    Pattern  string // 匹配模式
    Content  string // 对于 file_contains 类型，需要匹配的内容
    MaxDepth int    // 最大搜索深度
}
```

### 8.3 API 响应更新

**Repository 详情响应示例：**

```json
{
  "id": 1,
  "name": "spring-boot-demo",
  "url": "https://github.com/example/spring-boot-demo",
  "status": "ready",
  "template_id": 2,
  "template": {
    "id": 2,
    "key": "springboot",
    "name": "SpringBoot 模板"
  },
  "created_at": "2026-01-29T10:00:00Z",
  "updated_at": "2026-01-29T10:00:00Z"
}
```

## 9. 验收标准（Acceptance Criteria）

- 如果用户创建了一个包含 `pom.xml` 且内容为 `<artifactId>spring-boot-starter-parent</artifactId>` 的仓库，则系统分配 springboot 模板，template_id = 2
- 如果用户创建了一个包含 `package.json` 且依赖中有 `react` 的仓库，则系统分配 frontend 模板，template_id = 3
- 如果用户创建了一个无法识别的仓库（如只有 README.md），则系统分配通用模板，template_id = 1
- 如果分配器执行时间超过 1 秒，则记录警告日志但仍返回结果
- 如果仓库路径不存在或无法访问，则返回错误

## 10. 风险与已知不确定点

| 风险 | 影响 | 对策 |
|------|------|------|
| 识别规则不完善导致误判 | 中 | 初期规则保持简单，优先使用通用模板兜底；后续根据实际数据优化规则 |
| 大型仓库文件扫描性能问题 | 中 | 限制目录深度和文件大小；使用并发扫描；增加超时机制 |
| 混合技术栈项目（如前后端分离在同一个仓库） | 低 | 按优先级匹配第一个满足的规则；后续版本支持多模板 |
| 用户可能期望手动选择模板 | 低 | 本版本不支持，后续版本增加用户确认/修改功能 |

## 11. 依赖关系

- 依赖 002-文档模板管理（模板数据化）已完成
- 需在仓库创建流程中集成，需了解 RepositoryService 的实现

## 12. 实现提示

### 12.1 文件扫描安全注意事项

```go
// 安全检查示例
func isPathSafe(basePath, targetPath string) bool {
    absBase, _ := filepath.Abs(basePath)
    absTarget, _ := filepath.Abs(targetPath)
    return strings.HasPrefix(absTarget, absBase)
}
```

### 12.2 规则配置建议

规则建议定义为常量或配置文件，便于后续调整：

```go
var DefaultRules = []Rule{
    {
        TemplateKey: "springboot",
        TemplateID:  2,
        Priority:    1,
        Conditions: []Condition{
            {Type: "file_contains", Pattern: "pom.xml", Content: "spring-boot"},
            {Type: "file_contains", Pattern: "build.gradle", Content: "spring-boot"},
        },
    },
    // ... 其他规则
}
```

### 12.3 调试支持

分配器应支持调试模式，输出详细的匹配过程日志：

```
[TemplateAssigner] Scanning: /data/repos/example
[TemplateAssigner] Found file: pom.xml
[TemplateAssigner] Checking rule: springboot
[TemplateAssigner] Condition matched: pom.xml contains "spring-boot"
[TemplateAssigner] Assigned template: springboot (ID=2), Confidence=0.95
```
