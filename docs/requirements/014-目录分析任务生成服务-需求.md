# 014-目录分析任务生成服务-需求

## 1. 需求背景

在现有的仓库文档生成流程中，任务类型是固定的 5 种（overview/architecture/api/business-flow/deployment）。为了更智能地根据仓库实际情况生成分析任务，需要一个能够利用 AI 分析代码目录结构，并动态决定需要哪些分析任务的服务。

## 2. 需求目标

创建一个目录分析任务生成服务，实现以下功能：
1. 读取本地仓库代码目录结构
2. 利用 ADK Agent 进行智能分析
3. 根据分析结果动态生成任务列表
4. 将任务保存到数据库

## 3. 功能需求

### 3.1 输入参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| localPath | string | 本地仓库路径 |
| repoID | uint | 仓库 ID |

### 3.2 输出结果

返回结构化的 JSON，包含需要创建的任务列表：

```json
{
  "tasks": [
    {
      "type": "overview",
      "title": "项目概览",
      "sort_order": 1
    },
    {
      "type": "architecture",
      "title": "架构分析",
      "sort_order": 2
    }
  ],
  "analysis_summary": "项目是一个 Go Web 服务，使用 Gin 框架..."
}
```

### 3.3 任务创建逻辑

根据 AI 分析结果，循环遍历返回的任务列表，按以下方式创建任务：

```go
task := &model.Task{
    RepositoryID: repo.ID,
    Type:         taskType.Type,
    Title:        taskType.Title,
    Status:       string(statemachine.TaskStatusPending),
    SortOrder:    taskType.SortOrder,
}
if err := s.taskRepo.Create(task); err != nil {
    return nil, fmt.Errorf("创建任务失败: %w", err)
}
```

### 3.4 动态任务类型决策

Agent 根据代码分析结果动态决定需要哪些任务类型，考虑因素：
- 项目类型（Go/Java/Python/前端等）
- 技术栈特征
- 项目规模
- 关键文件存在性（如 Dockerfile、API 定义等）

## 4. 技术需求

### 4.1 服务结构

参考 `einodoc/workflow.go` 的实现模式：

```
backend/internal/service/directoryanalyzer/
├── service.go      # 主服务实现
├── workflow.go     # ADK Workflow 实现
├── types.go        # 类型定义
└── agent.go        # Agent 创建相关
```

### 4.2 Agent 定义

创建新的 Agent YAML 文件：
- 路径：`backend/agents/task_generator.yaml`
- 功能：分析代码目录，输出任务列表 JSON
- Tools：`list_dir`, `read_file`, `search_files`

### 4.3 核心组件

| 组件 | 职责 |
|------|------|
| DirectoryAnalyzerService | 对外提供分析入口 |
| TaskGeneratorWorkflow | 使用 SequentialAgent 执行分析 |
| TaskGeneratorAgent | 定义在 YAML 中，负责代码分析 |

### 4.4 Workflow 流程

```
[输入: localPath] 
    -> [TaskGeneratorAgent: 分析目录结构] 
    -> [输出: JSON 任务列表]
    -> [Service: 遍历创建 Task]
```

## 5. 接口定义

### 5.1 Service 接口

```go
// DirectoryAnalyzerService 目录分析任务生成服务
type DirectoryAnalyzerService struct {
    cfg         *config.Config
    workflow    *TaskGeneratorWorkflow
    taskRepo    repository.TaskRepository
}

// NewDirectoryAnalyzerService 创建服务实例
func NewDirectoryAnalyzerService(
    cfg *config.Config,
    taskRepo repository.TaskRepository,
) (*DirectoryAnalyzerService, error)

// AnalyzeAndCreateTasks 分析目录并创建任务
// localPath: 本地仓库路径
// repo: 仓库模型（包含 ID 等信息）
// 返回: 创建的任务列表或错误
func (s *DirectoryAnalyzerService) AnalyzeAndCreateTasks(
    ctx context.Context,
    localPath string,
    repo *model.Repository,
) ([]*model.Task, error)
```

### 5.2 输出类型定义

```go
// TaskGenerationResult 任务生成结果
type TaskGenerationResult struct {
    Tasks           []GeneratedTask `json:"tasks"`
    AnalysisSummary string          `json:"analysis_summary"`
}

// GeneratedTask 生成的任务定义
type GeneratedTask struct {
    Type      string `json:"type"`
    Title     string `json:"title"`
    SortOrder int    `json:"sort_order"`
}
```

## 6. Agent Prompt 要求

Agent 的 instruction 需要包含：
1. 分析仓库目录结构的指令
2. 识别项目类型和技术栈
3. 根据分析结果决定需要哪些任务类型
4. 输出格式必须是有效的 JSON

示例输出：
```json
{
  "tasks": [
    {"type": "overview", "title": "项目概览", "sort_order": 1},
    {"type": "architecture", "title": "架构分析", "sort_order": 2},
    {"type": "api", "title": "核心接口", "sort_order": 3}
  ],
  "analysis_summary": "这是一个 Go Web 项目，使用 Gin 框架..."
}
```

## 7. 错误处理

- 目录不存在：返回明确的错误信息
- Agent 执行失败：记录日志并返回错误
- JSON 解析失败：返回解析错误
- 数据库创建失败：返回包装后的错误

## 8. 验收标准

- [ ] 能够成功分析本地仓库目录
- [ ] 根据分析结果动态生成任务列表
- [ ] 任务成功保存到数据库
- [ ] 支持常见的项目类型识别（Go/Java/Python/前端等）
- [ ] 代码符合后端 Service 规范
- [ ] 包含必要的日志输出（klog.V(6)）

## 9. 相关文档

- [后端 Service 规范](../开发规范/后端规范/04-Service规范.md)
- [einodoc/workflow.go](../../backend/internal/service/einodoc/workflow.go)
- [ADK Agents 管理模块设计](../design/013-ADKAgents管理模块-设计.md)
