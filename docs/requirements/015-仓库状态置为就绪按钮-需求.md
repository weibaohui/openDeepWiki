# 015-仓库状态置为就绪按钮-需求

## 1. 背景

在仓库详情页面，有时需要将仓库的状态直接置为就绪状态（ready），例如在克隆失败后手动修复问题后，或者调试过程中需要快速恢复仓库状态。当前系统没有提供这样的功能，需要用户手动重新克隆或者通过其他方式恢复状态，操作不便。

## 2. 目标（必须可验证）

- [ ] 在仓库详情页面（RepoDetail.tsx）添加一个按钮，用于将仓库状态直接置为就绪
- [ ] 后端提供 API 端点 `POST /api/repositories/:id/set-ready` 来执行此操作
- [ ] 前端添加对应的 API 调用方法
- [ ] 操作成功后显示成功提示消息
- [ ] 按钮仅在特定状态下可见/可用（可调试或特定状态）

## 3. 非目标

- 不修改仓库状态机的状态流转逻辑
- 不涉及仓库克隆、任务执行等其他功能
- 不改变现有的状态转换规则

## 4. 使用场景 / 用户路径

1. 用户在仓库详情页面查看仓库信息
2. 如果仓库处于某些状态（如错误状态），用户可以点击"置为就绪"按钮
3. 系统调用后端 API 将仓库状态设置为 ready
4. 页面刷新显示最新的仓库状态
5. 用户可以继续执行其他操作，如运行任务

## 5. 功能需求清单

- [ ] 后端 Service 层添加 `SetReady(repoID uint)` 方法
- [ ] 后端 Handler 层添加 `SetReady(c *gin.Context)` 方法
- [ ] 后端路由添加 `POST /api/repositories/:id/set-ready` 端点
- [ ] 前端 API 服务添加 `setReady(id: number)` 方法
- [ ] 前端 RepoDetail 页面添加"置为就绪"按钮
- [ ] 前端添加对应的事件处理函数
- [ ] 前端添加中英文国际化文本
- [ ] 添加操作成功/失败的提示消息

## 6. 约束条件

### 技术约束
- 后端使用 Gin 框架，遵循现有的 Handler 和 Service 规范
- 前端使用 React + Ant Design，遵循现有的组件规范
- 使用现有的状态机状态定义 `statemachine.RepoStatusReady`

### 架构约束
- 遵循前后端分离架构
- 遵循现有的代码组织结构
- 遵循现有的 API 命名规范

### 安全约束
- 需要验证仓库 ID 的有效性
- 状态设置前需要检查当前状态是否允许（根据状态机规则）

### 性能约束
- API 响应时间应小于 500ms

## 7. 可修改 / 不可修改项

- ❌ 不可修改：
  - 仓库状态机的状态流转规则
  - 现有的 API 端点
  - 现有的数据模型

- ✅ 可调整：
  - 按钮的显示条件和位置
  - 提示消息的具体文案
  - 按钮的图标样式

## 8. 接口与数据约定

### API 定义

**端点**: `POST /api/repositories/:id/set-ready`

**请求参数**:
- `id` (路径参数): 仓库 ID

**响应**:
```json
{
  "message": "仓库状态已设置为就绪"
}
```

**错误响应**:
```json
{
  "error": "错误信息"
}
```

### 状态定义

使用现有的 `statemachine.RepoStatusReady`，值为 "ready"

## 9. 验收标准

- 如果用户点击"置为就绪"按钮，则仓库状态应更新为 "ready"
- 如果仓库 ID 无效，则应返回 400 错误
- 如果仓库不存在，则应返回 404 错误
- 如果操作成功，则前端应显示成功提示消息
- 如果操作失败，则前端应显示错误提示消息
- 按钮点击后应自动刷新页面数据

## 10. 风险与已知不确定点

- **风险**: 直接设置状态为 ready 可能会导致状态不一致（如本地代码不存在）
- **处理**: 在代码中添加日志记录，建议在文档中注明此功能仅用于调试或特殊场景
- **不确定点**: 按钮应该在哪些状态下可见？
- **处理**: 暂时在所有状态下都可见，后续可以根据实际需求调整

## 11. 安全自检

- 是否存在越权访问风险？否，当前系统无权限控制，所有用户可操作
- 是否存在输入未校验问题？是，需要校验仓库 ID 格式
- 是否存在敏感信息泄露风险？否
- 是否引入了不必要的高权限操作？否

## 12. 实现计划

### 后端实现
1. 在 `backend/internal/service/repository.go` 添加 `SetReady(repoID uint)` 方法
2. 在 `backend/internal/handler/repository.go` 添加 `SetReady(c *gin.Context)` 方法
3. 在 `backend/internal/router/router.go` 添加路由

### 前端实现
1. 在 `frontend/src/services/api.ts` 添加 `setReady(id: number)` 方法
2. 在 `frontend/src/pages/RepoDetail.tsx` 添加按钮和事件处理函数
3. 在 `frontend/src/i18n/locales/zh-CN.json` 和 `en-US.json` 添加国际化文本

### 测试
1. 启动后端服务，测试 API 端点
2. 启动前端服务，测试按钮功能
3. 测试各种边界情况（无效 ID、不存在的仓库等）
