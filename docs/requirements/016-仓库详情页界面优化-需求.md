# 016-仓库详情页界面优化-需求

## 1. 背景

当前仓库详情页面顶部已经有多个功能按钮（导出文档、目录分析、置为就绪、重新分析），导致界面拥挤，用户体验不佳。同时，任务列表中缺少删除单个任务的功能，用户无法删除不需要的任务。

## 2. 目标（必须可验证）

- [ ] 在仓库详情页面右侧添加一个抽屉（Drawer），将功能按钮分类存放
- [ ] 功能按钮按照功能分类：文档管理、任务管理、状态管理等
- [ ] 在任务列表的每一项上添加删除按钮，允许用户删除单个任务
- [ ] 后端提供删除任务的 API 端点
- [ ] 删除任务时需要确认，避免误操作

## 3. 非目标

- 不改变现有按钮的功能逻辑
- 不影响任务列表的其他操作（运行、重置、查看文档）
- 不改变现有的 API 端点（除了新增的删除任务端点）

## 4. 使用场景 / 用户路径

### 场景 1：使用抽屉中的功能按钮
1. 用户进入仓库详情页面
2. 点击右上角的"更多操作"按钮
3. 右侧弹出抽屉，显示分类后的功能按钮
4. 用户在抽屉中点击需要的功能按钮（如"导出文档"）
5. 抽屉自动关闭，执行相应操作

### 场景 2：删除单个任务
1. 用户在任务列表中查看任务
2. 将鼠标悬停在某个任务上（或在移动端点击任务）
3. 显示删除按钮
4. 点击删除按钮
5. 弹出确认对话框
6. 确认后，任务被删除
7. 页面刷新，显示更新后的任务列表

## 5. 功能需求清单

### 5.1 抽屉功能
- [ ] 在 RepoDetail 组件中添加一个抽屉组件
- [ ] 添加一个触发抽屉的按钮（如"更多操作"按钮）
- [ ] 将现有按钮分类放入抽屉：
  - 文档管理：导出文档
  - 任务管理：目录分析、重新分析
  - 状态管理：置为就绪
- [ ] 抽屉支持关闭按钮和点击遮罩关闭
- [ ] 抽屉点击按钮后自动关闭

### 5.2 任务删除功能
- [ ] 后端添加删除任务的 API 端点 `DELETE /api/tasks/:id`
- [ ] 后端 Service 层添加删除任务的方法
- [ ] 后端 Handler 层添加删除任务的 handler
- [ ] 前端 API 服务添加删除任务的方法
- [ ] 前端在任务列表项上添加删除按钮
- [ ] 前端添加删除确认对话框
- [ ] 前端添加删除成功/失败的提示消息
- [ ] 前端添加中英文国际化文本

### 5.3 用户体验优化
- [ ] 抽屉使用合适的图标（如 MoreOutlined）
- [ ] 删除按钮使用 DeleteOutlined 图标
- [ ] 删除确认对话框使用 Modal.confirm
- [ ] 抽屉和删除按钮在移动端也能正常使用

## 6. 约束条件

### 技术约束
- 后端使用 Gin 框架，遵循现有的 Handler 和 Service 规范
- 前端使用 React + Ant Design，使用 Drawer 组件
- 前端使用 Modal.confirm 进行删除确认

### 架构约束
- 遵循前后端分离架构
- 遵循现有的代码组织结构
- 遵循现有的 API 命名规范

### 安全约束
- 删除任务前需要验证任务 ID 的有效性
- 删除任务需要验证任务是否存在
- 删除任务需要确认，避免误操作

### 性能约束
- 抽屉打开/关闭时间应小于 200ms
- 任务删除 API 响应时间应小于 500ms

## 7. 可修改 / 不可修改项

- ❌ 不可修改：
  - 现有按钮的功能逻辑
  - 任务列表的其他操作（运行、重置、查看文档）
  - 现有的 API 端点（除了新增的删除任务端点）

- ✅ 可调整：
  - 按钮的分类方式
  - 抽屉的触发按钮位置和图标
  - 删除按钮的显示方式（悬停显示或始终显示）
  - 抽屉的宽度和样式

## 8. 接口与数据约定

### API 定义

#### 删除任务 API

**端点**: `DELETE /api/tasks/:id`

**请求参数**:
- `id` (路径参数): 任务 ID

**响应**:
```json
{
  "message": "任务已删除"
}
```

**错误响应**:
```json
{
  "error": "错误信息"
}
```

### 按钮分类方案

#### 文档管理
- 导出文档

#### 任务管理
- 目录分析
- 重新分析

#### 状态管理
- 置为就绪

## 9. 验收标准

### 抽屉功能验收标准
- 如果用户点击"更多操作"按钮，则右侧弹出抽屉
- 如果抽屉中显示分类后的功能按钮，则分类正确
- 如果用户点击抽屉中的按钮，则执行相应操作并关闭抽屉
- 如果用户点击抽屉的关闭按钮或遮罩，则抽屉关闭
- 如果抽屉打开/关闭时间小于 200ms，则性能达标

### 任务删除功能验收标准
- 如果任务列表项上有删除按钮，则删除按钮显示正确
- 如果用户点击删除按钮，则弹出确认对话框
- 如果用户确认删除，则任务被删除
- 如果任务 ID 无效，则应返回 400 错误
- 如果任务不存在，则应返回 404 错误
- 如果删除成功，则前端应显示成功提示消息
- 如果删除失败，则前端应显示错误提示消息
- 如果删除成功，则页面应自动刷新显示更新后的任务列表

## 10. 风险与已知不确定点

### 风险
- **风险**: 删除任务可能导致文档数据不一致
- **处理**: 前端添加确认对话框，后端记录日志，建议用户谨慎操作

- **风险**: 抽屉的使用可能增加用户操作步骤
- **处理**: 使用直观的图标和清晰的分类，提供良好的用户体验

### 不确定点
- **不确定点**: 删除按钮应该在什么条件下显示？
- **处理**: 始终显示删除按钮（对于所有任务），或者可以只在特定状态下显示（如 pending、failed 状态）

- **不确定点**: 抽屉的触发按钮应该放在什么位置？
- **处理**: 放在右上角，与语言切换、主题切换等按钮并列

## 11. 安全自检

- 是否存在越权访问风险？否，当前系统无权限控制，所有用户可操作
- 是否存在输入未校验问题？是，需要校验任务 ID 格式
- 是否存在敏感信息泄露风险？否
- 是否引入了不必要的高权限操作？否
- 是否存在数据一致性问题？是，删除任务可能导致文档数据不一致

## 12. 实现计划

### 后端实现
1. 在 `backend/internal/service/task.go` 添加 `Delete(id uint)` 方法
2. 在 `backend/internal/handler/task.go` 添加 `Delete(c *gin.Context)` 方法
3. 在 `backend/internal/router/router.go` 添加路由 `DELETE /api/tasks/:id`

### 前端实现
1. 在 `frontend/src/services/api.ts` 添加 `deleteTask(id: number)` 方法
2. 在 `frontend/src/pages/RepoDetail.tsx` 中：
   - 导入 Drawer、Modal 组件和 MoreOutlined、DeleteOutlined 图标
   - 添加抽屉的状态管理（visible 状态）
   - 添加打开/关闭抽屉的处理函数
   - 创建抽屉组件，将现有按钮分类存放
   - 添加"更多操作"按钮，触发抽屉
   - 移除原有按钮（或保留部分常用按钮）
   - 在任务列表项上添加删除按钮
   - 添加删除任务的事件处理函数
3. 在 `frontend/src/i18n/locales/zh-CN.json` 和 `en-US.json` 添加国际化文本

### 测试
1. 测试抽屉的打开/关闭功能
2. 测试抽屉中各按钮的功能
3. 测试任务删除功能
4. 测试删除确认对话框
5. 测试各种边界情况（无效 ID、不存在的任务等）
