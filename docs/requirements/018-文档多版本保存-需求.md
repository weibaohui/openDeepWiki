# 018-文档多版本保存-需求.md

## 1. 背景（Why）

当前系统在任务生成文档时，会直接保存一份文档记录。若同一任务多次生成，历史版本会被覆盖或丢失，无法回溯不同生成结果。需要支持文档版本保存能力，确保每次生成都能保留版本，并将最新版本作为默认展示。

---

## 2. 目标（What，必须可验证）

- [ ] 文档表新增版本字段，用于记录同一任务的版本号
- [ ] 同一任务多次生成文档时，每次生成保存为独立版本
- [ ] 系统能够标记并查询默认版本（最新版本）
- [ ] 仓库文档列表接口默认返回最新版本
- [ ] 历史版本数据不被覆盖或丢失

---

## 3. 非目标（Explicitly Out of Scope）

- [ ] 不实现版本内容对比功能
- [ ] 不实现版本回滚功能
- [ ] 不新增前端版本管理交互

---

## 4. 核心概念定义

### 4.1 文档版本

同一任务生成的文档序列，按生成顺序递增，版本号从 1 开始。

### 4.2 默认版本

最新生成的版本，作为默认展示版本。

---

## 5. 功能需求清单（Checklist）

### 5.1 数据库设计

- [ ] 文档表新增 `version` 字段（int，默认 1）
- [ ] 文档表新增 `is_latest` 字段（bool，默认 true）
- [ ] 同一任务仅允许一个 `is_latest = true` 的记录

### 5.2 文档生成与保存

- [ ] 每次生成时为该任务计算新的版本号
- [ ] 保存新版本前，将旧版本的 `is_latest` 置为 false
- [ ] 新版本保存后将 `is_latest` 标记为 true

### 5.3 查询行为

- [ ] 仓库文档列表默认只返回 `is_latest = true` 的记录
- [ ] 单文档读取接口保持不变（按 ID 获取）

### 5.4 任务重置与删除

- [ ] 任务重置不删除历史版本
- [ ] 任务删除仍删除关联的所有版本

---

## 6. 数据结构

### 6.1 数据库表结构

```sql
ALTER TABLE documents ADD COLUMN version INTEGER DEFAULT 1;
ALTER TABLE documents ADD COLUMN is_latest BOOLEAN DEFAULT 1;
CREATE INDEX idx_documents_task_id_version ON documents(task_id, version);
CREATE INDEX idx_documents_repo_latest ON documents(repository_id, is_latest);
```

### 6.2 Go 模型定义

```go
// internal/model/models.go
type Document struct {
    ID           uint      `json:"id" gorm:"primaryKey"`
    RepositoryID uint      `json:"repository_id" gorm:"index`
    TaskID       uint      `json:"task_id" gorm:"index"`
    Title        string    `json:"title" gorm:"size:255`
    Filename     string    `json:"filename" gorm:"size:255`
    Content      string    `json:"content" gorm:"type:text"`
    SortOrder    int       `json:"sort_order" gorm:"default:0"`
    Version      int       `json:"version" gorm:"default:1;index"`
    IsLatest     bool      `json:"is_latest" gorm:"default:true;index"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}
```

---

## 7. 接口设计

### 7.1 仓库文档列表

- `GET /api/repositories/:id/documents`
- 默认仅返回最新版本

---

## 8. 验收标准

- 同一任务重复生成文档后，数据库存在多个版本记录
- 最新版本 `is_latest = true`，旧版本为 false
- 文档列表接口只返回最新版本
