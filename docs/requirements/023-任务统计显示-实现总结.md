# 023-任务统计显示-实现总结
> 对应需求：[023-任务统计显示-需求.md](./023-任务统计显示-需求.md)  
> 对应设计：[023-任务统计显示-设计.md](../design/023-任务统计显示-设计.md)

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-07 | 新增启动时清理排队任务与实现总结 |

## 1. 实现概述

本次调整补充了启动时清理遗留排队任务的逻辑，避免服务重启后任务长期停留在 queued 状态，导致任务统计与仓库状态分析长期不准确。

## 2. 需求对应关系

### 2.1 需求来源
- [023-任务统计显示-需求.md](./023-任务统计显示-需求.md)

### 2.2 对应说明
| 需求点 | 实现情况 | 说明 |
| :--- | :--- | :--- |
| 排队中任务统计准确 | 已增强 | 启动时将遗留 queued 任务回收为 pending |
| 执行中任务统计准确 | 已保持 | 运行中任务仍由超时清理逻辑处理 |

## 3. 关键实现点

### 3.1 启动时排队任务清理
- Service 层新增 `CleanupQueuedTasksOnStartup`，将 queued 任务依序迁移为 canceled -> pending 并清理运行时间字段。
- 记录受影响仓库并刷新仓库状态聚合，确保仓库状态与任务统计一致。

### 3.2 Repository 扩展
- Repository 层新增按状态查询接口 `GetByStatus`，用于集中获取 queued 任务集合。

### 3.3 启动入口整合
- 服务启动流程中，在清理运行中卡住任务后，追加清理遗留排队任务的调用。

## 4. 测试记录

- 后端单元测试：`go test ./...`

## 5. 安全自检

1. **状态一致性**：仅对 queued 任务进行状态回收，避免误操作 running 任务。
2. **权限风险**：逻辑仅在服务启动时运行，不新增外部可调用入口。
3. **数据完整性**：重置任务不删除文档与任务记录，仅回退状态。

## 6. 变更文件清单

- `backend/cmd/server/main.go`
- `backend/internal/service/task.go`
- `backend/internal/repository/repository.go`
- `backend/internal/repository/task_repo.go`
- `backend/internal/service/task_test.go`
- `backend/internal/handler/repository_test.go`
