# 026-目录证据存储-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-07 | 初始版本 |

# 1. 背景（Why）
当前目录生成仅输出标题与排序，缺少可追溯的证据来源，导致后续文档生成无法判断目录标题的依据来源与探索方向。

# 2. 目标（What，必须可验证）
- [ ] 目录生成结果支持输出结构化证据列表
- [ ] 证据落库为独立表，避免任务表膨胀
- [ ] 证据与仓库、任务建立关联，可按任务查询
- [ ] 目录分析任务生成流程完成证据保存

# 3. 非目标（Explicitly Out of Scope）
- 不新增或修改前端页面展示
- 不新增对外 API
- 不改动既有任务状态流转规则

# 4. 使用场景 / 用户路径
1. 系统触发目录分析任务生成
2. 目录生成 Agent 输出目录与证据
3. 服务端解析目录输出并创建任务
4. 证据信息与任务关联保存
5. 后续文档生成可按任务读取证据

# 5. 功能需求清单（Checklist）
- [ ] 解析目录生成结果时接收 evidence 字段
- [ ] evidence 支持多条记录，每条包含维度、来源、说明
- [ ] 新增证据表并与任务、仓库关联
- [ ] 保存证据时记录任务标题

# 6. 约束条件（非常关键）
- 技术约束：沿用现有 Go + Gorm 技术栈
- 架构约束：证据存储独立表，不扩展 task 表
- 安全约束：证据内容不包含敏感信息或本地路径
- 性能约束：证据保存不显著阻塞目录生成流程

# 7. 可修改 / 不可修改项
- ❌ 不可修改：既有任务接口与状态机定义
- ✅ 可调整：目录生成结果的内部解析与存储逻辑

# 8. 接口与数据约定（如适用）
- 目录输出结构：
  - dirs[].evidence[]:
    - aspect：证据维度
    - source：证据来源（文件/目录/依赖）
    - detail：证据细节说明
- 数据表字段（证据表）：
  - id
  - repository_id
  - task_id
  - title
  - aspect
  - source
  - detail
  - created_at
  - updated_at

# 9. 验收标准（Acceptance Criteria）
- 如果目录生成结果包含 evidence，则能在数据库中找到对应证据记录
- 如果一个任务有多条证据，则全部入库且可按 task_id 查询
- 如果 evidence 为空，则不影响任务创建
- 目录生成流程可正常完成且数据一致

# 10. 风险与已知不确定点
- Agent 输出 evidence 字段为空或结构不完整时需要跳过保存
- 证据文本过长需确认字段长度是否满足

# 11. 非目标
- 不实现证据读取或展示接口
- 不改变现有目录生成 Agent 的执行流程
