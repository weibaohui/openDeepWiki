# 027-数据库模型解析服务-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-08 | 初始版本 |

# 1. 背景（Why）
当前文档生成流程缺少针对数据库结构的专项解析能力，无法系统化整理表结构与字段含义。目录分析阶段已经沉淀了 TaskEvidence，但没有被用于数据库结构类文档的进一步扩展与深挖，因此需要新增数据库模型解析服务，基于证据线索生成高质量的表结构说明文档。

# 2. 目标（What，必须可验证）
- [ ] 从 TaskEvidence 中筛选数据库相关证据，并序列化为 YAML 输入
- [ ] 使用“探索 Agent + markdown_checker”顺序执行，生成结构化 Markdown 文档
- [ ] 文档包含：表结构、字段注释/含义、字段存储内容说明
- [ ] 生成结果写入 documents 表，保存为版本化文档
- [ ] 支持任务级执行，与现有任务流程兼容

# 3. 非目标（Explicitly Out of Scope）
- 不新增或修改前端展示页面
- 不引入真实数据库连接或运行时查询
- 不自动推断代码中不存在的表结构与字段

# 4. 使用场景 / 用户路径
1. 系统创建任务后执行数据库模型解析任务
2. 服务读取 TaskEvidence 中数据库相关线索
3. 组装 YAML 输入并调用探索 Agent
4. markdown_checker 校验输出
5. 保存文档到 documents 表并返回结果

# 5. 功能需求清单（Checklist）
- [ ] 新增数据库模型解析 Service，提供 Generate 接口
- [ ] 按关键词筛选证据（例如：model/sql/数据库/表/字段/ddl/迁移）
- [ ] YAML 输入包含 title/detail/source 列表
- [ ] 仅使用“探索 Agent + markdown_checker”顺序执行
- [ ] 当证据为空时仍允许生成，但需在提示中说明证据为空
- [ ] 输出为空或非 Markdown 时返回错误
- [ ] 日志统一使用 klog.V(6) 中文描述
- [ ] 生成结果保存为版本化文档

# 6. 约束条件（非常关键）
- 技术约束：Go + Gorm + Eino ADK
- 架构约束：复用 TaskEvidence 与 DocumentService
- 安全约束：输出中不包含本地绝对路径或敏感信息
- 性能约束：证据筛选与 YAML 组装不可显著阻塞任务执行

# 7. 可修改 / 不可修改项
- ❌ 不可修改：已有任务状态机与文档版本策略
- ✅ 可调整：新增任务类型与 Agent 配置

# 8. 接口与数据约定（如适用）
- Service 接口：
  - Generate(ctx, localPath, title, taskID) (string, error)
- YAML 输入结构：
  - evidences:
    - title: "<证据标题>"
      detail: "<证据细节>"
      source: "<证据来源>"

# 9. 验收标准（Acceptance Criteria）
- 如果 TaskEvidence 包含数据库相关条目，则 YAML 输入包含对应条目
- Agent 输出为 Markdown 且包含表结构与字段说明
- documents 表新增一条版本记录，并标记为最新版本
- 任务执行失败时有清晰日志与错误返回

# 10. 风险与已知不确定点
- 证据信息不足导致输出不完整，需要在文档中明确“未发现”
- 源码中表结构未写明注释时，需避免臆测含义

# 11. 非目标
- 不实现数据库结构可视化或 ER 图生成
- 不进行字段级数据血缘分析
