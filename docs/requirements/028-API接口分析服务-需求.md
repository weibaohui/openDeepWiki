# 028-API接口分析服务-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-08 | 初始版本 |

# 1. 背景（Why）
现有文档生成流程缺少对仓库中 API 接口的专项分析能力，无法集中梳理对外可访问的接口与模块划分。为提升项目可理解性，需要新增 API 接口分析服务，结合线索证据与源码识别接口清单并输出模块化文档。

# 2. 目标（What，必须可验证）
- [ ] 识别项目中所有对外可访问的 API 接口（重点关注 HTTP 对外接口）
- [ ] 按模块划分 API 清单，一个模块一个表格
- [ ] 表格列包含：访问路径、功能、参数集合、说明
- [ ] 支持独立触发 API 分析任务并生成文档
- [ ] 生成结果保存为 documents 表的版本化文档

# 3. 非目标（Explicitly Out of Scope）
- 不调用实际线上接口进行动态探测
- 不对未在源码中出现的接口进行臆测
- 不自动生成完整的 OpenAPI/Swagger 规范文件

# 4. 使用场景 / 用户路径
1. 前端 RepoDetail 页面提供“API接口分析”按钮，独立触发接口分析
2. 请求接口：`POST /api/repositories/:id/api-analyze`
3. 服务在仓库范围检索 TaskHint 中 API 相关证据
4. 组装 YAML 线索并调用探索 Agent
5. markdown_checker 校验输出
6. 保存文档到 documents 表并返回结果

# 5. 功能需求清单（Checklist）
- [ ] 新增 API 接口解析 Service，提供 Generate 接口
- [ ] 按关键词筛选证据（如：api/route/router/controller/handler/http/路由/接口）
- [ ] YAML 输入包含 title/detail/source 列表
- [ ] 使用“探索 Agent + document_checker + markdown_checker”顺序执行
- [ ] 证据为空时仍允许生成，但需在文档中说明未发现
- [ ] 输出为空或非 Markdown 时返回错误
- [ ] 日志统一使用 klog.V(6) 中文描述
- [ ] 生成结果保存为版本化文档

# 6. 约束条件（非常关键）
- 技术约束：Go + Gorm + Eino ADK
- 架构约束：复用 TaskHint 与 DocumentService
- 安全约束：输出中不包含本地绝对路径或敏感信息
- 性能约束：证据筛选与 YAML 组装不可显著阻塞任务执行

# 7. 可修改 / 不可修改项
- ❌ 不可修改：已有任务状态机与文档版本策略
- ✅ 可调整：新增任务类型与 Agent 配置

# 8. 接口与数据约定（如适用）
- Service 接口：
  - Generate(ctx, localPath, title, repoID, taskID) (string, error)
- 任务类型：
  - api-analyze
- YAML 输入结构：
  - hints:
    - title: "<证据标题>"
      detail: "<证据细节>"
      source: "<证据来源>"

# 9. 验收标准（Acceptance Criteria）
- 如果 TaskHint 包含 API 相关条目，则 YAML 输入包含对应条目
- Agent 输出为 Markdown 且按模块输出表格
- documents 表新增一条版本记录，并标记为最新版本
- 任务执行失败时有清晰日志与错误返回

# 10. 风险与已知不确定点
- 证据信息不足导致输出不完整，需要在文档中明确“未发现”
- 项目中存在多协议接口（如 gRPC）时需明确输出范围

# 11. 非目标
- 不实现接口调用链追踪
- 不生成接口鉴权与权限矩阵
