# 030-用户内容需求反馈-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-09 | 初始版本 |

# 1. 背景（Why）

用户在浏览 openDeepWiki 生成的项目文档时，可能无法从现有文档中找到想要了解的内容。为了提升用户体验，让用户能够主动提出内容需求，系统应提供便捷的反馈机制，收集用户想要查看的内容，并通过 AI 提取和总结，生成新的任务来扩展文档。

# 2. 目标（What，必须可验证）

- [ ] 在文档查看页面的左侧文档列表末尾增加"没找到想要的"按钮
- [ ] 点击按钮后弹出对话框，提示用户输入想要查看的内容（一句话）
- [ ] 提交后，系统调用 LLM 对用户输入进行提取和总结，生成简洁的文档标题
- [ ] 将提取的标题作为新的 Task 任务保存到数据库
- [ ] 任务类型为 `user-request`，状态为 `pending`
- [ ] 任务标题包含仓库ID和总结后的标题
- [ ] 用户提交后显示成功提示信息

# 3. 非目标（Explicitly Out of Scope）

- 不实现需求的实时处理和文档生成
- 不实现需求优先级排序和队列管理
- 不实现需求的批量导入和导出
- 不实现用户需求的历史记录和统计

# 4. 使用场景 / 用户路径

1. 用户访问文档查看页面 `/repo/:id/doc/:docId` 或 `/repo/:id`
2. 用户浏览左侧文档列表，发现没有想要查看的内容
3. 用户点击文档列表底部的"没找到想要的"按钮
4. 系统弹出对话框，提示"请用一句话描述您想要查看的内容"
5. 用户输入内容，例如："我想了解这个项目的认证机制是如何实现的"
6. 用户点击"提交"按钮
7. 系统调用 LLM 对用户输入进行处理，提取和总结为简洁标题，例如："用户认证机制实现说明"
8. 系统创建新的 Task 记录并保存到数据库
9. 系统显示"需求已提交，我们会尽快生成相关文档"的成功提示

# 5. 功能需求清单（Checklist）

## 前端需求
- [ ] 在 DocViewer 组件的 SidebarContent 中，文档列表 Menu 后添加"没找到想要的"按钮
- [ ] 按钮样式使用 Ant Design Button，类型为 default，大小为 small
- [ ] 按钮宽度 100%，底部边距 16px
- [ ] 添加 Modal 对话框，包含文本输入框和确认/取消按钮
- [ ] 文本输入框支持多行输入（TextArea），最大长度 200 字符
- [ ] 对话框标题为"内容需求反馈"
- [ ] 提交按钮调用后端 API
- [ ] 成功后显示 message.success 提示信息
- [ ] 失败时显示 message.error 提示信息
- [ ] 集成国际化（i18n）支持中英文显示

## 后端需求
- [ ] 创建新的 API 接口 `POST /api/repositories/:id/user-requests`
- [ ] 请求体包含 `content` 字段（用户输入的内容）
- [ ] 调用 LLM 服务对用户输入进行提取和总结
- [ ] 生成简洁的文档标题（不超过 50 个字符）
- [ ] 创建新的 Task 记录，字段包括：
  - `repository_id`: 仓库 ID
  - `type`: 任务类型为 `user-request`
  - `title`: 提取的标题
  - `status`: 初始状态为 `pending`
  - `sort_order`: 排序顺序为 999（排在最后）
- [ ] 保存 Task 到数据库
- [ ] 返回成功响应，包含创建的 Task 信息
- [ ] 使用 klog.V(6) 输出详细日志
- [ ] 错误处理包括 LLM 调用失败、数据库保存失败等情况

## LLM 需求
- [ ] 设计 Prompt 模板，指导 LLM 提取和总结用户输入
- [ ] Prompt 要求：
  - 提取用户想要了解的核心内容
  - 生成简洁的文档标题（不超过 50 个字符）
  - 标题应该清晰、专业、易于理解
  - 使用中文或英文（根据用户输入语言）
- [ ] 示例：
  - 输入："我想了解这个项目的认证机制是如何实现的"
  - 输出："用户认证机制实现说明"

# 6. 约束条件（非常关键）

## 技术约束
- 前端技术栈：React 19 + TypeScript + Ant Design 6
- 后端技术栈：Go 1.24+ + Gin + GORM
- 数据库：SQLite（默认）/ MySQL
- LLM：支持 OpenAI 兼容接口

## 架构约束
- 复用现有的 Task 模型和 TaskService
- 复用现有的 LLM 调用机制（ADK Agents）
- 遵循项目分层架构（Handler -> Service -> Repository）
- 遵循错误处理规范

## 安全约束
- 对用户输入进行长度限制（最大 200 字符）
- 防止 SQL 注入（使用 GORM 参数化查询）
- 防止 XSS 攻击（前端转义用户输入）
- 记录所有用户请求到日志

## 性能约束
- LLM 调用响应时间不超过 10 秒
- API 响应时间不超过 15 秒
- 支持并发请求（至少 10 个/秒）

# 7. 可修改 / 不可修改项

## ❌ 不可修改
- 已有的 Task 模型结构
- 已有的 TaskService 接口
- 已有的 LLM 配置和调用机制
- 已有的国际化方案

## ✅ 可调整
- 按钮的样式和位置（在不影响布局的前提下）
- 对话框的样式和布局
- Prompt 模板的内容和格式
- 日志输出的详细程度

# 8. 接口与数据约定

## API 接口定义

### POST /api/repositories/:id/user-requests

#### 请求
- **Path Parameters**:
  - `id`: 仓库 ID（integer）

- **Request Body**:
  ```json
  {
    "content": "用户输入的内容"
  }
  ```

- **Constraints**:
  - `content`: 必填，字符串类型，最大长度 200 字符

#### 响应

**成功响应**（200 OK）:
```json
{
  "code": 0,
  "message": "需求已提交",
  "data": {
    "id": 123,
    "repository_id": 1,
    "type": "user-request",
    "title": "用户认证机制实现说明",
    "status": "pending",
    "sort_order": 999,
    "created_at": "2026-02-09T10:00:00Z",
    "updated_at": "2026-02-09T10:00:00Z"
  }
}
```

**错误响应**:

1. 请求参数无效（400 Bad Request）:
```json
{
  "code": 400,
  "message": "content 字段不能为空"
}
```

2. LLM 调用失败（500 Internal Server Error）:
```json
{
  "code": 500,
  "message": "无法处理您的请求，请稍后重试"
}
```

3. 数据库保存失败（500 Internal Server Error）:
```json
{
  "code": 500,
  "message": "保存失败，请稍后重试"
}
```

## 数据模型

### Task 模型扩展
- `type`: 新增 `user-request` 类型
- `sort_order`: 用户需求任务使用 999 排序

### DTO 定义

#### UserRequestDTO
```go
type UserRequestDTO struct {
    Content string `json:"content" binding:"required,max=200"`
}
```

#### UserRequestResponseDTO
```go
type UserRequestResponseDTO struct {
    ID           int64     `json:"id"`
    RepositoryID int64     `json:"repository_id"`
    Type         string    `json:"type"`
    Title        string    `json:"title"`
    Status       string    `json:"status"`
    SortOrder    int       `json:"sort_order"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}
```

## LLM Prompt 模板

```
你是一个文档标题生成专家。请根据用户的输入，提取核心内容并生成一个简洁、专业的文档标题。

要求：
1. 标题长度不超过 50 个字符
2. 标题应该清晰、专业、易于理解
3. 使用中文或英文（根据用户输入语言）
4. 只返回标题，不要返回其他内容

用户输入：{{user_input}}

请生成文档标题：
```

# 9. 验收标准（Acceptance Criteria）

## 功能验收
- 如果用户在文档查看页面点击"没找到想要的"按钮，则弹出对话框
- 如果用户输入内容并提交，则系统调用 LLM 生成标题
- 如果 LLM 生成标题成功，则创建 Task 并保存到数据库
- 如果操作成功，则显示成功提示信息
- 如果操作失败，则显示相应的错误提示信息

## 数据验收
- 如果创建 Task 成功，则数据库中新增一条记录
- Task 的 `type` 字段为 `user-request`
- Task 的 `status` 字段为 `pending`
- Task 的 `sort_order` 字段为 999
- Task 的 `title` 字段为 LLM 生成的标题

## UI 验收
- 按钮显示在文档列表底部
- 按钮样式符合 Ant Design 规范
- 对话框样式符合 Ant Design Modal 规范
- 支持中英文切换
- 响应式布局，适配不同屏幕尺寸

## 日志验收
- 用户请求记录到日志
- LLM 调用记录到日志
- 错误信息记录到日志
- 日志使用 klog.V(6) 输出

# 10. 风险与已知不确定点

## 已知风险
1. **LLM 响应不稳定**：LLM 生成的标题可能不准确或过长
   - 应对措施：在 Prompt 中明确限制长度，在代码中进行截断处理

2. **LLM 调用超时**：网络或服务问题导致 LLM 调用超时
   - 应对措施：设置合理的超时时间（10秒），提供重试机制

3. **用户输入不规范**：用户可能输入无意义的内容或特殊字符
   - 应对措施：进行输入验证和清理，过滤敏感词汇

4. **并发问题**：多个用户同时提交需求可能导致并发问题
   - 应对措施：使用数据库事务保证数据一致性

## 不确定点
1. **LLM 生成标题的质量**：需要实际测试和调整 Prompt
2. **Task 任务的后处理**：创建的 Task 如何被处理和执行（不在本需求范围内）

# 11. 非目标

- 不实现需求任务的自动执行和文档生成
- 不实现需求的管理界面（查看、删除、编辑）
- 不实现需求的优先级和队列管理
- 不实现需求的通知和反馈机制
- 不实现需求的历史记录和统计分析
- 不实现需求的多语言处理（仅支持中英文）
- 不实现需求的批量导入和导出
