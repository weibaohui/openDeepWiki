# 035-分析任务可扩展重构-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-11 | 初始版本 |

# 1. 背景（Why）
现有仓库分析相关服务在 `repository_analyze.go` 中存在多段重复流程（获取仓库、校验状态、创建任务、异步执行、更新状态与文档），新增分析能力时需重复粘贴逻辑，扩展成本高且容易引入不一致。需要在不破坏现有接口的前提下重构该文件，使其形成可扩展的分析任务执行能力，便于后续新增如“增量 Git 文件分析”“典型问题分析（开发贡献、AI 能力、微服务设计、云原生容器设计等）”等能力。

# 2. 目标（What，必须可验证）
- [ ] 抽取并复用任务执行公共流程，减少重复代码
- [ ] 保持现有对外接口与行为不变（函数签名、返回值、错误语义）
- [ ] 支持在同文件中快速新增分析任务类型
- [ ] 统一任务状态更新、文档保存与错误处理路径
- [ ] 日志保持中文描述且维持 klog.V(6) 规范

# 3. 非目标（Explicitly Out of Scope）
- 不新增新的 API 接口或修改已有 API
- 不调整数据库结构或任务状态机
- 不更改其他文件或模块逻辑（范围仅限 repository_analyze.go）

# 4. 使用场景 / 用户路径
1. 用户在仓库详情页触发专项分析（数据库模型、API 接口、问题分析）
2. 服务在后台异步执行分析并更新任务状态
3. 未来新增分析任务时仅需追加配置与生成逻辑即可复用执行流程

# 5. 功能需求清单（Checklist）
- [ ] 通用执行流程支持：启动日志、状态更新、生成文档、保存文档、失败处理、完成处理
- [ ] 支持任务创建参数化（标题、排序、生成器函数）
- [ ] 支持任务后置动作（如标题重写）
- [ ] 保留目录分析任务特殊逻辑（目录生成与提示存储）

# 6. 约束条件（非常关键）
- 技术约束：Go + 现有 RepositoryService 结构不变
- 架构约束：仅限 repository_analyze.go 文件内重构
- 安全约束：不输出本地绝对路径或敏感信息
- 性能约束：异步执行不阻塞调用方

# 7. 可修改 / 不可修改项
- ❌ 不可修改：现有公共接口函数签名与返回值
- ❌ 不可修改：任务状态机与文档版本策略
- ✅ 可调整：分析任务内部流程复用与组织方式

# 8. 接口与数据约定（如适用）
- AnalyzeDirectory / AnalyzeDatabaseModel / AnalyzeAPI / AnalyzeProblem 的函数签名保持不变
- 新增内部抽象不得对外暴露新的 API

# 9. 验收标准（Acceptance Criteria）
- 代码重复显著减少且可读性提升
- 新增分析任务可通过新增配置/函数快速接入
- 原有功能行为一致，任务状态与文档更新流程保持正确

# 10. 风险与已知不确定点
- 抽象层过重可能影响可读性，需要控制在单文件内
- 目录分析任务与专项分析任务存在流程差异，需要保留差异化处理
