# 036-任务RunAfter依赖-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-11 | 初始版本 |

## 1. 背景（Why）
当前任务编排仅基于状态与队列顺序执行，无法表达“任务必须在某个前置任务成功后才能启动”的依赖关系，导致需要人为拆分执行或串行触发。为提升任务编排的可控性，需要新增任务级依赖机制。

## 2. 目标（What，必须可验证）
- [ ] 支持任务级 RunAfter 依赖配置，表示必须在指定任务成功后才能启动
- [ ] 依赖未满足时，任务不进入执行队列
- [ ] 依赖任务成功后，可正常排队并执行
- [ ] 依赖任务失败/取消时，待执行任务保持不入队
- [ ] 记录清晰的依赖校验日志，便于排查

## 3. 非目标（Explicitly Out of Scope）
- 不新增新的 API 接口
- 不调整现有任务状态机定义
- 不改变数据库结构以外的任务字段语义

## 4. 详细需求
### 4.1 任务属性
- 任务新增字段：`RunAfter`（类型：TaskID）
- 语义：仅当 `RunAfter` 指向的任务状态为成功时，本任务才允许入队

### 4.2 编排行为
- 任务入队前需检查 RunAfter 依赖
- 若依赖未满足，任务保持当前状态，不入队
- 依赖满足后，任务可被编排入队

### 4.3 日志要求
- 依赖未满足时记录中文日志，使用 klog.V(6)

## 5. 验收标准
1. RunAfter 任务在依赖成功前不会进入执行队列
2. 依赖任务成功后，RunAfter 任务可被正常入队与执行
3. 依赖任务失败/取消时，RunAfter 任务不会入队
4. 日志可清晰反映依赖判定结果
