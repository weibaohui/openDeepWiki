# 037-任务用量记录-实现总结
> 对应需求：[037-任务用量记录-需求.md](./037-任务用量记录-需求.md)  
> 对应设计：[037-任务用量记录-设计.md](../design/037-任务用量记录-设计.md)

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |

## 1. 实现概述
新增 TaskUsage 数据模型与记录服务，在模型调用返回时持久化 token 使用量、taskID 与 APIKeyName，用于后续成本与问题分析。

## 2. 需求对应关系
### 2.1 需求来源
- [037-任务用量记录-需求.md](./037-任务用量记录-需求.md)

### 2.2 对应说明
| 需求点 | 实现情况 | 说明 |
| :--- | :--- | :--- |
| 记录 token 使用量 | 已实现 | 记录 prompt/completion/total/cached/reasoning |
| 记录 taskID | 已实现 | 从 ctx.Value("taskID") 获取 |
| 记录 APIKeyName | 已实现 | 使用当前模型 APIKeyName |
| 不中断主流程 | 已实现 | 失败仅日志输出 |

## 3. 关键实现点
### 3.1 数据模型与迁移
- 新增 TaskUsage 模型并加入 AutoMigrate。

### 3.2 Repository 与 Service
- 新增 TaskUsageRepository 与 TaskUsageService，专注于记录与日志。

### 3.3 调用链路接入
- 在 ProxyChatModel.Generate 中完成 usage 提取与记录。

## 4. 测试记录
- 后端单元测试：`go test ./...`

## 5. 安全自检
1. **越权风险**：仅内部调用，不新增外部接口。
2. **输入校验**：仅使用内部返回的 usage 与上下文 taskID。
3. **敏感信息**：未记录 API Key，仅记录 APIKeyName。

## 6. 变更文件清单
- `backend/internal/model/models.go`
- `backend/internal/pkg/database/database.go`
- `backend/internal/repository/repository.go`
- `backend/internal/repository/task_usage_repo.go`
- `backend/internal/service/task_usage.go`
- `backend/internal/service/task_usage_test.go`
- `backend/internal/pkg/adkagents/types.go`
- `backend/internal/pkg/adkagents/model_provider.go`
- `backend/internal/pkg/adkagents/proxy_model.go`
- `backend/cmd/server/main.go`
