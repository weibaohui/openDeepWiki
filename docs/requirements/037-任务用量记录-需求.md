# 037-任务用量记录-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |

## 1. 背景（Why）
当前任务执行过程中已经获取到了模型返回的 token 使用量，但缺少统一持久化统计，无法按任务维度回溯模型消耗与模型名称，影响成本分析与问题排查。

## 2. 目标（What，必须可验证）
- [ ] 每次模型返回时记录 token 使用量（prompt/completion/total 等）
- [ ] 记录触发该次调用的 taskID
- [ ] 记录使用的 APIKeyName（模型名称）
- [ ] 记录缓存 token 与推理 token（如返回）
- [ ] 记录过程不影响现有模型调用主流程

## 3. 非目标（Explicitly Out of Scope）
- 不新增对外 API 接口
- 不变更现有任务状态机与编排逻辑
- 不新增前端展示页面

## 4. 详细需求
### 4.1 记录内容
- taskID：来自上下文 `ctx.Value("taskID")`
- APIKeyName：当前被选中的模型名称
- token 使用量：
  - prompt_tokens
  - completion_tokens
  - total_tokens
  - cached_tokens（如有）
  - reasoning_tokens（如有）

### 4.2 记录时机
- 模型调用返回后，若响应 meta 中包含 usage，则进行持久化记录
- 若 taskID 缺失，记录中文日志但不影响主流程

### 4.3 日志要求
- 使用 klog.V(6) 输出中文日志，便于调试与审计

## 5. 验收标准
1. 任意任务执行后，数据库中存在对应 TaskUsage 记录
2. TaskUsage 记录包含 taskID、APIKeyName、token 使用量字段
3. taskID 缺失时不会导致模型调用失败
4. 日志可清晰定位记录成功与失败原因
