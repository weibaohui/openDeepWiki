# 039-同步界面显示本端同步接口地址-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |

## 一、背景（Why）

当前 openDeepWiki 的数据同步功能需要用户手动输入对端服务器地址，当用户想要将当前实例作为目标服务器时，需要手动复制并输入完整的同步接口地址。这个过程繁琐且容易出错，尤其是：

1. 地址拼接复杂：需要正确拼接 `https://域名:端口/api/sync`
2. 手动输入易错：容易遗漏 `/api/sync` 后缀或拼写错误
3. 协议判断困难：不确定目标服务是使用 http 还是 https

## 二、目标（What，必须可验证）

- [x] 在同步界面（同步配置页面）显示当前服务器的同步接口地址
- [x] 地址格式为 `https[http]://访问域名:访问端口/api/sync`
- [x] 提供一键复制功能，便于用户快速复制
- [ ] 自动检测协议类型（http 或 https）并使用正确格式
- [ ] 支持点击地址自动填充到目标服务器输入框

## 三、非目标（Explicitly Out of Scope）

- 不修改同步接口的现有逻辑和功能
- 不新增对外 API 接口获取同步地址
- 不支持地址的自定义或编辑（仅展示当前服务器地址）

## 四、详细需求

### 4.1 界面展示

**展示位置：** 同步配置页面（目标服务器配置区域）

**展示内容：**
- 标题：`本端同步接口地址`
- 地址值：当前服务器的同步接口完整 URL
- 复制按钮：`复制`（提供一键复制功能）
- 图标提示：复制按钮旁显示复制成功提示

**展示格式：**
```
https://your-domain.com:port/api/sync
```

**说明文字：**
```
可将此地址粘贴到其他实例的"目标服务器"输入框中，将本端数据同步到该实例。
```

### 4.2 地址构成规则

**格式模板：**
```
[协议]://[域名]:[端口]/api/sync
```

**规则说明：**
- 协议：根据当前环境判断，生产环境使用 `https`，开发环境可使用 `http`
- 域名：从环境配置中获取（如 `localhost`、实际域名等）
- 端口：从环境配置中获取（如 `8080`、`3000` 等）
- 后缀：固定为 `/api/sync`

**端口省略规则：**
- 端口为 `80`（http）或 `443`（https）时，省略端口号
- 端口为 `8080`、`3000` 等非标准端口时，显示端口号

**示例：**
```
https://openDeepWiki.com:8080/api/sync
http://localhost:8080/api/sync
https://api.example.com/api/sync  (443 端口省略)
http://example.com:80/api/sync       (80 端口省略)
```

### 4.3 复制功能

**用户操作流程：**
```
用户点击"复制"按钮
  ↓
复制地址到剪贴板
  ↓
显示"复制成功"提示（1.5 秒后消失）
```

**技术实现：**
- 使用 Clipboard API 复制文本
- 复制成功后显示临时提示信息
- 支持 Ctrl+C 键盘快捷键（原生行为）

### 4.4 响应式设计

**移动端适配：**
- 地址过长时自动截断并显示省略号
- 支持横向滚动查看完整地址
- 复制按钮始终可见

**桌面端适配：**
- 地址完整展示（如有必要可使用文本换行）
- 复制按钮提供 hover 提示："点击复制同步地址"

## 五、验收标准

1. 打开同步配置页面，能看到"本端同步接口地址"区域
2. 地址格式正确：`协议://域名:端口/api/sync`
3. 点击"复制"按钮后，地址被正确复制到剪贴板
4. 复制后显示"复制成功"提示
5. 地址在移动端正确显示（支持滚动或截断）
6. 在不同环境（dev/prod）下，协议和端口正确反映

## 六、交互流程

```
打开同步配置页面
  ↓
查看"本端同步接口地址"区域
  ↓
确认地址正确（或点击复制）
  ↓
（可选）粘贴到其他实例的目标服务器输入框
  ↓
（可选）发起数据同步
```

## 七、前端实现要点

### 7.1 地址获取

**方式一：后端配置获取（推荐）**
```typescript
// 从后端 API 获取当前服务器配置
const getServerConfig = async () => {
  const config = await fetch('/api/config');
  return config.syncUrl; // 后端返回构建好的同步地址
}
```

**方式二：前端自行拼接**
```typescript
// 前端根据配置自行拼接
const buildSyncUrl = () => {
  const protocol = window.location.protocol; // http: 或 https:
  const host = window.location.hostname;
  const port = window.location.port;
  const syncUrl = `${protocol}//${host}${port ? ':' + port : ''}/api/sync`;
  return syncUrl;
}
```

### 7.2 UI 组件结构

```tsx
<div className="sync-url-display">
  <div className="sync-url-header">
    <span className="label">本端同步接口地址</span>
    <span className="description">可将此地址粘贴到其他实例的目标服务器输入框中</span>
  </div>
  <div className="sync-url-value">
    <code>{syncUrl}</code>
  </div>
  <div className="sync-url-actions">
    <Button onClick={handleCopy} icon={<CopyIcon />}>
      复制
    </Button>
  </div>
  {copySuccess && (
    <div className="copy-success">复制成功</div>
  )}
</div>
```

### 7.3 状态管理

```typescript
const [copySuccess, setCopySuccess] = useState(false);

const handleCopy = async () => {
  await navigator.clipboard.writeText(syncUrl);
  setCopySuccess(true);
  setTimeout(() => setCopySuccess(false), 1500);
};
```

## 八、后续优化方向

1. [ ] 支持点击地址自动填充到其他实例的输入框
2. [ ] 提供地址格式校验（确保符合 `协议://域名:端口/api/sync` 格式）
3. [ ] 支持生成带授权令牌的地址（用于需要认证的场景）
4. [ ] 提供地址测试功能（验证对端接口是否可访问）
5. [ ] 记录复制历史（方便用户快速访问最近复制的地址）
