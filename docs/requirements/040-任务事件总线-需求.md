# 040-任务事件总线-需求.md

# 0. 文件修改记录表

| 修改人 | 修改时间 | 修改内容 |
| ------ | -------- | -------- |
| AI | 2026-02-12 | 初始版本 |
| AI | 2026-02-13 | 增加文档推送/拉取事件要求 |
| AI | 2026-02-15 | 增加文档同步事件落库要求 |

## 一、背景（Why）

当前任务创建逻辑集中在 TaskService 的多个方法中，后续需要扩展更多任务类型，并允许其他模块在不同位置发布任务相关事件。为降低耦合、提升扩展性，需要引入统一的事件总线机制，支持广播与订阅。

## 二、目标（What，必须可验证）

- [x] 提供任务事件总线，支持事件发布与多订阅者广播
- [x] 事件类型覆盖现有四类任务：DocWrite、TocWrite、TitleRewrite、UserRequest
- [x] 提供固定订阅服务与处理流程，集中管理任务事件处理
- [x] 支持后续在其他模块中发布任务事件并触发同一处理流程

## 三、非目标（Explicitly Out of Scope）

- 不修改任务领域模型与数据库结构
- 不新增跨进程或分布式消息队列能力
- 不涉及外部系统事件推送

## 四、详细需求

### 4.1 事件总线能力

- 提供统一的事件总线组件
- 支持订阅者注册与注销
- 发布事件时支持广播给所有订阅者

### 4.2 事件类型

事件类型以现有任务创建类型为准：

- DocWrite
- TocWrite
- TitleRewrite
- UserRequest

事件需包含必要上下文信息，例如：仓库ID、任务标题、排序、关联文档等。

### 4.3 固定订阅服务

- 提供固定的订阅服务，注册到事件总线
- 统一处理事件，调用现有 TaskService 创建任务逻辑
- 输出中文日志，便于调试与排查

### 4.4 发布方式

- TaskService 在创建任务时发布事件
- 其他模块后续可直接发布事件，触发同一订阅处理流程

### 4.5 文档事件扩展

- 新增文档事件类型：DocPulled、DocPushed
- 在 /api/sync 相关流程中，当文档被推送或被拉取后发布对应事件
- 文档事件订阅方当前仅输出日志，具体处理逻辑后续补充

### 4.6 文档同步事件存储

- 文档推送/拉取事件需持久化存储
- 存储字段包含事件类型、仓库ID、文档ID、对端地址、成功状态与创建时间

## 五、验收标准

1. 事件总线支持订阅、取消订阅、事件发布
2. 发布四类事件时，订阅服务能正确接收并处理
3. 任务创建成功后产生对应日志，且日志为中文描述
4. 能在其他模块中调用事件发布入口并触发处理流程
