# openDeepWiki 优化建议清单

> 说明：本清单基于代码重构后的现状,从架构设计、安全性、稳定性、性能、可维护性与用户体验维度提出可落地的优化项。  
> 优先级说明:P0=严重问题必须修复,P1=重要优化强烈建议,P2=改进项建议实施,P3=锦上添花可选实施  
> 状态列用于跟踪：未开始 / 进行中 / 已完成

---

## 一、架构与设计（P0-P1）

| 编号 | 模块      | 优化建议                             | 价值/风险                                                    | 优先级 |  状态  | 验收标准                                                                                                                                                               |
| ---: | --------- | ------------------------------------ | ------------------------------------------------------------ | :----: | :----: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|    1 | 后端-架构 | 引入任务队列机制替代无限制 goroutine | 防止并发任务打爆 CPU/内存/LLM 配额；提升系统稳定性           | **P0** | 未开始 | 实现全局任务队列（如 channel-based worker pool 或 redis queue）；可配置并发数（默认 1-3）；任务排队状态可查询                                                          |
|    2 | 后端-架构 | 任务执行增加幂等性与互斥锁机制       | 防止用户重复点击导致同一任务并发执行、文档重复写入、状态竞争 | **P0** | 未开始 | 使用分布式锁或 DB 乐观锁；在 TaskService.Run 开始时检查并原子更新状态（`UPDATE tasks SET status='running' WHERE id=? AND status='pending'`）；返回错误"任务已在运行中" |
|    3 | 后端-架构 | 静态分析结果缓存到内存或 DB          | 避免同一仓库的多个任务重复扫描文件系统；性能提升 5-10 倍     | **P1** | 未开始 | 按 `repoID + lastCommitHash` 缓存 ProjectInfo；首个任务分析后共享给后续任务；可选：引入 sync.Map 或 Redis 缓存                                                         |
|    4 | 后端-数据 | 状态常量化与状态机校验               | 防止字符串硬编码导致状态值拼写错误、非法状态流转             | **P1** | 未开始 | 定义 RepoStatus/TaskStatus 常量；实现状态迁移校验函数（如 CanTransition）；非法流转返回明确错误                                                                        |
|    5 | 后端-数据 | 增加 DB 唯一约束与索引               | 保障数据一致性（防止同一仓库创建重复任务）；提升查询性能     | **P1** | 未开始 | `tasks` 表增加 `UNIQUE(repository_id, type)`；`repository_id` 和 `task_id` 增加索引；验证：无法插入重复任务                                                            |

---

## 二、安全性（P0-P1）

| 编号 | 模块      | 优化建议                             | 价值/风险                                                                          | 优先级 |  状态  | 验收标准                                                                                                                   |
| ---: | --------- | ------------------------------------ | ---------------------------------------------------------------------------------- | :----: | :----: | -------------------------------------------------------------------------------------------------------------------------- |
|    6 | 后端-安全 | 写接口增加基础鉴权机制               | 防止未授权用户修改配置、触发分析、删除数据                                         | **P0** | 未开始 | 支持 Bearer Token 或 Basic Auth；/api/config、POST/PUT/DELETE 接口强制鉴权；未授权返回 401；配置化鉴权开关                 |
|    7 | 后端-安全 | 修正 CORS 配置安全问题               | 当前 `AllowOrigins=*` + `AllowCredentials=true` 违反浏览器安全策略，存在 CSRF 风险 | **P0** | 未开始 | 改为配置化白名单 Origin（默认 `http://localhost:5173`）；或关闭 AllowCredentials；验证：生产环境无 CORS 错误               |
|    8 | 后端-安全 | Git clone 凭证安全传递               | 防止 Token 泄漏到进程列表、日志、错误消息中                                        | **P0** | 未开始 | 使用 `git -c credential.helper` 或 `GIT_ASKPASS` 方式；错误输出过滤敏感信息（Token/Password）；验证：`ps aux` 不显示 Token |
|    9 | 后端-安全 | 配置文件权限与密钥管理               | 降低 API Key/GitHub Token 文件泄漏风险                                             | **P0** | 未开始 | 生成 config.yaml 时设置权限 0600；推荐使用环境变量而非文件存储密钥；提供明确文档说明                                       |
|   10 | 后端-配置 | /api/config GET 接口不返回密钥原始值 | 减少配置页面信息泄露（截屏、肩窥、日志）；符合安全最佳实践                         | **P1** | 未开始 | 返回密钥时仅显示状态（`{"api_key": {"is_set": true}}`）；前端显示"已设置✓"或"未设置✗"；更新时只接受非空新值                |
|   11 | 前端-安全 | 配置页面不展示脱敏后的密钥           | 彻底防止社工、截屏泄露                                                             | **P1** | 未开始 | Input 显示 placeholder "******（已设置）"；仅当用户输入新值时才提交；空值不更新后端                                        |

---

## 三、稳定性与错误处理（P0-P2）

| 编号 | 模块      | 优化建议                         | 价值/风险                                                       | 优先级 |  状态  | 验收标准                                                                                                               |
| ---: | --------- | -------------------------------- | --------------------------------------------------------------- | :----: | :----: | ---------------------------------------------------------------------------------------------------------------------- |
|   12 | 后端-稳定 | 补全关键路径错误处理与事务       | 防止状态更新失败导致数据不一致（如任务 running 但 repo 未更新） | **P0** | 未开始 | 检查所有 `Save/Create/Update` 返回值；关键操作使用 DB 事务；失败时回滚状态并记录日志                                   |
|   13 | 后端-稳定 | 任务超时后同步修正仓库状态       | 避免 CleanupStuckTasks 后仓库仍卡在 `analyzing` 状态无法恢复    | **P1** | 未开始 | CleanupStuckTasks 后调用 `UpdateRepositoryStatus` 重算状态；验证：超时任务清理后仓库状态恢复正常                       |
|   14 | 后端-稳定 | LLM 调用增加重试与退避策略       | 提升对 429 限流、5xx 错误、网络抖动的容错性                     | **P1** | 未开始 | 实现指数退避重试（最多 3 次）；429 错误自动等待 Retry-After；超时时间配置化（默认 5min）                               |
|   15 | 后端-性能 | 静态扫描增加文件大小与行长度保护 | 防止超大文件或超长行导致 bufio.Scanner 崩溃或 OOM               | **P1** | 未开始 | 设置 `scanner.Buffer(make([]byte, 64*1024), 10*1024*1024)`；单文件超过 10MB 跳过并记录警告；统计跳过文件数             |
|   16 | 后端-API  | 统一错误响应格式与 HTTP 状态码   | 提升 API 可维护性与前端错误处理一致性                           | **P2** | 未开始 | 定义标准错误结构 `{"code": "ERR_XXX", "message": "...", "details": {...}}`；区分 4xx（客户端错误）和 5xx（服务器错误） |
|   17 | 后端-工程 | 导出 ZIP 文件增加完整性检查      | 防止部分写入失败但返回 200 导致下载损坏文件                     | **P2** | 未开始 | 检查 `zipWriter.Create/Write` 返回值；失败时返回 500 错误而非半成品 ZIP                                                |

---

## 四、性能优化（P1-P2）

| 编号 | 模块      | 优化建议                         | 价值/风险                                   | 优先级 |  状态  | 验收标准                                                                                      |
| ---: | --------- | -------------------------------- | ------------------------------------------- | :----: | :----: | --------------------------------------------------------------------------------------------- |
|   18 | 后端-性能 | LLM 超时时间配置化               | 避免硬编码 5min 无法适配不同模型/网络环境   | **P1** | 未开始 | 在 config.yaml 增加 `llm.timeout`（默认 5min）；支持运行时调整                                |
|   19 | 后端-性能 | 优化静态分析的文件遍历逻辑       | 当前对大型仓库（10w+ 文件）扫描较慢         | **P2** | 未开始 | 并行遍历子目录；限制 README 读取大小为 10KB；依赖提取仅读取前 1000 行                         |
|   20 | 前端-体验 | 优化轮询策略或改用 SSE/WebSocket | 当前 3 秒轮询对后端压力大；无变化时浪费请求 | **P1** | 未开始 | 方案 1：任务运行时 2s 轮询，完成后停止；方案 2：后端实现 SSE 推送任务状态；验证：空闲时无请求 |

---

## 五、可观测性与运维（P2-P3）

| 编号 | 模块      | 优化建议                         | 价值/风险                              | 优先级 |  状态  | 验收标准                                                                                                                           |
| ---: | --------- | -------------------------------- | -------------------------------------- | :----: | :----: | ---------------------------------------------------------------------------------------------------------------------------------- |
|   21 | 后端-日志 | 统一日志框架避免 log + klog 混用 | 提升日志可读性与可聚合性               | **P2** | 未开始 | 全部改为 klog 或 zap；结构化字段：repoID/taskID/requestID；日志级别统一（Info/Error/Debug）                                        |
|   22 | 后端-运维 | 增加 /healthz 和 /readyz 接口    | 便于 K8s/Docker 健康检查与监控系统接入 | **P2** | 未开始 | `/healthz` 返回 200 表示进程存活；`/readyz` 检查 DB 连接和磁盘可写性；失败返回 503                                                 |
|   23 | 后端-运维 | 中间件注入 request_id 到日志     | 便于分布式追踪与问题排查               | **P2** | 未开始 | 使用 Gin 中间件生成 UUID；所有日志输出包含 request_id；响应头返回 X-Request-ID                                                     |
|   24 | 后端-数据 | 生产环境禁用 AutoMigrate         | 防止意外 schema 变更导致数据丢失       | **P2** | 未开始 | 增加配置项 `database.auto_migrate`（dev=true, prod=false）；生产用 migration 工具（如 golang-migrate）                             |
|   25 | 全局-发布 | 增加版本信息 API                 | 便于线上版本识别与问题回溯             | **P3** | 未开始 | GET `/api/version` 返回 `{"version": "v1.0.0", "commit": "abc123", "build_time": "2025-01-27T10:00:00Z"}`；构建时通过 ldflags 注入 |

---

## 六、前端体验与工程化（P2-P3）

| 编号 | 模块      | 优化建议                               | 价值/风险                                                     | 优先级 |  状态  | 验收标准                                                                                       |
| ---: | --------- | -------------------------------------- | ------------------------------------------------------------- | :----: | :----: | ---------------------------------------------------------------------------------------------- |
|   26 | 前端-体验 | 统一 API 错误处理（axios interceptor） | 替代分散的 console.error/alert；提供一致的用户提示            | **P2** | 未开始 | 拦截器捕获 4xx/5xx；根据错误码展示友好消息；401 自动跳转登录页；500 显示"服务异常，请稍后重试" |
|   27 | 前端-工程 | 引入 React Query 管理服务端状态        | 简化 loading/error 状态管理；自动缓存与重新验证；减少重复请求 | **P3** | 未开始 | 重构 RepoDetail/Home 页面使用 useQuery；配置智能缓存策略；验证：列表页返回后无重复请求         |
|   28 | 前端-体验 | 仓库列表增加筛选与搜索                 | 随着仓库数量增长，提升查找效率                                | **P3** | 未开始 | 支持按状态筛选（pending/ready/analyzing/completed/error）；支持按名称搜索                      |

---

## 七、测试与质量保障（P2-P3）

| 编号 | 模块      | 优化建议             | 价值/风险                      | 优先级 |  状态  | 验收标准                                                                                         |
| ---: | --------- | -------------------- | ------------------------------ | :----: | :----: | ------------------------------------------------------------------------------------------------ |
|   29 | 全局-测试 | 核心模块增加单元测试 | 保障代码重构安全；减少回归问题 | **P2** | 未开始 | 覆盖：`git.ParseRepoName`、`analyzer.Analyze`、`TaskService.Run`、状态机迁移逻辑；最低覆盖率 60% |
|   30 | 全局-测试 | 增加 API 集成测试    | 验证接口契约与错误处理         | **P2** | 未开始 | 使用 httptest 测试所有 handler；覆盖正常流程与异常场景（404/400/500）；验证响应格式              |

---

## 优先级总结

### 必须修复（P0）：7 项
- 任务队列机制（防止资源耗尽）
- 任务幂等性与互斥（防止重复执行）
- 写接口鉴权（安全基础）
- CORS 配置修复（安全合规）
- Git 凭证安全（防泄漏）
- 配置文件权限（安全基础）
- 关键路径错误处理（数据一致性）

### 强烈建议（P1）：8 项
- 静态分析缓存（性能）
- 状态机校验（可靠性）
- DB 约束与索引（一致性）
- 配置接口安全（安全强化）
- LLM 重试机制（稳定性）
- 文件扫描保护（防崩溃）
- 前端轮询优化（体验）

### 建议实施（P2）：11 项
- 统一错误格式、日志框架、健康检查、版本 API 等

### 可选实施（P3）：4 项
- React Query、搜索筛选、测试覆盖等
