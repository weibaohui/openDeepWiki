# 依赖注入规范

本文档定义依赖注入的方式和规范。

## 核心原则

- **手动注入**
- **构造函数注入**
- **禁止魔法注入框架**

## 构造函数注入

```go
// Repository
type userRepository struct {
    db *gorm.DB
}

func NewUserRepository(db *gorm.DB) UserRepository {
    return &userRepository{db: db}
}

// Service
type userService struct {
    userRepo UserRepository
    txMgr    TxManager
}

func NewUserService(userRepo UserRepository, txMgr TxManager) UserService {
    return &userService{
        userRepo: userRepo,
        txMgr:    txMgr,
    }
}

// Handler
type UserHandler struct {
    userService UserService
}

func NewUserHandler(userService UserService) *UserHandler {
    return &UserHandler{userService: userService}
}
```

## 依赖组装（Wiring）

在 `cmd/server/main.go` 或专门的 wire 文件中组装依赖：

```go
package main

import (
    "project/internal/handler"
    "project/internal/repository"
    "project/internal/service"
)

func main() {
    // 1. 初始化基础设施
    db := initDB()

    // 2. 创建 Repository
    userRepo := repository.NewUserRepository(db)
    taskRepo := repository.NewTaskRepository(db)
    txMgr := repository.NewTxManager(db)

    // 3. 创建 Service
    userSvc := service.NewUserService(userRepo, txMgr)
    taskSvc := service.NewTaskService(taskRepo, userRepo, txMgr)

    // 4. 创建 Handler
    userHdl := handler.NewUserHandler(userSvc)
    taskHdl := handler.NewTaskHandler(taskSvc)

    // 5. 注册路由
    r := gin.Default()
    userHdl.RegisterRoutes(r.Group("/api"))
    taskHdl.RegisterRoutes(r.Group("/api"))

    // 6. 启动服务
    r.Run(":8080")
}
```

## 接口定义位置

接口定义在使用方所在包：

```go
// internal/service/user.go
package service

// UserRepository 由 Service 定义需要的接口
type UserRepository interface {
    Create(ctx context.Context, user *domain.User) error
    GetByID(ctx context.Context, id string) (*domain.User, error)
}

// internal/repository/user.go
package repository

// userRepository 实现 service.UserRepository 接口
type userRepository struct {
    db *gorm.DB
}
```

## 依赖图

```
main.go (wiring)
    ├── db (*gorm.DB)
    │
    ├── repository
    │   ├── NewUserRepository(db) → UserRepository
    │   └── NewTxManager(db) → TxManager
    │
    ├── service
    │   └── NewUserService(userRepo, txMgr) → UserService
    │
    └── handler
        └── NewUserHandler(userSvc) → *UserHandler
```

## 可选：Provider 模式

对于复杂项目，可以用 Provider 组织：

```go
package provider

type Repositories struct {
    User repository.UserRepository
    Task repository.TaskRepository
    TxMgr repository.TxManager
}

func NewRepositories(db *gorm.DB) *Repositories {
    return &Repositories{
        User:  repository.NewUserRepository(db),
        Task:  repository.NewTaskRepository(db),
        TxMgr: repository.NewTxManager(db),
    }
}

type Services struct {
    User service.UserService
    Task service.TaskService
}

func NewServices(repos *Repositories) *Services {
    return &Services{
        User: service.NewUserService(repos.User, repos.TxMgr),
        Task: service.NewTaskService(repos.Task, repos.User, repos.TxMgr),
    }
}

type Handlers struct {
    User *handler.UserHandler
    Task *handler.TaskHandler
}

func NewHandlers(svcs *Services) *Handlers {
    return &Handlers{
        User: handler.NewUserHandler(svcs.User),
        Task: handler.NewTaskHandler(svcs.Task),
    }
}
```

## 禁止事项

```go
// ❌ 使用全局变量
var globalDB *gorm.DB

func NewUserService() *UserService {
    return &UserService{db: globalDB}  // 禁止！
}

// ❌ 使用魔法注入框架
// @Inject
type UserService struct {
    repo UserRepository `inject:""`
}

// ❌ 在构造函数中创建依赖
func NewUserService(db *gorm.DB) *UserService {
    return &UserService{
        repo: NewUserRepository(db),  // 禁止！应该传入
    }
}

// ❌ 使用 init() 初始化依赖
func init() {
    userRepo = NewUserRepository(db)  // 禁止！
}
```

## 相关文档

- [项目分层](./02-项目分层.md)
- [Service 规范](./04-Service规范.md)
