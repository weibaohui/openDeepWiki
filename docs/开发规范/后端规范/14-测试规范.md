# 测试规范

本文档定义各层的测试策略和规范。

## 测试策略

| 层         | 测试类型  | Mock 对象  | 数据库                 |
| ---------- | --------- | ---------- | ---------------------- |
| Handler    | HTTP 测试 | Service    | 不需要                 |
| Service    | 单元测试  | Repository | 不需要                 |
| Repository | 集成测试  | 无         | SQLite / TestContainer |

## Service 测试

### Mock Repository

```go
package service_test

import (
    "context"
    "testing"

    "project/internal/domain"
    "project/internal/service"
)

// MockUserRepository 模拟 Repository
type MockUserRepository struct {
    users map[string]*domain.User
}

func NewMockUserRepository() *MockUserRepository {
    return &MockUserRepository{
        users: make(map[string]*domain.User),
    }
}

func (m *MockUserRepository) Create(ctx context.Context, user *domain.User) error {
    m.users[user.ID] = user
    return nil
}

func (m *MockUserRepository) GetByID(ctx context.Context, id string) (*domain.User, error) {
    if user, ok := m.users[id]; ok {
        return user, nil
    }
    return nil, domain.ErrRecordNotFound
}
```

### Service 测试用例

```go
func TestUserService_Create(t *testing.T) {
    // 准备
    mockRepo := NewMockUserRepository()
    svc := service.NewUserService(mockRepo)

    // 执行
    req := service.CreateUserRequest{
        Email: "test@example.com",
        Name:  "Test User",
    }
    result, err := svc.Create(context.Background(), req)

    // 断言
    if err != nil {
        t.Fatalf("expected no error, got %v", err)
    }
    if result.Email != req.Email {
        t.Errorf("expected email %s, got %s", req.Email, result.Email)
    }
}

func TestUserService_Create_DuplicateEmail(t *testing.T) {
    // 准备
    mockRepo := NewMockUserRepository()
    mockRepo.Create(context.Background(), &domain.User{
        ID:    "existing",
        Email: "test@example.com",
    })
    svc := service.NewUserService(mockRepo)

    // 执行
    req := service.CreateUserRequest{
        Email: "test@example.com",
        Name:  "Test User",
    }
    _, err := svc.Create(context.Background(), req)

    // 断言
    if !errors.Is(err, service.ErrUserAlreadyExists) {
        t.Errorf("expected ErrUserAlreadyExists, got %v", err)
    }
}
```

## Repository 测试

### 使用 SQLite 内存数据库

```go
package repository_test

import (
    "context"
    "testing"

    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "project/internal/model"
    "project/internal/repository"
)

func setupTestDB(t *testing.T) *gorm.DB {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    if err != nil {
        t.Fatalf("failed to connect database: %v", err)
    }

    // 迁移
    db.AutoMigrate(&model.UserModel{})

    return db
}

func TestUserRepository_Create(t *testing.T) {
    db := setupTestDB(t)
    repo := repository.NewUserRepository(db)

    user := &domain.User{
        ID:    "test-id",
        Email: "test@example.com",
        Name:  "Test User",
    }

    err := repo.Create(context.Background(), user)
    if err != nil {
        t.Fatalf("expected no error, got %v", err)
    }

    // 验证数据已存储
    found, err := repo.GetByID(context.Background(), "test-id")
    if err != nil {
        t.Fatalf("expected no error, got %v", err)
    }
    if found.Email != user.Email {
        t.Errorf("expected email %s, got %s", user.Email, found.Email)
    }
}

func TestUserRepository_GetByID_NotFound(t *testing.T) {
    db := setupTestDB(t)
    repo := repository.NewUserRepository(db)

    _, err := repo.GetByID(context.Background(), "non-existent")
    if !errors.Is(err, domain.ErrRecordNotFound) {
        t.Errorf("expected ErrNotFound, got %v", err)
    }
}
```

## Handler 测试

### HTTP 测试

```go
package handler_test

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
    "project/internal/handler"
)

func TestUserHandler_Create(t *testing.T) {
    // 准备
    gin.SetMode(gin.TestMode)
    mockSvc := NewMockUserService()
    hdl := handler.NewUserHandler(mockSvc)

    router := gin.New()
    hdl.RegisterRoutes(router.Group("/api"))

    // 构造请求
    body := map[string]string{
        "email": "test@example.com",
        "name":  "Test User",
    }
    jsonBody, _ := json.Marshal(body)
    req := httptest.NewRequest("POST", "/api/users", bytes.NewBuffer(jsonBody))
    req.Header.Set("Content-Type", "application/json")

    // 执行
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)

    // 断言
    if w.Code != http.StatusCreated {
        t.Errorf("expected status %d, got %d", http.StatusCreated, w.Code)
    }

    var resp response.Response
    json.Unmarshal(w.Body.Bytes(), &resp)
    if resp.Code != "OK" {
        t.Errorf("expected code OK, got %s", resp.Code)
    }
}

func TestUserHandler_Create_BadRequest(t *testing.T) {
    gin.SetMode(gin.TestMode)
    mockSvc := NewMockUserService()
    hdl := handler.NewUserHandler(mockSvc)

    router := gin.New()
    hdl.RegisterRoutes(router.Group("/api"))

    // 缺少必填字段
    body := map[string]string{
        "email": "invalid-email",  // 无效邮箱
    }
    jsonBody, _ := json.Marshal(body)
    req := httptest.NewRequest("POST", "/api/users", bytes.NewBuffer(jsonBody))
    req.Header.Set("Content-Type", "application/json")

    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)

    if w.Code != http.StatusBadRequest {
        t.Errorf("expected status %d, got %d", http.StatusBadRequest, w.Code)
    }
}
```

## 测试命名规范

```go
// 函数名格式：Test{Type}_{Method}_{Scenario}
func TestUserService_Create(t *testing.T) {}
func TestUserService_Create_DuplicateEmail(t *testing.T) {}
func TestUserService_GetByID_NotFound(t *testing.T) {}
```

## 测试文件组织

```
internal/
  service/
    user.go
    user_test.go        # Service 测试
  repository/
    user.go
    user_test.go        # Repository 测试
  handler/
    user.go
    user_test.go        # Handler 测试
```

## 相关文档

- [Service 规范](./04-Service规范.md)
- [Repository 规范](./07-Repository规范.md)
- [Handler 规范](./03-Handler规范.md)
