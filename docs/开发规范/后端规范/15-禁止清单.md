# 禁止清单

本文档列出 AI 在生成代码时必须遵守的禁止事项。

## 严格禁止

### 1. 在 Handler / Service 中使用 GORM

```go
// ❌ 禁止
func (h *UserHandler) Create(c *gin.Context) {
    h.db.Create(&user)  // 禁止！
}

func (s *userService) Create(ctx context.Context, req Request) error {
    s.db.Create(&model)  // 禁止！
}

// ✅ 正确
func (s *userService) Create(ctx context.Context, req Request) error {
    return s.userRepo.Create(ctx, user)  // 通过 Repository
}
```

### 2. 运行时自动迁移数据库

```go
// ❌ 禁止
func (r *userRepository) Create(ctx context.Context, user *domain.User) error {
    r.db.AutoMigrate(&model.UserModel{})  // 禁止！
    return r.db.Create(toModel(user)).Error
}

// ✅ 正确：仅在初始化脚本中迁移
func Migrate(db *gorm.DB) error {
    return db.AutoMigrate(&model.UserModel{})
}
```

### 3. 跨层调用

```go
// ❌ 禁止：Handler 直接调用 Repository
func (h *UserHandler) Create(c *gin.Context) {
    h.userRepo.Create(ctx, user)  // 禁止！
}

// ❌ 禁止：Repository 依赖 Service
type userRepository struct {
    svc UserService  // 禁止！
}

// ✅ 正确的依赖方向
Handler → Service → Repository
```

### 4. 隐式全局状态

```go
// ❌ 禁止
var globalDB *gorm.DB
var globalConfig *Config

func GetUser(id string) *User {
    return globalDB.First(&User{}, id)  // 禁止！
}

// ✅ 正确：显式依赖注入
type userRepository struct {
    db *gorm.DB
}

func NewUserRepository(db *gorm.DB) UserRepository {
    return &userRepository{db: db}
}
```

### 5. 未分类的错误

```go
// ❌ 禁止
func (s *userService) Create(ctx context.Context, req Request) error {
    return fmt.Errorf("failed to create user")  // 禁止！无法分类
}

// ❌ 禁止
func (s *userService) Create(ctx context.Context, req Request) error {
    return errors.New("error")  // 禁止！无意义
}

// ✅ 正确
var ErrUserAlreadyExists = errors.New("user already exists")

func (s *userService) Create(ctx context.Context, req Request) error {
    return ErrUserAlreadyExists  // 可分类的错误
}
```

### 6. 吞掉错误

```go
// ❌ 禁止
func (s *userService) Create(ctx context.Context, req Request) (*UserDTO, error) {
    user, _ := s.userRepo.Create(ctx, user)  // 禁止！忽略错误
    return toUserDTO(user), nil
}

// ✅ 正确
func (s *userService) Create(ctx context.Context, req Request) (*UserDTO, error) {
    if err := s.userRepo.Create(ctx, user); err != nil {
        return nil, fmt.Errorf("failed to create user: %w", err)
    }
    return toUserDTO(user), nil
}
```

### 7. Repository 中控制事务

```go
// ❌ 禁止
func (r *userRepository) Create(ctx context.Context, user *domain.User) error {
    tx := r.db.Begin()  // 禁止！
    defer tx.Rollback()
    // ...
    return tx.Commit().Error
}

// ✅ 正确：事务在 Service 层控制
func (s *userService) Create(ctx context.Context, req Request) error {
    return s.txMgr.WithTx(ctx, func(tx *gorm.DB) error {
        return s.userRepo.CreateWithTx(tx, user)
    })
}
```

### 8. 混用数据结构

```go
// ❌ 禁止
type User struct {
    ID    string `json:"id" gorm:"primaryKey" binding:"required"`
}

// ✅ 正确：分开定义
// Request
type CreateUserRequest struct {
    Email string `json:"email" binding:"required"`
}

// Domain
type User struct {
    ID    string
    Email string
}

// Model
type UserModel struct {
    ID    string `gorm:"primaryKey"`
    Email string `gorm:"uniqueIndex"`
}
```

### 9. Service 依赖 Gin

```go
// ❌ 禁止
func (s *userService) Create(c *gin.Context, req Request) error {
    // 禁止传入 gin.Context
}

// ✅ 正确
func (s *userService) Create(ctx context.Context, req Request) error {
    // 使用标准 context.Context
}
```

### 10. Handler 写业务逻辑

```go
// ❌ 禁止
func (h *UserHandler) Create(c *gin.Context) {
    if user.Age < 18 {
        response.BadRequest(c, errors.New("must be 18+"))  // 业务逻辑应在 Service
        return
    }
}

// ✅ 正确：业务逻辑在 Service
func (s *userService) Create(ctx context.Context, req Request) error {
    if req.Age < 18 {
        return ErrUnderAge
    }
}
```

### 11. 不使用 WithContext

```go
// ❌ 禁止
func (r *userRepository) GetByID(ctx context.Context, id string) (*domain.User, error) {
    r.db.Where("id = ?", id).First(&m)  // 禁止！缺少 WithContext
}

// ✅ 正确
func (r *userRepository) GetByID(ctx context.Context, id string) (*domain.User, error) {
    r.db.WithContext(ctx).Where("id = ?", id).First(&m)
}
```

### 12. 返回 Model 给上层

```go
// ❌ 禁止
func (s *userService) GetByID(ctx context.Context, id string) (*model.UserModel, error) {
    // 禁止返回 Model
}

// ✅ 正确
func (s *userService) GetByID(ctx context.Context, id string) (*UserDTO, error) {
    // 返回 DTO
}
```

## 检查清单

在生成代码前，确保：

- [ ] GORM 只在 Repository 中使用
- [ ] 没有运行时 AutoMigrate
- [ ] 依赖方向正确（Handler → Service → Repository）
- [ ] 没有全局变量
- [ ] 错误都有明确类型
- [ ] 错误都被处理
- [ ] 事务在 Service 层控制
- [ ] Request / DTO / Model 分开定义
- [ ] Service 不依赖 Gin
- [ ] Handler 只做 5 件事
- [ ] 所有 GORM 操作使用 WithContext
- [ ] Service 返回 DTO，不返回 Model

## 相关文档

- [总体原则](./01-总体原则.md)
- [项目分层](./02-项目分层.md)
